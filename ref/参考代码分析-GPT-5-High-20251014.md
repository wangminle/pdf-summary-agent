# PDF 提取工具对比分析（scripts/extract_pdf_assets.py vs ref/pdf_image_extractor.py）

本文整理自本地代码审阅，聚焦于以下维度的系统性对比：功能目标、业务流程、实现机制、依赖库、效率与准确率、适用范围与工程化能力，并给出可借鉴改造清单与合并策略建议。

**结论摘要**
- scripts/extract_pdf_assets.py 是面向“学术论文图表抽取与摘要生成”的主力生产工具：围绕图/表“图注（caption）”定位，具备智能图注识别、全局锚点一致性、多阶段稳健裁剪（A+B+D）、表格特化评分与保护、index.json/manifest/text 输出，完美契合“提取正文与‘附图与表格’并生成摘要”的流水线需求。
- ref/pdf_image_extractor.py 是“通用图片抓取器”：擅长从 PDF 中快速提取内嵌位图，支持整页渲染兜底与多线程批量处理、输出格式/质量控制。它对论文中的“位图型图片”很高效，但不理解 Figure/Table 的编号与图注，不做基于图注的区域定位与精裁，难以直接满足“按编号嵌图+解释”的目标。
- 方向建议：保留 scripts/extract_pdf_assets.py 为主流程；从 ref 工具吸收工程化能力（批量/并行、输出格式与质量、加密 PDF 处理、兜底整页渲染、日志开关），作为增强或兜底路径。

**核心对比（表格）**

| 维度 | scripts/extract_pdf_assets.py | ref/pdf_image_extractor.py |
| --- | --- | --- |
| 目标定位 | 论文“图/表”基于图注的精准抽取，用于后续 Markdown 摘要嵌图与解释 | 通用图片抓取：提取内嵌位图；可整页渲染兜底；可尝试导出矢量为位图 |
| 输出产物 | images/*.png、images/index.json、可选 CSV manifest、text/<paper>.txt | 输出到指定目录（按源目录结构）；文件名 `<pdf>_p{页}_i{序}`/`_rendered`/`_vector_{i}` |
| 图/表识别 | 基于 caption（Figure/Table/图/表）检测，智能区分“真实图注 vs 正文引用” | 不识别编号与图注，仅抓取图片字节或整页渲染 |
| 定位与锚点 | Anchor v2 多尺度滑窗+结构打分；支持全局锚点一致性（统一 above/below）与中线护栏 | 无定位，仅按页对象或整页输出 |
| 稳健裁剪 | A（近侧文本头部裁剪）+ B（对象连通域并集/近侧对齐）+ D（文本掩膜辅助去白边）；过裁保护与回退 | 可对提取后图片做尺寸与格式处理；无区域级裁剪策略 |
| 表格特化 | 独立锚点与评分（列对齐峰+线段密度）、参数阈值与验收保护；默认开启表格提取 | 无表格专用逻辑 |
| 续页/多子图 | 支持 `--allow-continued` 命名规范；多子图保护避免子图被缩并 | 不区分编号与续页 |
| 命名与规范 | 基于图注清洗命名，限制词数/字符集/长度，保留 `Figure_N_`/`Table_N_` 前缀 | 仅基于页码与顺序命名，不含编号与语义 |
| 索引/清单 | 写出 `images/index.json` 与可选 CSV，含 type/id/page/caption/file/continued | 无 index/manifest |
| 文本抽取 | 集成 pdfminer.six，可写出 text/<paper>.txt | 不抽取正文文本 |
| 预设与参数 | `--preset robust` 一键稳健；`--anchor-mode v1|v2`、`--global-anchor{,-table}`、`--autocrop*`、`--table-*` 丰富可调 | `--format/-dpi/-quality/-min-size/-max-size`、`--render-pages`、`--extract-vectors`、`--threads` |
| 效率 | 渲染裁剪窗口（非整页），在精准抽取下更省算；复杂评分带来小幅开销 | 内嵌位图提取极快；整页渲染开销大但简单可控；并行加速批量 |
| 准确率 | 论文场景准确率高：智能图注+全局锚点+裁剪/验收保护 | 仅对“位图型图片”准确；对“矢量图/表格/混排”抽取不到或整页噪声高 |
| 适用范围 | 学术论文（TeX/期刊模板）含规范图注编号的 PDF | 大批量通用 PDF 资源抓取、数据集采集、兜底导出 |
| 依赖 | PyMuPDF（核心），pdfminer.six（可选） | PyMuPDF + Pillow |
| 并行/批量 | 单 PDF 主流程；可扩展批量入口 | 递归目录处理 + 线程池并行（工程化较强） |
| 加密 PDF | 未内置密码处理（可扩展） | 支持加密 PDF：空密码尝试与供参认证 |
| 兜底策略 | 锚点与验收回退到更保守窗口；可选 dump 调试 | `--render-pages` 整页渲染兜底（生成巨图） |
| 矢量处理 | 通过绘图对象用于表格评分/对象并集；输出仍为位图 PNG | “矢量导出”为整页位图（不裁剪矢量区域），精度不足 |
| 输出格式 | PNG（主）、像素级去白边/掩膜；未来可扩展 | 支持 png/jpg/webp 与 quality；下采样与 DPI 设置 |
| 调试/日志 | `--debug-captions`、`--dump-candidates`、QC 统计、robust 预设 | logging + `--verbose`，信息量适中 |

**实现亮点（scripts）**
- 智能图注识别：“位置/格式/结构/语义”四维评分，显著降低“正文引用误判为图注”的风险。
- 全局锚点一致性：预扫全篇后统一上/下方向，避免同篇内方向不一致引发裁剪偏差。
- 稳健裁剪 A+B+D：
  - A：近侧文本头部裁剪（相对 caption 一侧，过滤正文段落）
  - B：对象连通域并集/近侧对齐（保住多子图的整体性）
  - D：文本掩膜辅助去白边（像素级 ink 检测，保护远端边与近端回扩）
- 表格特化：列对齐峰+线段密度+对象覆盖率等指标，配合保守验收回退，减少“半幅/过裁”。
- 产物适配流水线：images/index.json + text.txt + 规范化命名，直接服务“带图摘要”生成。

**实现亮点（ref）**
- 工程化能力强：
  - 递归遍历目录、线程池并发、输出目录结构保留。
  - 输出格式（png/jpg/webp）、质量与尺寸上限（max_size）控制，便于体积/速度权衡。
  - 加密 PDF 支持（空密码尝试与 `--password`）。
  - 整页渲染兜底，有助于应对“tiled images/无法直接 extract_image”的特殊排版。

**不足与问题（ref）**
- 文本图片过滤逻辑失效：`page.get_images(full=True)` 返回的元组无 bbox，`_is_text_image` 以 `img_info[1:5]` 当 bbox 使用，导致 clip 取值错误，被异常吞掉后基本恒 False，过滤无效。
- “矢量导出”粗糙：当前为“整页渲染+按 drawings 计数命名”，并未裁剪到矢量对象的真实区域，重复与臃肿且无定位意义。
- 整页渲染易产出巨图：在 300DPI 时整页像素巨大，IO 与磁盘占用高，仅适合失败兜底，需配合降 DPI 与显式开关。
- 无编号/图注语义：无法与摘要工作流对齐（不产出 index.json/manifest/text，不支持按编号嵌图）。

**可借鉴与改造清单（to‑do list）**
- 批量与并行
  - 新增目录递归与 `--threads` 并发入口；默认仍保留单 PDF 主命令。
- 输出格式与体积控制
  - 增加 `--format {png|jpg|webp}`、`--quality`、`--max-size` 下采样；默认 PNG 保真，用户可选高压缩 webp。
- 加密 PDF 支持
  - 增加 `--password` 参数；当 `fitz.open` 报加密时尝试空密码与用户密码。
- 兜底快照
  - 图/表抽取验收失败时（多次失败/保护触发）可选保存“整页渲染快照”到 `..._fallback_p{page}.png`，仅用于人工回查，不纳入 index.json。
- 日志与调试体验
  - 融合 logging 等级开关，与现有 `--debug-captions`/`--dump-candidates` 对齐；为批量模式添加进度与失败摘要。
- 大批量目录结构
  - 可选沿用输入目录结构组织 `images/` 与 `text/`，方便归档与溯源。

**融合建议（如何把 ref 的长处用到现有主流程）**
- 在 scripts 旁新增一个批量入口（不改变主脚本 CLI）：
  - 示例：`python scripts/batch_extract.py --root <dir> --threads 4 --format webp --quality 90 --password <pwd>`，内部调用现有 `extract_pdf_assets.py --preset robust`。
- 在脚本内部追加可选参数：
  - `--format/--quality/--max-size/--password/--threads`（仅当执行批量或导出时启用）。
- 在失败兜底路径引入“整页渲染快照”开关：
  - 仅在某编号裁剪候选与验收均失败时保存，命名含 `_fallback_` 标记，避免与正式产物混淆。

**适用场景建议**
- 论文摘要生产：优先使用 scripts/extract_pdf_assets.py 的 robust 预设与表格特化，并开启智能 caption 与全局锚点一致性。
- 大批量资产收集或异构 PDF：先用 scripts 抽取图/表；对未命中或失败项，再用 ref 做“整页/内嵌位图兜底”，供人工回查与二次加工。

**下一步实施建议**
- 优先实现以下三点以提升产线体验：
  1) 批量/并行入口 + 进度/失败摘要；
  2) 输出格式与体积控制（webp/quality/max-size）；
  3) 加密 PDF 支持（空密码+用户密码）。
- 可选增强：失败兜底整页快照开关、logging 细粒度等级、批量结构化落盘策略。

以上分析结论：保持当前主流程不变，将 ref 的工程化长处模块化吸收，既不破坏“图注驱动的高准确抽取”，又能在大规模/复杂环境中更稳健与高效。
