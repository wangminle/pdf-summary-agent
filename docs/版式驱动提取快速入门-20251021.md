# 版式驱动提取（V2）快速入门

**日期**: 2025-10-21  
**功能**: Layout-Driven Extraction (V2 Architecture)

---

## 🎯 什么是版式驱动提取？

版式驱动提取（V2）是一种**更智能的PDF图表提取方法**，它会：

1. **先分析整个文档的版式结构**
   - 识别文本类型（标题、段落、图注、表注、列表、公式）
   - 检测单栏/双栏布局
   - 定位文本密集区域和留白区域

2. **再用版式信息指导图表提取**
   - 更精确的图表边界定位
   - 更好的文本去除效果
   - 更准确的图注识别

---

## 🚀 快速开始

### 基础用法

```bash
# 启用版式驱动提取
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven
```

### 查看文本区块可视化

```bash
# 同时启用debug可视化，在PNG图上看到粉红色文本区块
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

### 完整示例

```bash
# 最完整的命令（包含所有调试信息）
python3 scripts/extract_pdf_assets.py \
  --pdf tests/basic-benchmark/1706.03762v7-attention_is_all_you_need/1706.03762v7-attention_is_all_you_need.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual \
  --debug-captions
```

---

## 📂 输出文件

### 新增文件

启用`--layout-driven`后，会额外生成：

```
<pdf_dir>/images/
└── layout_model.json        # 版式模型JSON文件
```

**内容示例**:
```json
{
  "page_size": [612.0, 792.0],
  "num_columns": 2,              // 双栏文档
  "typical_metrics": {
    "font_size": 10.0,           // 正文字号
    "line_height": 10.0,         // 行高
    "line_gap": 0.9              // 行距
  },
  "text_units_count": {          // 每页的文本单元数
    "0": 56, "1": 53, ...
  },
  "text_blocks_count": {         // 每页的文本区块数
    "0": 6, "1": 3, ...
  }
}
```

### Debug可视化增强

如果同时启用`--debug-visual`，在`images/debug/`目录下的PNG图片中：

- **粉红色虚线框**: 标识文本区块（V2新增）
- **蓝色框**: 基线窗口
- **红色框**: 最终裁剪结果
- **紫色框**: 图注位置

**Legend文件示例** (`Figure_1_p3_legend.txt`):
```
======================================================================
TEXT BLOCKS (Layout Model - V2 Architecture)
======================================================================
Total text blocks on this page: 5
Color: RGB(255, 105, 180) - Hot Pink (dashed line)

Text Block 1 (paragraph_group):
  Position: 107.7,436.8 -> 505.2,493.0
  Size: 397.6×56.2pt (4.31 sq.in)
  Column: 0 (-1=single, 0=left, 1=right)
  Text units: 4
  Sample: The Transformer follows this overall...
```

---

## ⚙️ 命令行参数

### V2 专用参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--layout-driven` | 启用版式驱动提取（V2） | 禁用 |
| `--layout-json <path>` | 指定layout_model.json保存路径 | `<out_dir>/layout_model.json` |

### 与现有参数组合

```bash
# V2 + 稳健预设
--preset robust --layout-driven

# V2 + debug可视化
--layout-driven --debug-visual

# V2 + caption调试
--layout-driven --debug-captions

# V2 + 自定义输出路径
--layout-driven --layout-json custom_layout.json
```

---

## 🔍 实际效果

### 示例：Attention论文

**命令**:
```bash
python3 scripts/extract_pdf_assets.py \
  --pdf tests/basic-benchmark/1706.03762v7-attention_is_all_you_need/1706.03762v7-attention_is_all_you_need.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

**输出**:
```
======================================================================
LAYOUT-DRIVEN EXTRACTION (V2 Architecture)
======================================================================

[SUMMARY] Layout Model Built Successfully
  - Pages analyzed: 15
  - Total text units: 1048
  - Total text blocks: 96
  - Columns: 2 (double)          👈 自动检测到双栏
  - Column gap: -456.4pt
  - Typical font: 10.0pt
  - Line height: 10.0pt

[INFO] Layout model saved to:
  tests/.../images/layout_model.json

[Page 1] Classifying 56 text units...
  TITLE_H1: Attention Is All You Need...     👈 识别标题
  TITLE_H2: Abstract...                      👈 识别二级标题
  Caption: Figure 1: The Transformer...      👈 识别图注

Detected TWO columns:                         👈 双栏检测
  Left column x0 ≈ 107.4pt
  Right column x0 ≈ 131.5pt

[Page 1] Created 6 text blocks                👈 文本区块聚合
```

**生成的文件**:
- ✅ 5个Figure PNG（Figure_1_xxx.png ~ Figure_5_xxx.png）
- ✅ 4个Table PNG（Table_1_xxx.png ~ Table_4_xxx.png）
- ✅ layout_model.json（版式模型）
- ✅ 5个debug PNG + legend.txt（如果启用--debug-visual）

---

## 💡 使用建议

### 何时使用V2？

**推荐使用V2的场景**:
- ✅ 双栏论文（期刊论文、会议论文）
- ✅ 复杂排版（多级标题、列表、公式混排）
- ✅ 图表密集（需要精确区分文本区域和图表区域）
- ✅ 需要调试可视化（查看文本区块分布）

**暂时使用V1的场景**:
- 📄 简单单栏文档
- 🚀 追求最快速度（V2会增加约10-20%处理时间）
- 🔧 不需要版式分析

### 性能考虑

| 模式 | 处理时间 | 内存占用 | 精确度 |
|------|---------|---------|--------|
| V1 (默认) | 基线 | 基线 | 高 |
| V2 (--layout-driven) | +10~20% | +15~30% | 更高 |

**建议**:
1. 先用V1快速测试
2. 如果效果不理想，启用V2
3. 如果需要调试，加上`--debug-visual`

---

## 🐛 故障排除

### 问题1: 提示"NumPy not available"

**现象**:
```
[DEBUG] Column Detection
NumPy not available, assuming single column
```

**原因**: 未安装numpy，跳过双栏检测

**解决**:
```bash
# 安装numpy（可选）
python3 -m pip install --user numpy
```

**影响**: 仍可正常工作，但无法检测双栏，会假设单栏

---

### 问题2: 提示"NumPy/SciPy not available, skipping vacant region detection"

**现象**:
```
[DEBUG] Detecting Vacant Regions
[Page 1] NumPy/SciPy not available, skipping vacant region detection
```

**原因**: 未安装scipy，跳过留白区域检测

**解决**:
```bash
# 安装scipy（可选）
python3 -m pip install --user scipy
```

**影响**: 仍可正常工作，但`vacant_regions`为空

---

### 问题3: 双栏检测不准确

**现象**: 单栏文档被检测为双栏，或反之

**原因**: 页面排版特殊（如首页单栏、后续双栏）

**调试**:
```bash
# 启用debug模式查看详情
--debug-captions
```

**临时方案**: 暂时使用V1（不加`--layout-driven`）

---

## 📚 相关文档

- **完整技术文档**: `docs/technical-review/版式驱动提取功能实施总结-20251021.md`
- **方案论证**: `docs/technical-review/版式驱动提取方案论证-20251021.md`
- **AGENTS工作流**: `AGENTS.md`

---

## 🎓 进阶用法

### 单独使用版式提取

如果只需要分析文档版式，不提取图表：

```python
# Python脚本调用
from scripts.extract_pdf_assets import extract_text_with_format

layout_model = extract_text_with_format(
    pdf_path='your_paper.pdf',
    out_json='layout_model.json',
    sample_pages=None,  # 分析全部页面
    debug=True          # 打印详细信息
)

# 访问版式信息
print(f"Columns: {layout_model.num_columns}")
print(f"Typical font size: {layout_model.typical_font_size}pt")
print(f"Text blocks on page 0: {len(layout_model.text_blocks[0])}")
```

### 自定义文本类型分类

当前文本类型分类基于规则，如需自定义：

```python
# 编辑 scripts/extract_pdf_assets.py

def _classify_text_types(...):
    # 修改分类规则
    if unit.font_weight == 'bold':
        ratio = unit.font_size / typical_font_size
        if ratio > 1.5:  # 自定义阈值
            unit.text_type = 'title_h1'
    ...
```

---

## ✅ 总结

版式驱动提取（V2）是现有图表提取系统的强大增强：

1. **先建模，再提取** - 更智能的处理流程
2. **可视化文本区块** - 更直观的调试体验
3. **向后兼容** - 不影响现有功能
4. **用户可选** - 通过`--layout-driven`启用

**立即尝试**:
```bash
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

---

**快速入门完成** ✅  
如有问题，请参考完整技术文档或提issue。

