# 重构：最小改动迁移路线图（基于当前仓库实际代码）

目标：把当前“单文件巨石” `scripts/extract_pdf_assets.py` 逐步拆分为可维护的模块结构，同时**保持 CLI/输出格式/回归测试稳定**，做到每一步都能跑通并通过回归。

> 重要约束（当作“对外合同”锁死）
> - CLI 参数与默认值保持不变（尤其：`--layout-driven` 三态、`--global-anchor*`、`--no-xxx` 开关语义）。
> - 输出目录与文件：`text/<paper>.txt`、`text/gathered_text.json`、`images/*.png`、`images/index.json`、`images/figure_contexts.json`、`images/layout_model.json`、`images/run.log.jsonl`。
> - 运行输出中包含“有效参数行”（测试依赖）：`anchor_mode=... , global_anchor=... , global_anchor_table=...`。
> - `write_index_json()` 的字段合同：至少包含 `file / original_file / current_file`（QA-05 依赖）。

---

## 0. 当前代码“核心边界图”（便于理解后续拆分）

`scripts/extract_pdf_assets.py` 中主要模块化边界（按函数/类名）：

- **日志**：`lib/extraction_logger.py`（已独立）
- **通用小工具**：`sanitize_filename_from_caption()`、`get_unique_path()`、`detect_content_bbox_pixels()`、`estimate_ink_ratio()` 等
- **预验证 + QC**：`pre_validate_pdf()`、`quality_check()`、`count_text_references()` 等
- **Caption 识别**：`CaptionCandidate/CaptionIndex`、`find_all_caption_candidates()`、`score_caption_candidate()`、`select_best_caption()`、`build_caption_index()`
- **精裁/裁剪**：`_trim_clip_head_by_text*()`、`_refine_clip_by_objects()`、`_build_text_masks_px()`、`_trim_far_side_text_post_autocrop()`、`AcceptanceThresholds/_adaptive_acceptance_thresholds()` 等
- **提取主循环**：
  - 图：`extract_figures()`
  - 表：`extract_tables()`
- **输出**：`write_manifest()`、`write_index_json()`、`prune_unindexed_images()`
- **调试可视化**：`DebugStageInfo`、`save_debug_visualization()`、`dump_page_candidates()`
- **版式驱动（Layout Model）**：`DocumentLayoutModel` 及 `_detect_columns/_build_text_blocks/_adjust_clip_with_layout` 等
- **Gathering**：`gather_structured_text()`、`GatheredText/GatheredParagraph`
- **Figure Context**：`build_figure_contexts()`、`FigureContext/FigureMention`
- **入口**：`parse_args()`、`main()`（含 preset、ENV 优先级、整体编排）

---

## 1. 回归基线（建议固定为统一命令）

为了“每一步都能跑通”，建议把回归拆成两层：

- **快速回归（每个提交都跑）**
  - `python3 scripts/tests/run_all.py --skip-golden`
- **重回归（每个里程碑/每日最后一次提交跑）**
  - `python3 scripts/tests/run_all.py`

> 说明：当前仓库测试脚本（P0/QA-04/QA-05）期望存在 `scripts/core/*` 路径；这会作为第一个提交优先修复（兼容层），否则后续每一步都无法“通过回归”。

---

## 2. 迁移目标目录（最终形态，先定边界再渐进迁移）

建议最终拆分到以下结构（**先增量建文件，不强制一次性搬完**）：

```
scripts/
  core/
    extract_pdf_assets.py          # CLI 入口（稳定路径：测试依赖）
    sync_index_after_rename.py     # CLI 入口（稳定路径：测试依赖）
  lib/
    extraction_logger.py           # 已有
    models.py                      # dataclass 集中
    env_priority.py                # CLI>ENV>DEFAULT 逻辑
    idents.py                      # Figure/Table ident 解析 + 正则
    qc.py                          # pre_validate_pdf + quality_check + count_text_references
    text_extract.py                # try_extract_text/extract_text_with_format/gather_structured_text
    caption_detection.py           # find_all_caption_candidates/score/select/build_caption_index
    refine.py                      # A/B/C/D 精裁 + 验收阈值
    layout_model.py                # DocumentLayoutModel + layout-driven
    debug_visual.py                # DebugStageInfo/save_debug_visualization/dump_page_candidates
    output.py                      # write_manifest/write_index_json/prune_unindexed_images
    extract_figures.py             # extract_figures（仅图）
    extract_tables.py              # extract_tables（仅表）
    figure_contexts.py             # build_figure_contexts
```

同时保留兼容入口：
- `scripts/extract_pdf_assets.py`：作为**兼容导入模块**（供 `from extract_pdf_assets import ...`）与旧 CLI 路径。
- `scripts/sync_index_after_rename.py`：同理（兼容旧 CLI 路径）。

---

## 3. 最小改动提交序列（按提交粒度）

下面按“每次只做一件事”的原则拆成可提交步骤。每一步都附带：变更文件、迁移符号、回归命令。

### Commit 00：补齐 `scripts/core/` 兼容入口（让回归先绿）

- 目标：让以下测试不再因为路径不存在而失败：
  - `scripts/tests/test_p0_env_priority.py`
  - `scripts/tests/test_qa04_structured_log.py`
  - `scripts/tests/test_qa05_rename_workflow.py`
- 变更：
  - 新增 `scripts/core/extract_pdf_assets.py`：调用现有 `scripts/extract_pdf_assets.py:main()`
  - 新增 `scripts/core/sync_index_after_rename.py`：调用现有 `scripts/sync_index_after_rename.py:main()`
  - （可选）新增 `scripts/core/README.md`：说明这是“稳定入口层”
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 01：把“ENV 优先级 + 有效参数打印”抽成独立模块（先稳住 P0）

- 目标：把 `main()` 中 P0-01 的逻辑抽离，降低入口复杂度，同时确保打印行稳定：
  - `anchor_mode=... , global_anchor=... , global_anchor_table=...`
- 新增文件：
  - `scripts/lib/env_priority.py`
- 迁移符号（从 `scripts/extract_pdf_assets.py` 搬走）：
  - `_cli_has_arg()`（或等价 helper）
  - `_set_env_with_priority()`（以及它依赖的“是否显式传参判断”）
  - “有效参数打印”函数：例如 `print_effective_params()`（内部仍保持原打印格式）
- 主文件修改：
  - `scripts/extract_pdf_assets.py:main()` 改为调用 `env_priority.apply_env_overrides(args, argv_for_cli_check)` + `env_priority.print_effective_params()`
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### （可选）Commit 01B：引入 PDF 后端适配层（薄适配）

- 适用场景：
  - 需要为后续“AGPL 替代渲染/图像引擎”预留扩展点；或
  - 想引入 `pdfplumber` 做“单元格级表格结构分析/调试”（不进入主提取路径）。
- 约束：
  - **不改变任何现有输出合同与主流程行为**（默认仍使用 PyMuPDF）。
  - `pdfplumber` 必须是可选依赖（缺失时不影响主流程）。
- 详见：`docs/重构-最小改动迁移路线图-V2-PDF后端抽象.md`

### Commit 02：集中数据结构（dataclass）到 `models.py`（低风险纯搬运）

- 目标：把 dataclass 集中，降低后续模块循环依赖风险。
- 新增文件：
  - `scripts/lib/models.py`
- 迁移符号（建议一次搬完，不要拆太碎）：
  - `PDFValidationResult`
  - `QualityIssue`
  - `AttachmentRecord`
  - `DrawItem`
  - `CaptionCandidate`
  - `CaptionIndex`
  - `EnhancedTextUnit`
  - `TextBlock`
  - `DocumentLayoutModel`
  - `AcceptanceThresholds`
  - `DebugStageInfo`
  - `GatheredParagraph`
  - `GatheredText`
  - `FigureMention`
  - `FigureContext`
- 兼容策略：
  - 在 `scripts/extract_pdf_assets.py` 里 **保留同名 re-export**（`from lib.models import AttachmentRecord, ...`），避免外部 `from extract_pdf_assets import AttachmentRecord` 断掉（QA-05 依赖）。
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 03：抽离 ident/正则/解析（让 P1 测试更稳定）

- 新增文件：
  - `scripts/lib/idents.py`
- 迁移符号：
  - `_extract_figure_ident()`、`_extract_table_ident()`
  - `_roman_to_int()`、`_is_roman_numeral()`、`_parse_figure_ident()`、`_ident_in_range()`
  - （若你愿意）将 figure/table 的核心正则以“函数返回 pattern”方式集中：`get_figure_caption_re()` / `get_table_caption_re()`
- 主文件兼容：
  - `scripts/extract_pdf_assets.py` 继续 re-export 上述函数，保证 `scripts/tests/test_p1_ident_parsing.py` 不用改。
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 04：抽离 QC 与预验证（`qc.py`）

- 新增文件：
  - `scripts/lib/qc.py`
- 迁移符号：
  - `pre_validate_pdf()`
  - `count_text_references()`、`_categorize_idents()`、`quality_check()`
- 注意：
  - `quality_check()` 目前依赖 `AttachmentRecord` 与文本路径/正则；迁移后只改 import，不改逻辑。
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 05：抽离输出与索引（`output.py`）

- 新增文件：
  - `scripts/lib/output.py`
- 迁移符号：
  - `write_manifest()`
  - `_load_index_json_items()`
  - `prune_unindexed_images()`
  - `build_output_basename()`
  - `get_unique_path()`
  - `write_index_json()`
- 关键验收点（QA-05）：
  - `write_index_json()` 仍写入 `original_file/current_file`，且初始等于 `file`
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 06：抽离调试可视化（`debug_visual.py`）

- 新增文件：
  - `scripts/lib/debug_visual.py`
- 迁移符号：
  - `_draw_rects_on_pix()`
  - `dump_page_candidates()`
  - `save_debug_visualization()`
  - （以及 `DebugStageInfo` 已在 models 中）
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 07：抽离精裁与验收（`refine.py`，风险中等但收益大）

- 新增文件：
  - `scripts/lib/refine.py`
- 迁移符号（按“从底层到上层”顺序搬，减少来回改动）：
  - `_collect_text_lines()`、`_is_caption_text()`、`_detect_exact_n_lines_of_text()`
  - `_trim_clip_head_by_text()`、`_trim_clip_head_by_text_v2()`
  - `_merge_rects()`、`_refine_clip_by_objects()`
  - `_build_text_masks_px()`
  - `_detect_far_side_text_evidence()`、`_trim_far_side_text_post_autocrop()`
  - `_adaptive_acceptance_thresholds()`（配合 `AcceptanceThresholds`）
  - 以及表格打分相关小函数：`_paragraph_ratio()`、`_estimate_column_peaks()`、`_line_density()`、`snap_clip_edges()`
- 风险控制：
  - **不改任何算法/阈值/默认值**，只改 import 与文件位置。
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`
  - （里程碑回归）`python3 scripts/tests/run_all.py`

### Commit 08：抽离 Caption Detection（`caption_detection.py`）

- 新增文件：
  - `scripts/lib/caption_detection.py`
- 迁移符号：
  - `get_page_images()`、`get_page_drawings()`、`min_distance_to_rects()`
  - `is_bold_text()`、`get_next_line_text()`、`get_paragraph_length()`
  - `is_likely_reference_context()`、`is_likely_caption_context()`
  - `find_all_caption_candidates()`、`score_caption_candidate()`、`select_best_caption()`、`build_caption_index()`
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 09：抽离 Layout Model（`layout_model.py`）

- 新增文件：
  - `scripts/lib/layout_model.py`
- 迁移符号：
  - `_classify_text_types()`、`_detect_columns()`、`_build_text_blocks()`、`_detect_vacant_regions()`、`_adjust_clip_with_layout()`
  - `_should_enable_layout_driven()`（保留三态 `auto|on|off` 语义）
  - `extract_text_with_format()`（如果你希望 layout 与“带格式文本提取”放一起）
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 10：抽离文本相关（`text_extract.py`）

- 新增文件：
  - `scripts/lib/text_extract.py`
- 迁移符号：
  - `try_extract_text()`
  - `gather_structured_text()`（以及内部 helper：header/footer、双栏重排、段落分组）
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 11：抽离 Figure Context（`figure_contexts.py`）

- 新增文件：
  - `scripts/lib/figure_contexts.py`
- 迁移符号：
  - `build_figure_contexts()`
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`

### Commit 12：拆出“提取主循环”（图/表）为独立模块（最后动大块逻辑）

- 新增文件：
  - `scripts/lib/extract_figures.py`
  - `scripts/lib/extract_tables.py`
- 迁移符号：
  - `extract_figures()`（整段搬运，内部引用改为从 `lib.*` 引入）
  - `extract_tables()`（同上）
- 风险控制：
  - 先搬 `extract_tables()`（更独立），再搬 `extract_figures()`（更多依赖 caption/layout/refine）
- 回归：
  - `python3 scripts/tests/run_all.py --skip-golden`
  - （里程碑回归）`python3 scripts/tests/run_all.py`

### Commit 13：入口瘦身（把 `parse_args/main` 放到 `scripts/core/`，保留兼容 re-export）

- 目标：让 `scripts/extract_pdf_assets.py` 变成“兼容导出层”，真正入口在 `scripts/core/extract_pdf_assets.py`。
- 变更：
  - 将 `parse_args()`、`main()` 迁移到 `scripts/core/extract_pdf_assets.py`
  - `scripts/extract_pdf_assets.py` 保留：
    - `from core.extract_pdf_assets import main, parse_args`
    - 以及对外仍需 import 的符号（`AttachmentRecord/write_index_json/...`）统一 re-export
- 回归：
  - `python3 scripts/tests/run_all.py`（建议此步必须跑全量）

### Commit 14：清理与文档化（最后收尾）

- 清理：
  - 删除 `scripts/extract_pdf_assets.py` 中已迁走的旧实现，只保留 re-export 与必要兼容代码
  - 统一 import 路径（全部走 `lib.*`/`core.*`）
- 文档：
  - 补充 `docs/` 中“新代码结构说明 + 调试/回归命令”
- 回归：
  - `python3 scripts/tests/run_all.py`

---

## 4. 额外建议（不强制，但能显著降低后续重构成本）

- 给关键模块加“边界契约”注释（不是解释算法，而是说明输入/输出与不变量），例如：
  - `write_index_json()`：哪些字段必须稳定
  - `extract_figures()/extract_tables()`：records 的排序与字段语义
- 在里程碑提交后更新一次 golden（如果你认可新的输出作为基准）：
  - `python3 scripts/tests/run_all.py --update-golden`

---

## 5. 你需要先确认的两点（我按默认给出建议）

1) **最终“对外 import”入口是否仍然用 `from extract_pdf_assets import ...`？**
   - 默认：保留（通过 re-export 兼容）。

2) **是否接受 `scripts/core/*` 成为新的稳定 CLI 路径？**
   - 默认：接受（因为测试已依赖）。
