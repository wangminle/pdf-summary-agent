# 模块化提取逻辑迁移计划

> **版本**: V0.4.0 迁移计划  
> **日期**: 2026-01-11  
> **状态**: 进行中

## 1. 问题背景

### 1.1 现状分析

当前模块化重构后的新版脚本 (`scripts/lib/extract_figures.py` 和 `scripts/lib/extract_tables.py`) 是**简化的占位实现**，缺少旧版 (`old-version/scripts-old/extract_pdf_assets.py`) 的核心精裁逻辑。

代码中有明确警告：
```python
logger.warning(
    "extract_figures 当前为简化实现；如需与历史版本完全一致，请以输出结果为准进行回归核对。"
)
```

### 1.2 影响

测试结果显示，新版提取的图表质量明显不如旧版：
- 页眉/页脚/正文混入截图
- 裁剪边界不贴合实际图表
- 大量白边浪费空间
- 无质量保护机制

---

## 2. 功能差异对比

| 功能模块 | 旧版实现 | 新版状态 | 优先级 |
|---------|---------|---------|-------|
| **Phase A: 文本裁切** | `_trim_clip_head_by_text_v2` (~400行) | ❌ 缺失 | P0 |
| **Phase B: 对象对齐** | `_refine_clip_by_objects` (~100行) | ❌ 缺失 | P0 |
| **Phase C: 远端段落处理** | 集成在 Phase A v2 中 | ❌ 缺失 | P0 |
| **Phase D: Autocrop** | `detect_content_bbox_pixels` + 约束逻辑 (~200行) | ⚠️ 函数存在但未集成 | P0 |
| **验收与回退机制** | `adaptive_acceptance_thresholds` + 多级回退 (~150行) | ⚠️ 函数存在但未集成 | P1 |
| **智能方向判定** | 多因素评分 (~200行) | ❌ 缺失 | P1 |
| **智能 Caption 选择** | `select_best_caption` | ⚠️ 函数存在但未使用 | P1 |
| **版式驱动裁剪** | `_adjust_clip_with_layout` (~100行) | ⚠️ 函数存在但未集成 | P2 |
| **Debug 可视化** | 多阶段边界框记录 | ⚠️ 函数存在但未集成 | P2 |

**图例**: ✅ 已实现 | ⚠️ 部分实现 | ❌ 缺失

---

## 3. 新版简化实现分析

### 3.1 当前 extract_figures.py 逻辑 (第237-262行)

```python
# 计算裁剪窗口（简化版本 - 从 caption 上方取图）
caption_bbox = create_rect(*(ln.get("bbox", [0, 0, 0, 0])))
x_left = page_rect.x0 + margin_x
x_right = page_rect.x1 - margin_x
y_bottom = caption_bbox.y0 - caption_gap
y_top = max(page_rect.y0, y_bottom - clip_height)

clip = create_rect(x_left, y_top, x_right, y_bottom)

# 直接渲染，无任何精裁
pix = page.get_pixmap(dpi=dpi, clip=clip)
pix.save(out_path)
```

### 3.2 缺失的关键步骤

1. **无方向判定** - 总是假设图在 caption 上方
2. **无 Phase A 文本裁切** - 无法移除邻近段落
3. **无 Phase B 对象对齐** - 无法贴合图像边界
4. **无 Phase D Autocrop** - 无自动去白边
5. **无验收检查** - 无法检测和修正问题

---

## 4. 旧版核心函数清单

以下函数需要从 `old-version/scripts-old/extract_pdf_assets.py` 迁移：

### 4.1 Phase A: 文本裁切

| 函数名 | 行号 | 行数 | 目标位置 |
|-------|-----|-----|---------|
| `_trim_clip_head_by_text` | 1573-1662 | ~90 | `lib/refine.py` |
| `_trim_clip_head_by_text_v2` | 1664-2117 | ~450 | `lib/refine.py` |

### 4.2 Phase B: 对象对齐

| 函数名 | 行号 | 行数 | 目标位置 |
|-------|-----|-----|---------|
| `_merge_rects` | 2120-2141 | ~22 | `lib/refine.py` (已有) |
| `_refine_clip_by_objects` | 2144-2238 | ~95 | `lib/refine.py` (需完善) |

### 4.3 Phase D: Autocrop 相关

| 函数名 | 行号 | 行数 | 目标位置 |
|-------|-----|-----|---------|
| `_build_text_masks_px` | 2241-2346 | ~105 | `lib/refine.py` (已有) |
| `_detect_far_side_text_evidence` | 2349-2427 | ~78 | `lib/refine.py` (已有) |
| `_trim_far_side_text_post_autocrop` | 2430-2687 | ~257 | `lib/refine.py` (已有) |
| `snap_clip_edges` | 2689-2766 | ~77 | `lib/refine.py` (需添加) |

### 4.4 辅助函数

| 函数名 | 行号 | 行数 | 目标位置 |
|-------|-----|-----|---------|
| `_collect_draw_items` | ~900-1000 | ~100 | `lib/extract_helpers.py` (已有) |
| `_collect_text_lines` | ~1000-1100 | ~100 | `lib/extract_helpers.py` (已有) |
| `_estimate_ink_ratio` | ~930-970 | ~40 | `lib/extract_helpers.py` (已有) |

### 4.5 主循环逻辑

| 函数名 | 行号 | 行数 | 目标位置 |
|-------|-----|-----|---------|
| `_extract_figures` | 3232-4700 | ~1470 | `lib/extract_figures.py` |
| `_extract_tables` | 5232-6400 | ~1170 | `lib/extract_tables.py` |

---

## 5. 迁移计划

### 5.1 阶段划分

| 阶段 | 内容 | 预估工作量 | 状态 |
|-----|------|-----------|------|
| **Phase 1** | 迁移 Phase A 文本裁切函数 | 30% | ✅ **完成** (2026-01-11) |
| **Phase 2** | 集成 Phase B/D 到主循环 + 验收机制 | 40% | ✅ **完成** (2026-01-11) |
| **Phase 3** | 智能方向判定 + 版式驱动 + Debug | 30% | ✅ **完成** (2026-01-11) |

### 5.2 Phase 1 详细任务 (前 1/3 工作量) ✅ 已完成

#### 5.2.1 迁移核心裁切函数到 `lib/refine.py`

- [x] 迁移 `_trim_clip_head_by_text()` 基础版本
- [x] 迁移 `_trim_clip_head_by_text_v2()` 增强版本（含 Phase A+B+C）
- [x] 迁移辅助函数 `is_caption_text()` 和 `detect_exact_n_lines_of_text()`
- [x] 更新 `refine.py` 的 `__all__` 导出列表
- [x] 添加必要的类型注解和文档字符串

#### 5.2.2 更新 `lib/extract_figures.py` 主循环

- [x] 导入新迁移的函数
- [x] 添加方向判定逻辑（上方/下方）
- [x] 集成 Phase A 文本裁切调用
- [x] 集成 Phase B 对象对齐调用
- [x] 添加 `below_figs`/`above_figs` 参数支持
- [x] 移除简化实现的警告

#### 5.2.3 更新 `lib/extract_tables.py` 主循环

- [x] 导入新迁移的函数
- [x] 集成 Phase A 文本裁切调用（表格专用参数：skip_adjacent_sweep=True）
- [x] 集成 Phase B 对象对齐调用
- [x] 确保 `t_below`/`t_above` 参数正确使用

#### 5.2.4 测试验证

- [x] 导入验证通过
- [x] DeepSeek_V3_2 测试通过：提取 4 Figures + 1 Table

### 5.3 Phase 2 详细任务 (中间 40% 工作量) ✅ 已完成

#### 5.3.1 集成 Phase B 对象对齐

- [x] 完善 `refine_clip_by_objects()` 函数
- [x] 在 `extract_figures.py` 中调用
- [x] 在 `extract_tables.py` 中调用

#### 5.3.2 集成 Phase D Autocrop

- [x] 集成 `detect_content_bbox_pixels()` 调用
- [x] 实现 P0-1 远端边界单调性约束
- [x] 集成 `trim_far_side_text_post_autocrop()` 调用
- [x] 添加 autocrop 参数支持

#### 5.3.3 实现验收与回退机制

- [x] 集成 `adaptive_acceptance_thresholds()` 调用
- [x] 实现高度/面积/覆盖率检查
- [x] 实现多级回退逻辑（refined → A-only → baseline）
- [x] 添加验收失败日志记录

### 5.4 Phase 3 详细任务 (后 30% 工作量) ✅ 已完成

#### 5.4.1 智能方向判定

- [x] 新建 `direction.py` 模块
- [x] 实现 `compute_global_anchor()` 全局锚点预扫描
- [x] 实现 `determine_direction()` 智能方向判定
- [x] 集成到 `extract_figures.py` 和 `extract_tables.py`

#### 5.4.2 智能 Caption 选择

- [x] `caption_detection.py` 中已实现 `select_best_caption()`
- [x] `build_caption_index()` 已集成到主循环

#### 5.4.3 版式驱动裁剪

- [x] `layout_model.py` 中已有 `adjust_clip_with_layout()` 函数
- [x] 集成到 `extract_figures.py` 主循环
- [x] 集成到 `extract_tables.py` 主循环

#### 5.4.4 Debug 可视化

- [x] 收集各阶段边界框信息 (Baseline/Phase A/B/D)
- [x] 集成 `save_debug_visualization()` 调用
- [x] 支持 `--debug-visual` 参数

---

## 6. 测试验证计划

### 6.1 回归测试

使用 `tests-basic-benchmark/` 下的测试用例：

```powershell
# 新版测试
python scripts/extract_pdf_assets.py --pdf tests-basic-benchmark/DeepSeek_V3_2/DeepSeek_V3_2.pdf --preset robust --out-dir tests-basic-benchmark/DeepSeek_V3_2/images__new

# 旧版对照
python old-version/scripts-old/extract_pdf_assets.py --pdf tests-basic-benchmark/DeepSeek_V3_2/DeepSeek_V3_2.pdf --preset robust --out-dir tests-basic-benchmark/DeepSeek_V3_2/images__old
```

### 6.2 验收标准

1. **功能一致性**: 新旧版输出图片应基本一致（允许 5% 像素差异）
2. **日志一致性**: Phase A/B/D 相关日志事件应一致
3. **性能**: 新版不应明显慢于旧版

---

## 7. 风险与注意事项

1. **代码量大**: 旧版核心逻辑约 3000+ 行，需要仔细拆分
2. **依赖关系**: 部分函数有复杂的依赖，需要逐步验证
3. **参数兼容**: 确保所有 CLI 参数在新版中正确传递
4. **测试覆盖**: 每个阶段完成后需要回归测试

---

## 附录：文件变更清单

| 文件 | 变更类型 | 说明 |
|-----|---------|------|
| `scripts/lib/refine.py` | 修改 | 添加 Phase A 文本裁切函数 (~600行) |
| `scripts/lib/extract_figures.py` | 重写 | 完整实现主循环，集成 Phase A/B/D + 验收 (~450行) |
| `scripts/lib/extract_tables.py` | 重写 | 完整实现主循环，集成 Phase A/B/D + 验收 (~480行) |
| `scripts/lib/direction.py` | **新建** | 智能方向判定 + 全局锚点 (~280行) |
| `scripts/extract_pdf_assets.py` | 修改 | 更新导出符号 |

## 附录：测试验证记录

| 测试 | 结果 | 说明 |
|-----|------|------|
| Phase 1 测试 | ✅ 通过 | 4 Figures + 1 Table |
| Phase 2 测试 | ✅ 通过 | 验收机制正常工作 |
| Phase 3 测试 | ✅ 通过 | 全功能测试通过 |

## 附录：新增模块说明

### direction.py

智能方向判定模块，包含：
- `compute_global_anchor()`: 预扫描计算全局锚点方向
- `determine_direction()`: 综合判定单个图表的提取方向
- `score_direction_for_caption()`: 评估单个 caption 的方向得分
- `compute_object_ratio()`: 计算对象覆盖率
