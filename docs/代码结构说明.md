# 代码结构说明

> 本文档说明 V0.3.x 版本的模块化代码架构。

## 版本信息

- **版本**：V0.3.1
- **日期**：2026-01-10
- **状态**：Commit 13/14 完成（入口瘦身 + 清理文档化）

---

## 架构概览

```
pdf-summary-agent/
├── scripts/                      # 新版模块化代码
│   ├── extract_pdf_assets.py     # 兼容导出层（主入口）
│   ├── __init__.py
│   ├── core/                     # 核心入口模块
│   │   ├── __init__.py
│   │   └── extract_pdf_assets.py # CLI 解析 + main()
│   ├── lib/                      # 模块化组件库
│   │   ├── __init__.py           # 统一导出
│   │   ├── models.py             # 数据结构定义
│   │   ├── idents.py             # 标识符与正则表达式
│   │   ├── output.py             # 输出与索引管理
│   │   ├── caption_detection.py  # 智能 Caption 检测
│   │   ├── layout_model.py       # 版式模型
│   │   ├── text_extract.py       # 文本提取
│   │   ├── refine.py             # 精裁与验收
│   │   ├── debug_visual.py       # 调试可视化
│   │   ├── figure_contexts.py    # 图表上下文构建
│   │   ├── extract_helpers.py    # 提取辅助函数
│   │   ├── extract_figures.py    # Figure 提取（占位实现）
│   │   ├── extract_tables.py     # Table 提取（占位实现）
│   │   ├── pdf_backend.py        # PDF 后端抽象层
│   │   ├── env_priority.py       # 环境变量优先级
│   │   └── extraction_logger.py  # 日志系统
│   └── requirements.txt
├── scripts-old/                  # 旧版完整实现（过渡期保留）
│   ├── extract_pdf_assets.py     # 完整实现（~8500 行）
│   └── sync_index_after_rename.py
└── docs/                         # 文档
    ├── AGENTS.md                 # Agent 工作流指南
    ├── 代码结构说明.md            # 本文档
    └── ...
```

---

## 三层架构

### 1. 兼容导出层（`scripts/extract_pdf_assets.py`）

**职责**：
- 提供向后兼容的导入路径
- 作为命令行入口点
- Re-export 常用符号

**使用方式**：
```python
# 命令行
python scripts/extract_pdf_assets.py --pdf paper.pdf --preset robust

# 作为模块导入
from extract_pdf_assets import main, parse_args, AttachmentRecord
```

### 2. 核心入口（`scripts/core/`）

**职责**：
- CLI 参数解析（`parse_args()`）
- 主流程控制（`main()`）
- 过渡期委托给旧版实现

**文件**：
- `__init__.py`：包入口，导出核心符号
- `extract_pdf_assets.py`：CLI + main 实现

### 3. 模块化组件库（`scripts/lib/`）

**职责**：
- 提供独立、可测试的功能模块
- 定义清晰的 API 边界
- 支持渐进式迁移

---

## 模块详解

### 数据结构（`lib/models.py`）

定义核心数据结构：

| 类名 | 说明 |
|------|------|
| `AttachmentRecord` | 图/表提取记录 |
| `CaptionCandidate` | Caption 候选项 |
| `CaptionIndex` | Caption 索引 |
| `DocumentLayoutModel` | 文档版式模型 |
| `GatheredText` | 结构化文本 |
| `TextBlock` | 文本块 |
| `AcceptanceThresholds` | 验收阈值 |

### 标识符（`lib/idents.py`）

正则表达式与标识符处理：

```python
from lib.idents import (
    FIGURE_LINE_RE,      # Figure 匹配正则
    TABLE_LINE_RE,       # Table 匹配正则
    extract_figure_ident,  # 提取 Figure 编号
    extract_table_ident,   # 提取 Table 编号
    sanitize_filename_from_caption,  # 文件名清理
)
```

### 输出管理（`lib/output.py`）

索引与清单输出：

```python
from lib.output import (
    write_index_json,      # 写入 index.json
    write_manifest,        # 写入 CSV 清单
    load_index_json_items, # 加载索引
    prune_unindexed_images,  # 清理未索引图片
    get_unique_path,       # 获取唯一路径
)
```

### Caption 检测（`lib/caption_detection.py`）

智能 Caption 识别：

```python
from lib.caption_detection import (
    build_caption_index,      # 构建全文索引
    find_all_caption_candidates,  # 查找候选项
    score_caption_candidate,  # 评分
    select_best_caption,      # 选择最佳
)
```

### 版式模型（`lib/layout_model.py`）

文档版式分析：

```python
from lib.layout_model import (
    should_enable_layout_driven,  # 是否启用版式驱动
    build_text_blocks,       # 构建文本块
    detect_columns,          # 检测栏数
    classify_text_types,     # 分类文本类型
)
```

### 文本提取（`lib/text_extract.py`）

文本提取与验证：

```python
from lib.text_extract import (
    pre_validate_pdf,        # PDF 预验证
    try_extract_text,        # 提取纯文本
    gather_structured_text,  # 结构化文本
    extract_text_with_format,  # 带格式提取
)
```

### 精裁与验收（`lib/refine.py`）

裁剪窗口优化：

```python
from lib.refine import (
    detect_content_bbox_pixels,  # 像素级内容检测
    refine_clip_by_objects,      # 基于对象精裁
    adaptive_acceptance_thresholds,  # 动态阈值
    trim_far_side_text_post_autocrop,  # 远端文本裁切
)
```

### 调试可视化（`lib/debug_visual.py`）

调试辅助：

```python
from lib.debug_visual import (
    save_debug_visualization,  # 保存调试图
    draw_rects_on_pix,        # 绘制边界框
    STAGE_COLORS,             # 阶段颜色方案
)
```

### PDF 后端（`lib/pdf_backend.py`）

PDF 引擎抽象层：

```python
from lib.pdf_backend import (
    open_pdf,                 # 打开 PDF
    PDFDocument,              # 文档抽象
    PDFPage,                  # 页面抽象
    try_extract_tables_with_pdfplumber,  # 表格提取（可选）
)
```

---

## 迁移状态

### 已完成

| Commit | 模块 | 状态 |
|--------|------|------|
| 01 | `env_priority.py` | ✅ 完整实现 |
| 01B | `pdf_backend.py` | ✅ 完整实现 |
| 02 | `models.py` | ✅ 完整实现 |
| 03 | `idents.py` | ✅ 完整实现 |
| 05 | `output.py` | ✅ 完整实现 |
| 06 | `debug_visual.py` | ✅ 完整实现 |
| 07 | `refine.py` | ✅ 完整实现 |
| 08 | `caption_detection.py` | ✅ 完整实现 |
| 09 | `layout_model.py` | ✅ 完整实现 |
| 10 | `text_extract.py` | ✅ 完整实现 |
| 11 | `figure_contexts.py` | ✅ 完整实现 |
| 12 | `extract_helpers.py` | ✅ 完整实现 |
| 12 | `extract_figures.py` | ⚠️ 占位实现 |
| 12 | `extract_tables.py` | ⚠️ 占位实现 |
| 13 | 入口瘦身 | ✅ 完成 |
| 14 | 清理与文档化 | ✅ 完成 |

### 待完成

- `extract_figures.py` 和 `extract_tables.py` 的完整逻辑迁移
- 完全移除对 `scripts-old/` 的依赖
- PDF 后端抽象层在主流程中的应用

---

## 使用指南

### 命令行使用

```bash
# 推荐：使用新入口
python scripts/extract_pdf_assets.py --pdf paper.pdf --preset robust

# 兼容：使用旧入口
python scripts-old/extract_pdf_assets.py --pdf paper.pdf --preset robust
```

### 模块导入

```python
# 方式 1：通过兼容层导入（推荐）
from extract_pdf_assets import (
    main, parse_args,
    AttachmentRecord, write_index_json,
)

# 方式 2：直接从 lib 导入
from lib.models import AttachmentRecord
from lib.output import write_index_json
from lib.caption_detection import build_caption_index

# 方式 3：通过 core 导入
from core.extract_pdf_assets import main, parse_args
```

### 运行测试

```bash
# 验证新入口可用
python scripts/extract_pdf_assets.py --help

# 验证模块可导入
python -c "from lib.models import AttachmentRecord; print('OK')"
python -c "from lib.pdf_backend import open_pdf; print('OK')"
```

---

## 回归验证

```bash
# 快速回归（建议每次修改后运行）
python scripts/extract_pdf_assets.py --pdf test.pdf --preset robust

# 对比新旧入口输出
python scripts/extract_pdf_assets.py --pdf test.pdf --preset robust --out-dir out_new
python scripts-old/extract_pdf_assets.py --pdf test.pdf --preset robust --out-dir out_old
# 对比 out_new/ 和 out_old/ 的输出
```

---

## 后续计划

1. **完成 extract_figures/tables 迁移**：将完整逻辑从 `scripts-old/` 迁移到 `lib/`
2. **PDF 后端集成**：在主流程中使用 `open_pdf()` 替代直接 `fitz.open()`
3. **移除 scripts-old/**：完全迁移后删除旧版代码
4. **添加单元测试**：为各模块添加测试用例
