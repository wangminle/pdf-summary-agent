# PDF å›¾è¡¨æå–æµç¨‹åˆ†æä¸æ”¹è¿›å»ºè®®

> **æ–‡æ¡£æ—¥æœŸ**ï¼š2025-12-21  
> **åˆ†æèŒƒå›´**ï¼š`scripts/extract_pdf_assets.py` ä»£ç å®¡æŸ¥ + Uni-Parser è®ºæ–‡å¯¹æ ‡åˆ†æ  
> **ç›®æ ‡**ï¼šè¯†åˆ«æ½œåœ¨é—®é¢˜ï¼Œæå‡ºæ”¹è¿›å»ºè®®

---

## ç›®å½•

- [ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç æµç¨‹æ½œåœ¨é—®é¢˜åˆ†æ](#ç¬¬ä¸€éƒ¨åˆ†ä»£ç æµç¨‹æ½œåœ¨é—®é¢˜åˆ†æ)
  - [é«˜é£é™©é—®é¢˜](#-é«˜é£é™©é—®é¢˜å¯èƒ½å¯¼è‡´æå–å¤±è´¥æˆ–é”™è¯¯)
  - [ä¸­é£é™©é—®é¢˜](#-ä¸­é£é™©é—®é¢˜å¯èƒ½å¯¼è‡´è£åˆ‡ä¸å‡†ç¡®)
  - [ä½é£é™©é—®é¢˜](#-ä½é£é™©é—®é¢˜å¯èƒ½å¯¼è‡´è¾¹ç¼˜æƒ…å†µå¼‚å¸¸)
  - [è°ƒè¯•å»ºè®®](#-è°ƒè¯•å»ºè®®)
- [ç¬¬äºŒéƒ¨åˆ†ï¼šUni-Parser è®ºæ–‡å·¥ä½œæµç¨‹åˆ†æ](#ç¬¬äºŒéƒ¨åˆ†uni-parser-è®ºæ–‡å·¥ä½œæµç¨‹åˆ†æ)
  - [æ•´ä½“æ¶æ„æ¦‚è¿°](#ä¸€æ•´ä½“æ¶æ„æ¦‚è¿°)
  - [å®Œæ•´å·¥ä½œæµç¨‹](#äºŒå®Œæ•´å·¥ä½œæµç¨‹5-å¤§ç»„ä»¶)
  - [å…³é”®æŠ€æœ¯åˆ›æ–°](#ä¸‰å…³é”®æŠ€æœ¯åˆ›æ–°)
- [ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¯¹æ ‡åˆ†æä¸æ”¹è¿›å»ºè®®](#ç¬¬ä¸‰éƒ¨åˆ†å¯¹æ ‡åˆ†æä¸æ”¹è¿›å»ºè®®)
  - [æ¶æ„å¯¹æ¯”](#æ¶æ„å¯¹æ¯”è¡¨)
  - [å¯å€Ÿé‰´çš„è®¾è®¡æ€è·¯](#-å¯å€Ÿé‰´çš„è®¾è®¡æ€è·¯)
  - [ä¸é€‚åˆå€Ÿé‰´çš„éƒ¨åˆ†](#-ä¸é€‚åˆç›´æ¥å€Ÿé‰´çš„éƒ¨åˆ†)
  - [æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§](#-æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§)
- [æ€»ç»“](#-æ€»ç»“)

---

# ç¬¬ä¸€éƒ¨åˆ†ï¼šä»£ç æµç¨‹æ½œåœ¨é—®é¢˜åˆ†æ

æ ¹æ®å¯¹ `scripts/extract_pdf_assets.py` ä»£ç ï¼ˆçº¦ 5200 è¡Œï¼‰çš„è¯¦ç»†å®¡æŸ¥ï¼Œè¯†åˆ«å‡ºä»¥ä¸‹å¯èƒ½å¹²æ‰°æœ€ç»ˆæå–ç»“æœçš„æ„å¤–å› ç´ ã€‚

---

## ğŸ”´ é«˜é£é™©é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´æå–å¤±è´¥æˆ–é”™è¯¯ï¼‰

### 1. ç¯å¢ƒå˜é‡æ±¡æŸ“é£é™©

ä»£ç ä¸­ä½¿ç”¨äº† **17 å¤„ `os.getenv()` è°ƒç”¨**ï¼Œè¿™äº›ç¯å¢ƒå˜é‡å¦‚æœåœ¨ä¹‹å‰çš„è¿è¡Œä¸­è¢«è®¾ç½®ä½†æœªæ¸…ç†ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–è¡Œä¸ºï¼š

```python
# å…³é”®ç¯å¢ƒå˜é‡åˆ—è¡¨
EXTRACT_ANCHOR_MODE      # é”šç‚¹æ¨¡å¼ v1/v2
GLOBAL_ANCHOR            # å…¨å±€é”šç‚¹æ–¹å‘
SCAN_HEIGHTS             # å¤šå°ºåº¦çª—å£é«˜åº¦
SCAN_DIST_LAMBDA         # è·ç¦»ç½šé¡¹æƒé‡
EXTRACT_FORCE_ABOVE      # å¼ºåˆ¶ä¸Šæ–¹è£å‰ªçš„å›¾å·
EXTRACT_FORCE_TABLE_ABOVE # å¼ºåˆ¶è¡¨æ ¼ä¸Šæ–¹è£å‰ª
GLOBAL_ANCHOR_TABLE      # è¡¨æ ¼å…¨å±€é”šç‚¹æ–¹å‘
CAPTION_MID_GUARD        # å›¾æ³¨ä¸­çº¿æŠ¤æ 
DUMP_CANDIDATES          # è°ƒè¯•å¯¼å‡ºå¼€å…³
```

**é—®é¢˜æè¿°**ï¼š`os.environ.setdefault()` ä¸ä¼šè¦†ç›–å·²å­˜åœ¨çš„ç¯å¢ƒå˜é‡å€¼ï¼Œå¦‚æœç”¨æˆ·åœ¨ shell ä¸­é¢„è®¾äº†è¿™äº›å˜é‡ï¼Œå‘½ä»¤è¡Œå‚æ•°å°†**è¢«å¿½ç•¥**ã€‚

**ä»£ç ä½ç½®**ï¼šç¬¬ 5094-5106 è¡Œ

```python
# main() å‡½æ•°ä¸­
os.environ.setdefault('EXTRACT_ANCHOR_MODE', (args.anchor_mode or 'v2'))
os.environ.setdefault('SCAN_STEP', str(args.scan_step))
os.environ.setdefault('SCAN_HEIGHTS', args.scan_heights or '240,320,420,520,640')
# ...
```

**å»ºè®®ä¿®å¤**ï¼š

```python
# æ–¹æ¡ˆ Aï¼šå¼ºåˆ¶è¦†ç›–
os.environ['EXTRACT_ANCHOR_MODE'] = args.anchor_mode or 'v2'

# æ–¹æ¡ˆ Bï¼šåœ¨è„šæœ¬å¼€å¤´æ¸…ç†ç›¸å…³å˜é‡
MANAGED_ENV_VARS = ['EXTRACT_ANCHOR_MODE', 'GLOBAL_ANCHOR', 'SCAN_HEIGHTS', ...]
for var in MANAGED_ENV_VARS:
    os.environ.pop(var, None)
```

---

### 2. æ™ºèƒ½ Caption æ£€æµ‹çš„è·¨é¡µé€‰æ‹©é—®é¢˜

åœ¨ `build_caption_index` å’Œ `select_best_caption` é€»è¾‘ä¸­ï¼š

```python
# ç¬¬ 1776-1786 è¡Œ
for cand in candidates:
    score_page = page
    if doc is not None:
        try:
            score_page = doc[cand.page]  # è·å–å€™é€‰æ‰€åœ¨é¡µ
        except Exception:
            score_page = page  # å›é€€åˆ°å½“å‰é¡µ
    images = get_page_images(score_page)
    drawings = get_page_drawings(score_page)
    score = score_caption_candidate(cand, images, drawings, debug=debug)
```

**é—®é¢˜æè¿°**ï¼šå½“åŒä¸€å›¾å·åœ¨å¤šé¡µå‡ºç°æ—¶ï¼ˆå¦‚ Figure 3 åœ¨ç¬¬ 5 é¡µæœ‰å¼•ç”¨ï¼Œç¬¬ 7 é¡µæ˜¯çœŸå®å›¾æ³¨ï¼‰ï¼Œè¯„åˆ†é€»è¾‘ä¾èµ– `doc[cand.page]` è·å–é¡µé¢ã€‚å¦‚æœ `doc` ä¸º `None`ï¼ˆæŸäº›è¾¹ç¼˜æƒ…å†µï¼‰ï¼Œæ‰€æœ‰å€™é€‰éƒ½ä½¿ç”¨å½“å‰é¡µçš„å›¾åƒ/ç»˜å›¾å¯¹è±¡æ¥è¯„åˆ†ï¼Œå¯èƒ½å¯¼è‡´**è¯¯é€‰å‰æ–‡å¼•ç”¨**ã€‚

**å½±å“åœºæ™¯**ï¼š
- è®ºæ–‡åœ¨æ­£æ–‡ä¸­å…ˆè®¨è®ºå›¾è¡¨ï¼Œå†å±•ç¤ºå›¾è¡¨
- è·¨é¡µå¼•ç”¨åŒä¸€ä¸ªå›¾å·

**å»ºè®®ä¿®å¤**ï¼š

```python
# ç¡®ä¿ doc å‚æ•°å§‹ç»ˆæœ‰æ•ˆ
def select_best_caption(candidates, page, *, doc, min_score_threshold=25.0, debug=False):
    if doc is None:
        raise ValueError("doc parameter is required for cross-page scoring")
    # ...
```

---

### 3. "ä¸¤è¡Œæ£€æµ‹"å¯èƒ½è¯¯è£å›¾æ³¨æœ¬èº«

åœ¨ `_trim_clip_head_by_text_v2` ä¸­ï¼ˆç¬¬ 852-886 è¡Œï¼‰ï¼š

```python
# æ£€æµ‹æ˜¯å¦æ°å¥½æœ‰2è¡Œæ–‡å­—
is_exact_two, matched_lines = _detect_exact_n_lines_of_text(
    check_strip, text_lines, typical_line_h, n=2, tolerance=0.35
)
if is_exact_two and len(matched_lines) == 2:
    # ä½¿ç”¨æ›´æ¿€è¿›çš„è£åˆ‡ï¼šç§»é™¤è¿™ä¸¤è¡Œæ–‡å­—
    if near_is_top_a:
        new_y0 = matched_lines[-1].y1 + gap  # æœ€åä¸€è¡Œåº•éƒ¨ + gap
        clip.y0 = max(clip.y0, new_y0)
```

**é—®é¢˜æè¿°**ï¼šå¦‚æœå›¾æ³¨æœ¬èº«æ°å¥½æ˜¯ä¸¤è¡Œï¼Œä¸”æ»¡è¶³å­—å·/è¡Œè·æ¡ä»¶ï¼Œå¯èƒ½è¢«è¯¯åˆ¤ä¸º"å¤šä½™æ–‡å­—"è€Œè¢«è£æ‰ã€‚

**å…¸å‹åœºæ™¯**ï¼š
- é•¿æ ‡é¢˜å›¾æ³¨æ¢è¡Œåæ°å¥½ä¸¤è¡Œ
- Abstract/Introduction ç­‰èŠ‚æ ‡é¢˜æ°å¥½ä¸¤è¡Œ

**å»ºè®®ä¿®å¤**ï¼š

```python
# æ·»åŠ å¯¹å›¾æ³¨æ–‡æœ¬çš„æ’é™¤æ£€æŸ¥
def is_caption_text(lines, caption_rect, tolerance=10.0):
    """æ£€æŸ¥æ–‡æœ¬è¡Œæ˜¯å¦å±äºå›¾æ³¨"""
    for line in lines:
        if abs(line.y0 - caption_rect.y0) < tolerance:
            return True
    return False

# åœ¨ Phase A+ ä¸­
if is_exact_two and len(matched_lines) == 2:
    # æ’é™¤å›¾æ³¨æœ¬èº«
    if not is_caption_text(matched_lines, caption_rect):
        # æ‰§è¡Œè£åˆ‡
        ...
```

---

## ğŸŸ  ä¸­é£é™©é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´è£åˆ‡ä¸å‡†ç¡®ï¼‰

### 4. å…¨å±€é”šç‚¹æ–¹å‘åˆ¤æ–­çš„"å¾®å¼±ä¼˜åŠ¿"é—®é¢˜

```python
# ç¬¬ 2010-2014 è¡Œ
if os.getenv('GLOBAL_ANCHOR', 'auto').lower() == 'auto':
    ga_margin = float(os.getenv('GLOBAL_ANCHOR_MARGIN', '0.02'))  # ä»… 2% å·®è·
    # ... 
    # å¦‚æœ below_total > above_total * (1 + ga_margin) åˆ™å…¨ç¯‡é€‰ below
```

**é—®é¢˜æè¿°**ï¼šå½“ `above_total` å’Œ `below_total` éå¸¸æ¥è¿‘ï¼ˆå·®è· < 2%ï¼‰æ—¶ï¼Œå¯èƒ½å› ä¸ªåˆ«é¡µé¢çš„å™ªå£°å¯¼è‡´å…¨ç¯‡é”™è¯¯é€‰æ‹©æ–¹å‘ã€‚é»˜è®¤ margin 0.02 å¯¹æŸäº›å¤æ‚æ’ç‰ˆçš„è®ºæ–‡å¯èƒ½è¿‡äºæ¿€è¿›ã€‚

**å…¸å‹åœºæ™¯**ï¼š
- è®ºæ–‡å‰åŠéƒ¨åˆ†å›¾åœ¨ä¸Šæ–¹ï¼ŒååŠéƒ¨åˆ†å›¾åœ¨ä¸‹æ–¹
- æ··åˆæ’ç‰ˆçš„ç»¼è¿°è®ºæ–‡

**å»ºè®®ä¿®å¤**ï¼š

```python
# å½“å·®è·è¿‡å°æ—¶ï¼Œå›é€€åˆ°æŒ‰é¡µå†³ç­–
CLOSE_MARGIN = 0.05  # 5% ä»¥å†…è§†ä¸º"åŠ¿å‡åŠ›æ•Œ"

if abs(below_total - above_total) / max(1.0, above_total + below_total) < CLOSE_MARGIN:
    global_side = None  # ä¸ä½¿ç”¨å…¨å±€æ–¹å‘ï¼ŒæŒ‰é¡µç‹¬ç«‹å†³ç­–
    print("[INFO] Global anchor undecided (close scores), using per-page decision")
```

---

### 5. ç²¾è£éªŒæ”¶é˜ˆå€¼çš„"ä¸€åˆ€åˆ‡"é—®é¢˜

```python
# ç¬¬ 2745-2747 è¡Œ
relax_h = 0.60   # é«˜åº¦è‡³å°‘ä¿ç•™ 60%
relax_a = 0.55   # é¢ç§¯è‡³å°‘ä¿ç•™ 55%
```

**é—®é¢˜æè¿°**ï¼šè¿™äº›é˜ˆå€¼æ˜¯å›ºå®šçš„ï¼Œä½†ä¸åŒç±»å‹çš„å›¾è¡¨å·®å¼‚å¾ˆå¤§ï¼š
- **å…¨é¡µå¤§å›¾**ï¼š60% é«˜åº¦å·²ç»å¾ˆå¤§ï¼ˆå¯èƒ½ 400ptï¼‰
- **ç´§å‡‘å°å›¾**ï¼šå¯èƒ½åªæœ‰ 100pt é«˜åº¦ï¼Œ60% ååªå‰© 60ptï¼Œå¯èƒ½ä»ç„¶è¿‡å¤§

**å»ºè®®ä¿®å¤**ï¼š

```python
# æ ¹æ®åŸºçº¿é«˜åº¦åŠ¨æ€è°ƒæ•´é˜ˆå€¼
def adaptive_thresholds(base_height):
    if base_height > 400:
        return 0.50, 0.45  # å¤§å›¾å¯ä»¥æ›´æ¿€è¿›
    elif base_height > 200:
        return 0.60, 0.55  # ä¸­ç­‰å›¾ä½¿ç”¨é»˜è®¤
    else:
        return 0.75, 0.70  # å°å›¾æ›´ä¿å®ˆ
```

---

### 6. è¡¨æ ¼ä¸å›¾ç‰‡ä½¿ç”¨ä¸åŒçš„é»˜è®¤å‚æ•°

```python
# å›¾ç‰‡é»˜è®¤
object_min_area_ratio: float = 0.010,
allow_continued: bool = False,

# è¡¨æ ¼é»˜è®¤
object_min_area_ratio: float = 0.005,   # æ›´æ•æ„Ÿ
allow_continued: bool = True,            # é»˜è®¤å…è®¸ç»­é¡µ
```

**é—®é¢˜æè¿°**ï¼šè¿™ç§ä¸ä¸€è‡´å¯èƒ½å¯¼è‡´ç”¨æˆ·å›°æƒ‘ã€‚ä¾‹å¦‚ï¼Œå›¾ç‰‡é»˜è®¤**ä¸å…è®¸ç»­é¡µ**ï¼Œä½†è¡¨æ ¼é»˜è®¤**å…è®¸**ã€‚å¦‚æœç”¨æˆ·åªç”¨ `--allow-continued` å‚æ•°ï¼Œåªä¼šå½±å“å›¾ç‰‡è€Œä¸å½±å“è¡¨æ ¼ï¼ˆè¡¨æ ¼å·²ç»æ˜¯ Trueï¼‰ã€‚

**å»ºè®®ä¿®å¤**ï¼š
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜å·®å¼‚
- æˆ–ç»Ÿä¸€é»˜è®¤è¡Œä¸ºï¼Œç”¨ `--table-allow-continued` å•ç‹¬æ§åˆ¶è¡¨æ ¼

---

## ğŸŸ¡ ä½é£é™©é—®é¢˜ï¼ˆå¯èƒ½å¯¼è‡´è¾¹ç¼˜æƒ…å†µå¼‚å¸¸ï¼‰

### 7. å®½æ³›çš„å¼‚å¸¸æ•è·

ä»£ç ä¸­æœ‰ 4 å¤„ `except Exception:` æˆ– `except ... pass`ï¼š

```python
# ç¬¬ 2030-2032 è¡Œ
try:
    for dr in page_s.get_drawings():
        ...
except Exception:
    pass  # é™é»˜å¿½ç•¥
```

**é—®é¢˜æè¿°**ï¼šè¿™ç§æ¨¡å¼ä¼šéšè—æ½œåœ¨é—®é¢˜ï¼ˆå¦‚ PyMuPDF ç‰ˆæœ¬ä¸å…¼å®¹ã€å†…å­˜ä¸è¶³ç­‰ï¼‰ï¼Œå¯¼è‡´è°ƒè¯•å›°éš¾ã€‚

**å»ºè®®ä¿®å¤**ï¼š

```python
import logging
logger = logging.getLogger(__name__)

try:
    for dr in page_s.get_drawings():
        ...
except Exception as e:
    logger.warning(f"Failed to get drawings on page {pno}: {e}")
```

---

### 8. æ­£åˆ™è¡¨è¾¾å¼å¯èƒ½é—æ¼éæ ‡å‡†å›¾æ³¨

```python
# ç¬¬ 1954-1957 è¡Œ
figure_line_re = re.compile(
    r"^\s*(?:(?:Extended\s+Data\s+Figure|Supplementary\s+Figure|Figure|Fig\.?|å›¾è¡¨|é™„å›¾|å›¾)\s*(?:S\s*)?(\d+))"
    r"(?:\s*\(continued\)|\s*ç»­|\s*æ¥ä¸Šé¡µ)?",
    re.IGNORECASE,
)
```

**æ”¯æŒä¸ä¸æ”¯æŒçš„æ ¼å¼**ï¼š

| æ ¼å¼ | æ”¯æŒçŠ¶æ€ | è¯´æ˜ |
|------|----------|------|
| `FIGURE 1` | âœ… æ”¯æŒ | `re.IGNORECASE` |
| `Figure S1` | âœ… æ”¯æŒ | é™„å½•å›¾ |
| `Fig. 1A` | âŒ ä¸æ”¯æŒ | å¸¦å­å›¾æ ‡ç­¾ |
| `Figure 1a` | âŒ ä¸æ”¯æŒ | å°å†™å­å›¾æ ‡ç­¾ |
| `å›¾1` | âŒ ä¸æ”¯æŒ | ä¸­æ–‡æ— ç©ºæ ¼ |
| `Figure I` | âŒ ä¸æ”¯æŒ | ç½—é©¬æ•°å­— |
| `Figure 1 (a)` | âŒ ä¸æ”¯æŒ | å­å›¾åœ¨æ‹¬å·ä¸­ |

**å»ºè®®ä¿®å¤**ï¼š

```python
figure_line_re = re.compile(
    r"^\s*(?:(?:Extended\s+Data\s+Figure|Supplementary\s+Figure|Figure|Fig\.?|å›¾è¡¨|é™„å›¾|å›¾)\s*"
    r"(?:S\s*)?"
    r"(\d+|[IVX]+)"  # æ”¯æŒç½—é©¬æ•°å­—
    r"(?:\s*[A-Za-z]|\s*\([A-Za-z]\))?"  # æ”¯æŒå­å›¾æ ‡ç­¾
    r")"
    r"(?:\s*\(continued\)|\s*ç»­|\s*æ¥ä¸Šé¡µ)?",
    re.IGNORECASE,
)
```

---

### 9. DPI ä¸åƒç´ é˜ˆå€¼çš„è€¦åˆ

```python
autocrop_min_height_px: int = 80,  # æœ€å°é«˜åº¦ï¼ˆåƒç´ ï¼‰
near_edge_pad_px: int = 32,        # è¾¹ç¼˜ä¿æŠ¤ï¼ˆåƒç´ ï¼‰
```

**é—®é¢˜æè¿°**ï¼šè¿™äº›åƒç´ é˜ˆå€¼æ˜¯ç»å¯¹å€¼ï¼Œä½†å®é™… ptâ†’px è½¬æ¢ä¾èµ– DPIã€‚å½“ç”¨æˆ·ä½¿ç”¨é 300 DPI æ—¶ï¼Œè¿™äº›é˜ˆå€¼çš„å®é™…æ•ˆæœä¼šå‘ç”Ÿå˜åŒ–ï¼š

| DPI | 80px å¯¹åº” pt | å®é™…æ•ˆæœ |
|-----|-------------|----------|
| 150 | ~38pt | é˜ˆå€¼è¿‡å®½æ¾ |
| 300 | ~19pt | é¢„æœŸæ•ˆæœ |
| 600 | ~10pt | é˜ˆå€¼è¿‡ä¸¥æ ¼ |

**å»ºè®®ä¿®å¤**ï¼š

```python
# æ ¹æ® DPI åŠ¨æ€è°ƒæ•´åƒç´ é˜ˆå€¼
def scale_px_threshold(px_at_300dpi: int, actual_dpi: int) -> int:
    return int(px_at_300dpi * actual_dpi / 300)

autocrop_min_height_px = scale_px_threshold(80, dpi)
```

---

### 10. æ–‡ä»¶åç¢°æ’å¤„ç†ç¼ºå¤±

```python
# ç¬¬ 2886-2887 è¡Œ
out_path = os.path.join(out_dir, base + ".png")
pix.save(out_path)  # ç›´æ¥è¦†ç›–ï¼Œæ— è­¦å‘Š
```

**é—®é¢˜æè¿°**ï¼šå¦‚æœä¸¤ä¸ªä¸åŒçš„å›¾æ³¨ç”Ÿæˆäº†ç›¸åŒçš„æ–‡ä»¶åï¼ˆsanitize åï¼‰ï¼Œåè€…ä¼š**é™é»˜è¦†ç›–**å‰è€…ã€‚

**å»ºè®®ä¿®å¤**ï¼š

```python
def get_unique_path(base_path: str) -> str:
    if not os.path.exists(base_path):
        return base_path
    stem, ext = os.path.splitext(base_path)
    counter = 1
    while os.path.exists(f"{stem}_{counter}{ext}"):
        counter += 1
    print(f"[WARN] Filename collision, using: {stem}_{counter}{ext}")
    return f"{stem}_{counter}{ext}"

out_path = get_unique_path(os.path.join(out_dir, base + ".png"))
```

---

## ğŸ“‹ é—®é¢˜ä¼˜å…ˆçº§æ±‡æ€»

| ä¼˜å…ˆçº§ | é—®é¢˜ | å»ºè®®ä¿®å¤ |
|--------|------|----------|
| ğŸ”´ P0 | ç¯å¢ƒå˜é‡æ±¡æŸ“ | ä½¿ç”¨ `os.environ[key] = value` å¼ºåˆ¶è¦†ç›– |
| ğŸ”´ P0 | ä¸¤è¡Œæ£€æµ‹è¯¯è£ | æ·»åŠ å¯¹å›¾æ³¨æ–‡æœ¬çš„æ’é™¤æ£€æŸ¥ |
| ğŸŸ  P1 | å…¨å±€é”šç‚¹å¾®å¼±ä¼˜åŠ¿ | å½“å·®è· < 5% æ—¶å›é€€æŒ‰é¡µå†³ç­– |
| ğŸŸ  P1 | è¡¨æ ¼/å›¾ç‰‡å‚æ•°ä¸ä¸€è‡´ | ç»Ÿä¸€æ–‡æ¡£è¯´æ˜æˆ–å‚æ•°å‘½å |
| ğŸŸ¡ P2 | å®½æ³›å¼‚å¸¸æ•è· | æ·»åŠ æ—¥å¿—è®°å½•æˆ–æ›´ç²¾ç¡®çš„å¼‚å¸¸ç±»å‹ |
| ğŸŸ¡ P2 | æ­£åˆ™è¡¨è¾¾å¼è¦†ç›–ä¸å…¨ | æ·»åŠ å¯¹å­å›¾æ ‡ç­¾å’Œä¸­æ–‡æ— ç©ºæ ¼çš„æ”¯æŒ |

---

## ğŸ”§ è°ƒè¯•å»ºè®®

å½“é‡åˆ°æå–é—®é¢˜æ—¶ï¼Œæ¨èä½¿ç”¨ä»¥ä¸‹è°ƒè¯•å‚æ•°ç»„åˆï¼š

### Windows/PowerShell

```powershell
python .\scripts\extract_pdf_assets.py `
    --pdf ".\paper.pdf" `
    --preset robust `
    --debug-captions `
    --debug-visual
```

### macOS/Linux

```bash
python3 scripts/extract_pdf_assets.py \
    --pdf "./paper.pdf" \
    --preset robust \
    --debug-captions \
    --debug-visual
```

### è°ƒè¯•è¾“å‡ºè¯´æ˜

è¿™ä¼šè¾“å‡ºï¼š
1. **Caption å€™é€‰è¯„åˆ†è¯¦æƒ…**ï¼ˆåŒºåˆ†çœŸå®å›¾æ³¨ vs æ­£æ–‡å¼•ç”¨ï¼‰
2. **å„è£åˆ‡é˜¶æ®µçš„å¯è§†åŒ–è¾¹ç•Œæ¡†**ï¼ˆ`images/debug/*.png`ï¼‰
3. **é˜¶æ®µè¯´æ˜æ–‡ä»¶**ï¼ˆ`images/debug/*_legend.txt`ï¼‰

### è¾¹ç•Œæ¡†é¢œè‰²æ–¹æ¡ˆ

| é˜¶æ®µ | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| Baseline (Anchor Selection) | ğŸ”µ è“è‰² | é”šç‚¹é€‰æ‹©é˜¶æ®µçš„åŸå§‹çª—å£ |
| Phase A (Text Trimming) | ğŸŸ¢ ç»¿è‰² | æ–‡æœ¬è£åˆ‡åçš„çª—å£ |
| Phase B (Object Alignment) | ğŸŸ  æ©™è‰² | å¯¹è±¡å¯¹é½åçš„çª—å£ |
| Phase D (Autocrop) | ğŸ”´ çº¢è‰² | è‡ªåŠ¨è£å‰ªåçš„æœ€ç»ˆçª—å£ |
| Fallback (Reverted) | ğŸŸ¡ é»„è‰² | éªŒæ”¶å¤±è´¥ï¼Œå›é€€åˆ°åŸºçº¿ |
| Caption | ğŸŸ£ ç´«è‰² | å›¾æ³¨ä½ç½® |

---

# ç¬¬äºŒéƒ¨åˆ†ï¼šUni-Parser è®ºæ–‡å·¥ä½œæµç¨‹åˆ†æ

> **è®ºæ–‡æ¥æº**ï¼šDP Technology, "Uni-Parser Technical Report", December 2025  
> **è®ºæ–‡é“¾æ¥**ï¼šhttps://uni-parser.github.io

## ä¸€ã€æ•´ä½“æ¶æ„æ¦‚è¿°

**Uni-Parser** æ˜¯ DP Technology å¼€å‘çš„å·¥ä¸šçº§å¤šæ¨¡æ€æ–‡æ¡£è§£æå¼•æ“ï¼Œé‡‡ç”¨**æ¨¡å—åŒ–ã€æ¾è€¦åˆçš„å¤šä¸“å®¶æ¶æ„**ï¼Œæ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ï¼š

> å°† PDF è½¬æ¢ä¸ºç»“æ„åŒ–ã€æœºå™¨å¯æ“ä½œçš„è¡¨ç¤ºï¼ˆJSON/Markdown/HTMLï¼‰ï¼Œä¾› LLM ä¸‹æ¸¸åº”ç”¨ä½¿ç”¨ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- **é«˜ååé‡**ï¼š8Ã—RTX 4090D å¯è¾¾ 20 é¡µ/ç§’
- **é«˜å‡†ç¡®æ€§**ï¼šé¢†åŸŸä¸“ç”¨çš„è½»é‡çº§ä¸“å®¶æ¨¡å‹
- **ä½æˆæœ¬**ï¼šæ”¯æŒå¤§è§„æ¨¡äº‘ç«¯éƒ¨ç½²ï¼Œå¤„ç†æ•°åäº¿é¡µé¢
- **å¯æ‰©å±•**ï¼šæ¾è€¦åˆæ¶æ„ï¼Œæ˜“äºæ·»åŠ æ–°æ¨¡æ€

### ç›®æ ‡åº”ç”¨åœºæ™¯

- æ–‡çŒ®æ£€ç´¢ä¸æ‘˜è¦
- åŒ–å­¦ç»“æ„æå–
- ååº”æ–¹æ¡ˆè¯†åˆ«
- ç”Ÿç‰©æ´»æ€§æ•°æ®æå–
- LLM è®­ç»ƒè¯­æ–™æ„å»º
- AI4Science æ¨¡å‹è®­ç»ƒæ•°æ®

---

## äºŒã€å®Œæ•´å·¥ä½œæµç¨‹ï¼ˆ5 å¤§ç»„ä»¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Uni-Parser Pipeline                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚   1.    â”‚    â”‚   2.    â”‚    â”‚   3.    â”‚    â”‚   4.    â”‚    â”‚   5.   â”‚â”‚
â”‚   â”‚  æ–‡æ¡£   â”‚â”€â”€â”€â–¶â”‚  ç‰ˆå¼   â”‚â”€â”€â”€â–¶â”‚ å¤šæ¨¡æ€  â”‚â”€â”€â”€â–¶â”‚  åå¤„ç†  â”‚â”€â”€â”€â–¶â”‚  è´¨é‡  â”‚â”‚
â”‚   â”‚ é¢„å¤„ç†  â”‚    â”‚  åˆ†æ   â”‚    â”‚  è§£æ   â”‚    â”‚         â”‚    â”‚  æ§åˆ¶  â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚        â”‚              â”‚              â”‚              â”‚              â”‚        â”‚
â”‚        â–¼              â–¼              â–¼              â–¼              â–¼        â”‚
â”‚   éªŒè¯/å…ƒæ•°æ®    é¡µé¢åˆ†å‰²      ä¸“å®¶æ¨¡å‹é›†æˆ    ç»“æ„é‡ç»„     å¼‚å¸¸æ£€æµ‹     â”‚
â”‚   åŠ å¯†æ£€æµ‹      é˜…è¯»é¡ºåº      Text/Formula    æ ¼å¼è½¬æ¢     ç½®ä¿¡åº¦è¯„ä¼°   â”‚
â”‚   æŸåæ£€æµ‹      åŒæ æ£€æµ‹      Table/Figure    å¼•ç”¨é“¾æ¥                  â”‚
â”‚                 åŒºåŸŸåˆ†ç±»      Chemical                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   ç»“æ„åŒ–è¾“å‡º              â”‚
                        â”‚   JSON / Markdown / HTML â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. Document Pre-Processingï¼ˆæ–‡æ¡£é¢„å¤„ç†ï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ–‡ä»¶éªŒè¯ | æ£€æŸ¥å®Œæ•´æ€§ã€åŠ å¯†çŠ¶æ€ |
| å…ƒæ•°æ®æå– | é¡µæ•°ã€å°ºå¯¸ã€æ–‡æœ¬å¯è®¿é—®æ€§ |
| æ–‡æœ¬å±‚æ£€æµ‹ | åˆ¤æ–­æ˜¯å¦æœ‰åµŒå…¥æ–‡æœ¬å±‚ï¼Œæ ‡è®°"ä¸å¯æå–"æ–‡æ¡£ |
| å¼‚å¸¸å¤„ç† | æŸå/ä¹±ç æ–‡æœ¬çš„æ—©æœŸæ£€æµ‹ |

### 2. Layout Analysisï¼ˆç‰ˆå¼åˆ†æï¼‰

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| é¡µé¢åˆ†å‰² | è¯†åˆ«æ–‡æœ¬åŒºã€å›¾è¡¨åŒºã€è¡¨æ ¼åŒºã€å…¬å¼åŒº |
| é˜…è¯»é¡ºåº | ä¸“é—¨é’ˆå¯¹ç§‘å­¦æ–‡çŒ®çš„é˜…è¯»é¡ºåºç®—æ³• |
| åŒæ æ£€æµ‹ | å¤„ç†å¤æ‚çš„å¤šæ å¸ƒå±€ |
| åŒºåŸŸåˆ†ç±» | ä¸ºæ¯ä¸ªåŒºåŸŸæ‰“æ ‡ç­¾ï¼ˆtext/figure/table/formula/chemï¼‰ |

### 3. Multi-modal Parsingï¼ˆå¤šæ¨¡æ€è§£æï¼‰- æ ¸å¿ƒ

è®ºæ–‡é‡‡ç”¨**ä¸“å®¶æ¨¡å‹é›†æˆ**çš„æ–¹å¼ï¼Œæ¯ç§æ¨¡æ€ä½¿ç”¨ä¸“é—¨çš„è½»é‡çº§æ¨¡å‹ï¼š

| æ¨¡æ€ | ä¸“å®¶æ¨¡å‹ | è¾“å‡ºæ ¼å¼ | ç‰¹ç‚¹ |
|------|----------|----------|------|
| ğŸ“ Text | TextParser | Plain/Markdown | ä¿æŒæ ¼å¼ã€å¤„ç†æ–­è¡Œ |
| ğŸ“ Formula | FormulaParser | LaTeX | è¡Œå†…/è¡Œé—´å…¬å¼ |
| ğŸ“Š Table | TableParser | HTML/JSON | ç»“æ„åŒ–è¡¨æ ¼è¯†åˆ« |
| ğŸ–¼ï¸ Figure | FigureParser | PNG + Caption | å›¾è¡¨æå– + Caption å…³è” |
| âš—ï¸ Chemical | MolParser-1.5 | SMILES | åŒ–å­¦ç»“æ„è¯†åˆ« |

**å…³é”®è®¾è®¡**ï¼š
- **åŠ¨æ€æ¨¡å—ç¼–æ’**ï¼šæ ¹æ®é¡µé¢å†…å®¹æŒ‰éœ€è°ƒç”¨ä¸“å®¶æ¨¡å‹
- **è·¨æ¨¡æ€å¯¹é½**ï¼šä¿æŒæ–‡æœ¬-å›¾è¡¨-å…¬å¼çš„å¼•ç”¨å…³ç³»
- **å¹¶è¡Œå¤„ç†**ï¼šä¸åŒæ¨¡æ€å¯å¹¶è¡Œæ¨ç†

### 4. Post-Processingï¼ˆåå¤„ç†ï¼‰

- **ç»“æ„é‡ç»„**ï¼šå°†è§£æç»“æœç»„è£…ä¸ºå±‚æ¬¡åŒ–æ–‡æ¡£
- **æ ¼å¼è½¬æ¢**ï¼šè¾“å‡º JSON / Markdown / HTML
- **å¼•ç”¨é“¾æ¥**ï¼šå»ºç«‹å›¾è¡¨-æ–‡æœ¬çš„äº¤å‰å¼•ç”¨
- **æ¸…æ´—å»å™ª**ï¼šç§»é™¤é¡µçœ‰é¡µè„šç­‰å¹²æ‰°å†…å®¹

### 5. Quality Controlï¼ˆè´¨é‡æ§åˆ¶ï¼‰

- **è§£æç»“æœéªŒè¯**ï¼šæ£€æŸ¥è¾“å‡ºå®Œæ•´æ€§
- **å¼‚å¸¸æ£€æµ‹ä¸æ ‡è®°**ï¼šæ ‡è®°ä½ç½®ä¿¡åº¦åŒºåŸŸ
- **ç½®ä¿¡åº¦è¯„ä¼°**ï¼šä¸ºæ¯ä¸ªè§£æç»“æœæ‰“åˆ†

---

## ä¸‰ã€å…³é”®æŠ€æœ¯åˆ›æ–°

| åˆ›æ–°ç‚¹ | è¯¦ç»†è¯´æ˜ |
|--------|----------|
| **åˆ†å¸ƒå¼å¾®æœåŠ¡** | 8Ã—RTX 4090D å¯è¾¾ 20 é¡µ/ç§’ |
| **åŠ¨æ€ GPU è´Ÿè½½å‡è¡¡** | æ ¹æ®æ¨¡æ€å¤æ‚åº¦åˆ†é…ç®—åŠ› |
| **é¢†åŸŸä¸“ç”¨ä¸“å®¶æ¨¡å‹** | æ¯ç§æ¨¡æ€ä½¿ç”¨é’ˆå¯¹æ€§ä¼˜åŒ–çš„å°æ¨¡å‹ |
| **æ¾è€¦åˆæ¶æ„** | æ¨¡å—å¯ç‹¬ç«‹å‡çº§ã€æ‰©å±•æ–°æ¨¡æ€ |
| **å¯é…ç½®æ¨¡å¼** | æ”¯æŒå…¨é‡è§£æ or å•æ¨¡æ€æå– |
| **ç§‘å­¦æ–‡çŒ®ç‰¹åŒ–** | é’ˆå¯¹è®ºæ–‡/ä¸“åˆ©çš„é˜…è¯»é¡ºåºç®—æ³• |

---

# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¯¹æ ‡åˆ†æä¸æ”¹è¿›å»ºè®®

## æ¶æ„å¯¹æ¯”è¡¨

| ç»´åº¦ | Uni-Parser | æˆ‘ä»¬çš„é¡¹ç›® |
|------|------------|------------|
| **å®šä½** | å·¥ä¸šçº§å¤šæ¨¡æ€è§£æå¹³å° | å­¦æœ¯è®ºæ–‡å›¾è¡¨æå– + æ‘˜è¦ç”Ÿæˆ |
| **æ ¸å¿ƒæ–¹æ³•** | å¤šä¸“å®¶æ¨¡å‹é›†æˆ + ç‰ˆå¼é©±åŠ¨ | Caption é©±åŠ¨ + å¯å‘å¼è£å‰ª |
| **æ¨¡æ€è¦†ç›–** | æ–‡æœ¬/å…¬å¼/è¡¨æ ¼/å›¾è¡¨/åŒ–å­¦ç»“æ„ | æ–‡æœ¬/å›¾è¡¨/è¡¨æ ¼ |
| **ç‰ˆå¼åˆ†æ** | ç‹¬ç«‹çš„ç‰ˆå¼åˆ†æé˜¶æ®µ | å¯é€‰ï¼ˆ`--layout-driven`ï¼‰ |
| **è´¨é‡æ§åˆ¶** | ç‹¬ç«‹çš„ QC é˜¶æ®µ | éªŒæ”¶é—¨æ§› + å›é€€æœºåˆ¶ |
| **éƒ¨ç½²æ¨¡å¼** | åˆ†å¸ƒå¼äº‘ç«¯ | å•æœºæœ¬åœ°è„šæœ¬ |
| **å¤„ç†é€Ÿåº¦** | 20 é¡µ/ç§’ï¼ˆ8Ã—GPUï¼‰ | çº¦ 1-2 é¡µ/ç§’ï¼ˆå•æ ¸ CPUï¼‰ |
| **ä¾èµ–** | PyTorch + å¤šä¸ªä¸“å®¶æ¨¡å‹ | PyMuPDF + pdfminer.six |

---

## âœ… å¯å€Ÿé‰´çš„è®¾è®¡æ€è·¯

### 1. å¼ºåŒ–ç‰ˆå¼åˆ†æé˜¶æ®µï¼ˆé«˜ä»·å€¼ï¼‰â­â­â­

**Uni-Parser åšæ³•**ï¼šå°†ç‰ˆå¼åˆ†æä½œä¸º**ç‹¬ç«‹çš„é¢„å¤„ç†é˜¶æ®µ**ï¼Œå…ˆè¯†åˆ«é¡µé¢ç»“æ„ï¼Œå†è¿›è¡Œæ¨¡æ€è§£æã€‚

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼šç‰ˆå¼åˆ†ææ˜¯å¯é€‰çš„ï¼ˆ`--layout-driven`ï¼‰ï¼Œä¸”ä¸æå–æµç¨‹è€¦åˆã€‚

**å»ºè®®æ”¹è¿›**ï¼š

```
å½“å‰æµç¨‹:  PDF â†’ Captionæ£€æµ‹ â†’ è£å‰ª â†’ ç²¾è£ â†’ è¾“å‡º
                    â†“
å»ºè®®æµç¨‹:  PDF â†’ ç‰ˆå¼é¢„åˆ†æ â†’ Captionæ£€æµ‹(åˆ©ç”¨ç‰ˆå¼) â†’ è£å‰ª â†’ ç²¾è£ â†’ è¾“å‡º
                    â†“
            [é¡µé¢åŒºåŸŸåˆ†ç±»]
            [é˜…è¯»é¡ºåºç¡®å®š]
            [åŒæ è¾¹ç•Œæ£€æµ‹]
```

**å…·ä½“æ”¹è¿›ç‚¹**ï¼š
1. å°† `--layout-driven` ä»å¯é€‰æ”¹ä¸ºé»˜è®¤å¯ç”¨
2. ç‰ˆå¼åˆ†æç»“æœç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
3. åˆ©ç”¨ç‰ˆå¼ä¿¡æ¯è¾…åŠ© Caption æ£€æµ‹ï¼ˆæ’é™¤æ­£æ–‡åŒºåŸŸçš„"å‡å›¾æ³¨"ï¼‰

**é¢„æœŸæ”¶ç›Š**ï¼š
- å‡å°‘"æ­£æ–‡æ··å…¥å›¾è¡¨"çš„é—®é¢˜
- æ›´å‡†ç¡®çš„å›¾è¡¨è¾¹ç•Œåˆ¤å®š
- è‡ªåŠ¨é€‚åº”å•æ /åŒæ å¸ƒå±€

---

### 2. å¼•å…¥"æ¨¡æ€ä¸“å®¶"çš„æ€æƒ³ï¼ˆä¸­ç­‰ä»·å€¼ï¼‰â­â­

**Uni-Parser åšæ³•**ï¼šTable/Figure/Formula å„æœ‰ä¸“é—¨çš„è§£æå™¨ã€‚

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼šTable å’Œ Figure ä½¿ç”¨ç±»ä¼¼çš„è£å‰ªé€»è¾‘ï¼Œåªæ˜¯å‚æ•°ä¸åŒã€‚

**å»ºè®®æ”¹è¿›**ï¼š

```python
# è¡¨æ ¼ä¸“å®¶ï¼ˆå¢å¼ºï¼‰
class TableExpert:
    """è¡¨æ ¼ç‰¹åŒ–å¤„ç†å™¨"""
    
    def detect_grid_lines(self, clip, page):
        """æ£€æµ‹è¡¨æ ¼ç½‘æ ¼çº¿"""
        ...
    
    def detect_column_alignment(self, clip, page):
        """æ£€æµ‹åˆ—å¯¹é½"""
        ...
    
    def refine_table_boundary(self, clip, page):
        """åŸºäºç½‘æ ¼çº¿ç²¾è°ƒè¾¹ç•Œ"""
        ...

# å›¾è¡¨ä¸“å®¶ï¼ˆå¢å¼ºï¼‰
class FigureExpert:
    """å›¾è¡¨ç‰¹åŒ–å¤„ç†å™¨"""
    
    def detect_subfigures(self, clip, page):
        """æ£€æµ‹å­å›¾ (a), (b), (c)..."""
        ...
    
    def detect_axes(self, clip, page):
        """æ£€æµ‹åæ ‡è½´ï¼ˆé˜²æ­¢è£æ‰ï¼‰"""
        ...
    
    def estimate_figure_type(self, clip, page):
        """ä¼°è®¡å›¾è¡¨ç±»å‹ï¼šæŠ˜çº¿å›¾/æŸ±çŠ¶å›¾/æ•£ç‚¹å›¾/ç¤ºæ„å›¾"""
        ...
```

---

### 3. å¢åŠ é¢„å¤„ç†éªŒè¯é˜¶æ®µï¼ˆä¸­ç­‰ä»·å€¼ï¼‰â­â­

**Uni-Parser åšæ³•**ï¼š
- æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
- æ£€æµ‹æ˜¯å¦æœ‰åµŒå…¥æ–‡æœ¬å±‚
- æ ‡è®°"ä¸å¯æå–"æ–‡æ¡£

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼šç›´æ¥å°è¯•æå–ï¼Œå¤±è´¥æ—¶æ‰æŠ¥é”™ã€‚

**å»ºè®®æ”¹è¿›**ï¼š

```python
@dataclass
class PDFValidationResult:
    """PDF é¢„éªŒè¯ç»“æœ"""
    is_valid: bool
    page_count: int
    has_text_layer: bool
    text_layer_ratio: float  # 0.0 ~ 1.0
    is_encrypted: bool
    warnings: List[str]
    errors: List[str]

def pre_validate_pdf(pdf_path: str) -> PDFValidationResult:
    """é¢„éªŒè¯ PDF æ–‡ä»¶"""
    doc = fitz.open(pdf_path)
    result = PDFValidationResult(
        is_valid=True,
        page_count=len(doc),
        has_text_layer=False,
        text_layer_ratio=0.0,
        is_encrypted=doc.is_encrypted,
        warnings=[],
        errors=[]
    )
    
    # 1. æ£€æŸ¥é¡µæ•°
    if result.page_count == 0:
        result.is_valid = False
        result.errors.append("Empty PDF (0 pages)")
        return result
    
    # 2. æ£€æŸ¥åŠ å¯†
    if result.is_encrypted:
        result.is_valid = False
        result.errors.append("PDF is encrypted")
        return result
    
    # 3. æ£€æµ‹æ–‡æœ¬å±‚
    text_pages = 0
    for pno in range(min(5, result.page_count)):  # é‡‡æ ·å‰5é¡µ
        page = doc[pno]
        text = page.get_text("text")
        if len(text.strip()) > 100:
            text_pages += 1
    
    result.text_layer_ratio = text_pages / min(5, result.page_count)
    result.has_text_layer = result.text_layer_ratio > 0.5
    
    if not result.has_text_layer:
        result.warnings.append(
            f"PDF may be image-only (text ratio: {result.text_layer_ratio:.1%}). "
            "OCR may be needed for accurate extraction."
        )
    
    return result
```

---

### 4. è´¨é‡æ§åˆ¶ç‹¬ç«‹åŒ–ï¼ˆä¸­ç­‰ä»·å€¼ï¼‰â­â­

**Uni-Parser åšæ³•**ï¼šQC æ˜¯ç‹¬ç«‹é˜¶æ®µï¼Œæ£€æµ‹è§£æç»“æœçš„å¼‚å¸¸ã€‚

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼šéªŒæ”¶é€»è¾‘åˆ†æ•£åœ¨å„ç²¾è£é˜¶æ®µå†…ã€‚

**å»ºè®®æ”¹è¿›**ï¼š

```python
@dataclass
class QualityIssue:
    """è´¨é‡é—®é¢˜"""
    severity: str  # 'error' | 'warning' | 'info'
    record: AttachmentRecord
    message: str

def quality_check(records: List[AttachmentRecord], pdf_path: str) -> List[QualityIssue]:
    """ç‹¬ç«‹çš„è´¨é‡æ£€æŸ¥é˜¶æ®µ"""
    issues: List[QualityIssue] = []
    
    # 1. æ£€æŸ¥æå–æ•°é‡ä¸æ–‡æœ¬ä¸­å¼•ç”¨çš„ä¸€è‡´æ€§
    doc = fitz.open(pdf_path)
    expected_figures = count_figure_references_in_text(doc)
    actual_figures = len([r for r in records if r.kind == 'figure'])
    
    if abs(expected_figures - actual_figures) > 2:
        issues.append(QualityIssue(
            severity='warning',
            record=None,
            message=f"Figure count mismatch: text references ~{expected_figures}, extracted {actual_figures}"
        ))
    
    # 2. æ£€æŸ¥å›¾åƒå°ºå¯¸åˆç†æ€§
    for r in records:
        # è¯»å–å›¾åƒå°ºå¯¸
        from PIL import Image
        img = Image.open(r.out_path)
        width, height = img.size
        
        if width < 100 or height < 100:
            issues.append(QualityIssue(
                severity='warning',
                record=r,
                message=f"Image too small: {width}x{height}px"
            ))
        
        if width > 5000 or height > 5000:
            issues.append(QualityIssue(
                severity='info',
                record=r,
                message=f"Image unusually large: {width}x{height}px"
            ))
    
    # 3. æ£€æŸ¥æ˜¯å¦æœ‰ç¼–å·è·³è·ƒ
    figure_nums = sorted([r.num_key() for r in records if r.kind == 'figure'])
    for i in range(1, len(figure_nums)):
        if figure_nums[i] - figure_nums[i-1] > 1:
            issues.append(QualityIssue(
                severity='warning',
                record=None,
                message=f"Missing figure(s) between {figure_nums[i-1]} and {figure_nums[i]}"
            ))
    
    # 4. æ£€æŸ¥ç»­é¡µå®Œæ•´æ€§
    continued_records = [r for r in records if r.continued]
    for r in continued_records:
        # æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„é¦–é¡µ
        first_page = [x for x in records if x.ident == r.ident and not x.continued]
        if not first_page:
            issues.append(QualityIssue(
                severity='error',
                record=r,
                message=f"Continued {r.kind} {r.ident} has no first page"
            ))
    
    return issues
```

---

### 5. ç»“æ„åŒ–è¾“å‡ºæ ¼å¼æ‰©å±•ï¼ˆä½ä¼˜å…ˆçº§ï¼‰â­

**Uni-Parser åšæ³•**ï¼šè¾“å‡ºå±‚æ¬¡åŒ– JSONï¼ŒåŒ…å«å®Œæ•´çš„æ–‡æ¡£ç»“æ„ã€‚

**æˆ‘ä»¬çš„ç°çŠ¶**ï¼š`index.json` åªè®°å½•å›¾è¡¨åˆ—è¡¨ã€‚

**å»ºè®®æ”¹è¿›**ï¼š

```json
{
  "version": "1.0",
  "meta": {
    "pdf": "paper.pdf",
    "pdf_hash": "sha256:abc123...",
    "pages": 12,
    "extracted_at": "2025-12-21T10:30:00Z",
    "extractor_version": "2.0.0",
    "preset": "robust"
  },
  "validation": {
    "has_text_layer": true,
    "text_layer_ratio": 0.95,
    "is_encrypted": false
  },
  "layout": {
    "columns": 2,
    "typical_line_height": 11.2,
    "typical_font_size": 10.0
  },
  "figures": [
    {
      "type": "figure",
      "id": "1",
      "page": 3,
      "caption": "Figure 1: System architecture...",
      "file": "Figure_1_System_Architecture.png",
      "continued": false,
      "bbox": [72.0, 150.0, 540.0, 400.0],
      "extraction_method": "anchor_v2",
      "confidence": 0.92
    }
  ],
  "tables": [...],
  "quality_issues": [
    {
      "severity": "warning",
      "target": "figure_3",
      "message": "Image smaller than expected"
    }
  ],
  "text_file": "text/paper.txt"
}
```

---

## âš ï¸ ä¸é€‚åˆç›´æ¥å€Ÿé‰´çš„éƒ¨åˆ†

| ç‰¹æ€§ | åŸå›  |
|------|------|
| **åˆ†å¸ƒå¼å¾®æœåŠ¡** | æˆ‘ä»¬æ˜¯å•æœºæœ¬åœ°è„šæœ¬ï¼Œä¸éœ€è¦åˆ†å¸ƒå¼éƒ¨ç½² |
| **GPU è´Ÿè½½å‡è¡¡** | æˆ‘ä»¬ä½¿ç”¨ PyMuPDF æ¸²æŸ“ï¼Œä¸æ¶‰åŠ GPU æ¨ç† |
| **åŒ–å­¦ç»“æ„è¯†åˆ«** | è¶…å‡ºå½“å‰é¡¹ç›®èŒƒå›´ï¼ˆå¯ä½œä¸ºæœªæ¥æ‰©å±•ï¼‰ |
| **å…¬å¼ LaTeX è½¬æ¢** | è¶…å‡ºå½“å‰é¡¹ç›®èŒƒå›´ï¼ˆå¯ä½œä¸ºæœªæ¥æ‰©å±•ï¼‰ |
| **å¤šæ¨¡å‹æ¨ç†** | æˆ‘ä»¬çš„è½»é‡çº§å®šä½ä¸é€‚åˆå¼•å…¥å¤§é‡æ·±åº¦å­¦ä¹ æ¨¡å‹ |

---

## ğŸ“‹ æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | é¢„æœŸæ”¶ç›Š | å·¥ä½œé‡ | é£é™© |
|--------|--------|----------|--------|------|
| ğŸ”´ P0 | å¼ºåŒ–ç‰ˆå¼åˆ†æï¼ˆé»˜è®¤å¯ç”¨ï¼‰ | å‡å°‘æ­£æ–‡æ··å…¥ï¼Œæé«˜è£å‰ªç²¾åº¦ | ä¸­ | ä½ |
| ğŸ”´ P0 | ä¿®å¤ç¯å¢ƒå˜é‡æ±¡æŸ“é—®é¢˜ | é¿å…æ„å¤–è¡Œä¸º | ä½ | ä½ |
| ğŸ”´ P0 | ä¿®å¤ä¸¤è¡Œæ£€æµ‹è¯¯è£é—®é¢˜ | é¿å…è£æ‰å›¾æ³¨ | ä½ | ä½ |
| ğŸŸ  P1 | å¢åŠ  PDF é¢„éªŒè¯é˜¶æ®µ | æå‰å‘ç°é—®é¢˜æ–‡æ¡£ | ä½ | ä½ |
| ğŸŸ  P1 | QC é˜¶æ®µç‹¬ç«‹åŒ– | ç»Ÿä¸€è´¨é‡æ£€æŸ¥ï¼Œä¾¿äºè°ƒè¯• | ä¸­ | ä½ |
| ğŸŸ  P1 | å…¨å±€é”šç‚¹å¾®å¼±ä¼˜åŠ¿å›é€€ | æé«˜å¤æ‚æ–‡æ¡£å¤„ç†æˆåŠŸç‡ | ä½ | ä½ |
| ğŸŸ¡ P2 | è¡¨æ ¼/å›¾è¡¨ä¸“å®¶åˆ†ç¦» | æ›´ç²¾å‡†çš„æ¨¡æ€å¤„ç† | ä¸­ | ä¸­ |
| ğŸŸ¡ P2 | æ­£åˆ™è¡¨è¾¾å¼è¦†ç›–æ‰©å±• | æ”¯æŒæ›´å¤šå›¾æ³¨æ ¼å¼ | ä½ | ä½ |
| ğŸŸ¢ P3 | æ‰©å±• index.json æ ¼å¼ | æ›´ä¸°å¯Œçš„å…ƒæ•°æ® | ä½ | ä½ |
| ğŸŸ¢ P3 | DPI è‡ªé€‚åº”åƒç´ é˜ˆå€¼ | æ”¯æŒä¸åŒ DPI è®¾ç½® | ä½ | ä½ |

---

# ğŸ¯ æ€»ç»“

## æ ¸å¿ƒå‘ç°

**Uni-Parser** çš„æ ¸å¿ƒæ€æƒ³æ˜¯**"å…ˆç†è§£ç»“æ„ï¼Œå†æå–å†…å®¹"**ï¼Œè¿™ä¸æˆ‘ä»¬ç›®å‰çš„**"Caption é©±åŠ¨æå–"**æœ‰æœ¬è´¨åŒºåˆ«ï¼š

| æ€è·¯ | Uni-Parser | æˆ‘ä»¬çš„é¡¹ç›® |
|------|------------|------------|
| æ ¸å¿ƒç­–ç•¥ | ç‰ˆå¼é©±åŠ¨ | Caption é©±åŠ¨ |
| å¤„ç†é¡ºåº | ç»“æ„ â†’ å†…å®¹ | å†…å®¹ â†’ ç»“æ„ |
| è¾¹ç•Œåˆ¤å®š | ç‰ˆå¼åŒºåŸŸè¾¹ç•Œ | å¯å‘å¼è£å‰ª + éªŒæ”¶ |
| é€‚ç”¨åœºæ™¯ | é€šç”¨ç§‘å­¦æ–‡çŒ® | è§„èŒƒæ ¼å¼è®ºæ–‡ |

## æœ€å€¼å¾—å€Ÿé‰´çš„ 3 ç‚¹

1. **ç‰ˆå¼åˆ†æå‰ç½®**ï¼šå°† `--layout-driven` ä»å¯é€‰å˜ä¸ºé»˜è®¤ï¼Œæˆ–è‡³å°‘å¢å¼ºå…¶ä¼˜å…ˆçº§
2. **é¢„å¤„ç†éªŒè¯**ï¼šåœ¨æå–å‰æ£€æµ‹æ½œåœ¨é—®é¢˜ï¼Œé¿å…æ— æ•ˆå·¥ä½œ
3. **è´¨é‡æ§åˆ¶ç‹¬ç«‹åŒ–**ï¼šå°†åˆ†æ•£çš„éªŒæ”¶é€»è¾‘æ•´åˆä¸ºç‹¬ç«‹é˜¶æ®µ

## ä¿æŒçš„ä¼˜åŠ¿

è¿™äº›æ”¹è¿›å¯ä»¥è®©æˆ‘ä»¬çš„æµç¨‹æ›´åŠ **é²æ£’**å’Œ**å¯ç»´æŠ¤**ï¼ŒåŒæ—¶ä¿æŒä»¥ä¸‹å®šä½ä¼˜åŠ¿ï¼š

- âœ… **è½»é‡çº§**ï¼šæ— éœ€ GPUï¼Œæ— éœ€å¤§å‹æ¨¡å‹
- âœ… **å•æœºéƒ¨ç½²**ï¼špip install å³å¯ä½¿ç”¨
- âœ… **ä½ä¾èµ–**ï¼šä»…éœ€ PyMuPDF + pdfminer.six
- âœ… **é«˜åº¦å¯é…ç½®**ï¼šä¸°å¯Œçš„å‚æ•°æ”¯æŒå„ç§åœºæ™¯
- âœ… **é€æ˜å¯è°ƒè¯•**ï¼š`--debug-visual` å¯è§†åŒ–å„é˜¶æ®µ

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **çŸ­æœŸï¼ˆ1å‘¨å†…ï¼‰**ï¼š
   - ä¿®å¤ P0 çº§åˆ«çš„ç¯å¢ƒå˜é‡å’Œä¸¤è¡Œæ£€æµ‹é—®é¢˜
   - æ·»åŠ  PDF é¢„éªŒè¯å‡½æ•°

2. **ä¸­æœŸï¼ˆ2-4å‘¨ï¼‰**ï¼š
   - å°†ç‰ˆå¼åˆ†æè®¾ä¸ºé»˜è®¤å¯ç”¨
   - æŠ½å–ç‹¬ç«‹çš„ QC æ¨¡å—

3. **é•¿æœŸï¼ˆè§„åˆ’ä¸­ï¼‰**ï¼š
   - è¯„ä¼°è¡¨æ ¼/å›¾è¡¨ä¸“å®¶åˆ†ç¦»çš„å¯è¡Œæ€§
   - è€ƒè™‘æ‰©å±• index.json æ ¼å¼

---

*æ–‡æ¡£ç»“æŸ*

