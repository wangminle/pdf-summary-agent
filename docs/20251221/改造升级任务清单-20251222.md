# pdf-summary-agent 改造升级任务清单

> **文档日期**：2025-12-22  
> **基于**：Uni-Parser 论文启发 + 代码审查分析 + 现有问题汇总  
> **目标**：系统性改造提取脚本，提升稳健性、可维护性和结构化程度

---

## 目录

- [总览：优先级分布](#总览优先级分布)
- [P0 紧急修复](#p0-紧急修复必须在下一版本完成)
- [P1 显著提升](#p1-显著提升核心稳健性与结构化)
- [P2 长期演进](#p2-长期演进架构升级)
- [QA 质量保证](#qa-质量保证贯穿全流程)
- [实施建议](#实施建议)

---

## 总览：优先级分布

| 优先级 | 任务数 | 预期工作量 | 核心目标 |
|--------|--------|------------|----------|
| 🔴 **P0** | 7 项 | 1-2 周 | 修复会导致错配/错截/不可复现的 bug |
| 🟠 **P1** | 11 项 | 2-5 周 | 提升稳健性、结构化程度、可追溯性，并对齐“标准化解读文档”产物 |
| 🟡 **P2** | 5 项 | 规划中 | 架构演进、能力扩展、接近 Uni-Parser |
| 🟢 **QA** | 5 项 | 持续 | 测试、日志、调试、可维护性 |

---

## P0 紧急修复（必须在下一版本完成）

### P0-01 ✅ 修复环境变量污染问题 [已完成 2025-12-22]

**问题描述**：  
`os.environ.setdefault()` 不会覆盖已存在的环境变量值。如果用户 shell 中预设了 `EXTRACT_ANCHOR_MODE` 等变量，CLI 参数将被**静默忽略**。

**代码位置**：`main()` 函数，约第 5094-5106 行

**影响**：
- 用户以为用了某参数，实际被忽略
- 跨运行不可复现
- 调试困难

**修复方案**：
```python
# 方案 A（推荐）：强制覆盖
os.environ['EXTRACT_ANCHOR_MODE'] = args.anchor_mode or 'v2'

# 方案 B：在脚本开头清理相关变量
MANAGED_ENV_VARS = ['EXTRACT_ANCHOR_MODE', 'GLOBAL_ANCHOR', 'SCAN_HEIGHTS', ...]
for var in MANAGED_ENV_VARS:
    os.environ.pop(var, None)
```

**验收标准**：
- [ ] CLI 参数始终优先于环境变量
- [ ] 日志中打印最终生效的关键参数值
- [ ] 单元测试覆盖参数优先级

---

### P0-02 ✅ 修复"两行检测"误裁图注本身 [已完成 2025-12-22]

**问题描述**：  
`_trim_clip_head_by_text_v2` 中，如果图注本身恰好是两行（长标题换行），可能被误判为"多余文字"而被裁掉。

**代码位置**：约第 852-886 行

**影响**：
- 图注被裁掉
- 输出图片缺失标题信息

**修复方案**：
```python
def is_caption_text(lines, caption_rect, tolerance=10.0):
    """检查文本行是否属于图注"""
    for line in lines:
        if abs(line.y0 - caption_rect.y0) < tolerance:
            return True
    return False

# 在 Phase A+ 中
if is_exact_two and len(matched_lines) == 2:
    if not is_caption_text(matched_lines, caption_rect):
        # 执行裁切
        ...
```

**验收标准**：
- [ ] 长标题图注（2行）不被裁掉
- [ ] 正文开头的两行文字仍被正确裁掉
- [ ] 添加测试用例覆盖此场景

---

### P0-03 ✅ 修复 Supplementary 编号解析冲突 [已完成 2025-12-22]

**问题描述**：  
`Supplementary Figure S1` 可能被解析成 `id=1`，与 `Figure 1` 冲突；表格同理。

**影响**：
- index.json 中编号混淆
- 文件被覆盖
- `--below S1` 等控制项无法命中

**修复方案**：
```python
# 保留完整标识符
# Figure S1 → ident="S1", kind="figure"
# Table S2 → ident="S2", kind="table"
# Figure 1 → ident="1", kind="figure"

# 更新正则表达式
figure_line_re = re.compile(
    r"^\s*(?:Extended\s+Data\s+Figure|Supplementary\s+Figure|Figure|Fig\.?|图表|附图|图)\s*"
    r"(?:(S)\s*)?(\d+|[IVX]+)"  # 分组捕获 S 前缀
    r"(?:\s*[A-Za-z]|\s*\([A-Za-z]\))?"  # 支持子图标签
    ...
)
```

**验收标准**：
- [ ] `Figure S1` 和 `Figure 1` 在 index 中不冲突
- [ ] `--above S1`、`--below S2` 等参数可正确命中
- [ ] 文件名保留完整标识（如 `Figure_S1_*.png`）

---

### P0-04 ✅ 让 Anchor v2 支持强制方向 `--above/--below` [已完成 2025-12-22]

**问题描述**：  
当前强制方向只在 `anchor_mode == v1` 生效；v2 会忽略 `--above/--below` 参数。

**代码位置**：`anchor_v2_scan()` 及相关调用

**影响**：
- 用户以为已强制方向，实际仍错截
- AGENTS.md 文档与实际行为不一致

**修复方案**：
```python
def anchor_v2_scan(..., force_above_ids=None, force_below_ids=None):
    """
    在候选生成阶段，根据强制列表限制扫描方向
    """
    if current_id in force_above_ids:
        # 只扫描 above 方向
        scan_directions = ['above']
    elif current_id in force_below_ids:
        scan_directions = ['below']
    else:
        scan_directions = ['above', 'below']
    ...
```

**验收标准**：
- [ ] v2 模式下 `--above 2` 只扫描上方
- [ ] v2 模式下 `--below 3` 只扫描下方
- [ ] index.json 记录选择原因（`forced_direction: above`）

---

### P0-05 ✅ 修复表格 `text_trim` 永远开启的问题 [已完成 2025-12-22]

**问题描述**：  
代码中 `extract_tables(..., text_trim=True if args.text_trim else True)` 等价于永远 True。

**代码位置**：`main()` 中调用 `extract_tables()` 处

**影响**：
- 无法关闭表格的文本裁切
- 某些特殊 PDF 无法正确处理

**修复方案**：
```python
# 原代码（有问题）
text_trim=True if args.text_trim else True

# 修复后
text_trim=args.text_trim  # 直接使用参数值
```

**验收标准**：
- [ ] `--no-text-trim` 能真正关闭表格文本裁切
- [ ] robust preset 仍默认开启 text_trim

---

### P0-06 ✅ 输出隔离：避免旧 PNG 混入新结果 [已完成 2025-12-22]

**问题描述**：  
默认不会清理 `images/`，历史文件会混入"全量喂给模型"的集合。

**影响**：
- 大模型读到过期图片
- index.json 与实际文件不一致
- 调试困难

**修复方案**：
```python
# 方案 A（推荐）：默认启用 --prune-images
# 清理 out-dir 中未被 index.json 引用的旧 Figure_/Table_ PNG

# 方案 B：输出到带时间戳的目录
# images/run-20251222-103000/

# 方案 C：在 index 中记录元数据
{
  "run_id": "20251222-103000",
  "generated_at": "2025-12-22T10:30:00Z",
  "figures": [...]
}
```

**验收标准**：
- [ ] 提供稳定的隔离策略（任选一种）
- [ ] index.json 与实际 PNG 文件始终一致
- [ ] 文档说明清理/隔离策略

---

### P0-07 ✅ 文件名碰撞处理 [已完成 2025-12-22]

**问题描述**：  
如果两个不同的图注 sanitize 后生成相同文件名，后者会静默覆盖前者。

**代码位置**：约第 2886-2887 行

**修复方案**：
```python
def get_unique_path(base_path: str) -> str:
    if not os.path.exists(base_path):
        return base_path
    stem, ext = os.path.splitext(base_path)
    counter = 1
    while os.path.exists(f"{stem}_{counter}{ext}"):
        counter += 1
    print(f"[WARN] Filename collision, using: {stem}_{counter}{ext}")
    return f"{stem}_{counter}{ext}"
```

**验收标准**：
- [ ] 同名文件自动追加后缀（`_1`、`_2`）
- [ ] 日志警告碰撞情况
- [ ] index.json 记录实际使用的文件名

---

## P1 显著提升（核心稳健性与结构化）

### P1-01 ⭐ 强化版式分析阶段（默认启用）

**目标**：借鉴 Uni-Parser "先理解结构，再提取内容" 的思想

**当前状态**：`--layout-driven` 是可选的

**改进方案**：
```
当前流程:  PDF → Caption检测 → 裁剪 → 精裁 → 输出
                    ↓
建议流程:  PDF → 版式预分析 → Caption检测(利用版式) → 裁剪 → 精裁 → 输出
                    ↓
            [页面区域分类]
            [阅读顺序确定]
            [双栏边界检测]
```

**具体改进点**：
- [ ] 将 `--layout-driven` 从可选改为默认**自动**启用（建议：`auto|on|off` 三态；默认 `auto`）
- [ ] `auto` 策略：检测到双栏/图表附近正文密集/跨栏混排时启用；简单单栏文档走轻量路径
- [ ] 版式分析结果缓存（`layout_model.json`），避免重复计算
- [ ] 利用版式信息排除正文区域的"假图注"
- [ ] 自动适应单栏/双栏布局

**预期收益**：
- 减少"正文混入图表"的问题
- 更准确的图表边界判定

---

### P1-02 ⭐ Gathering 阶段显式化

**目标**：把"文本提取结果"从杂糅的 plain text 提升到可按段落/标题组织的结构

**最小版本**：
- [ ] Header/footer 检测与剔除（基于重复行/位置）
- [ ] 双栏顺序重排（基于 x0/x1 与列检测）
- [ ] continued 图表/跨页表格合并为同一逻辑条目

**扩展版本**：
- [ ] 章节层级融合
- [ ] 语义 chunking（面向 RAG/LLM）

---

### P1-03 ⭐ 增加 PDF 预验证阶段

**目标**：借鉴 Uni-Parser 的预处理验证

**实现方案**：
```python
@dataclass
class PDFValidationResult:
    is_valid: bool
    page_count: int
    has_text_layer: bool
    text_layer_ratio: float  # 0.0 ~ 1.0
    is_encrypted: bool
    warnings: List[str]
    errors: List[str]

def pre_validate_pdf(pdf_path: str) -> PDFValidationResult:
    """预验证 PDF 文件"""
    ...
```

**验收标准**：
- [ ] 检测加密/损坏文档
- [ ] 检测是否有嵌入文本层（提前警告 OCR-only PDF）
- [ ] 预估页数和基本元信息

---

### P1-04 ⭐ 质量控制（QC）独立化

**目标**：将分散的验收逻辑整合为独立阶段

**实现方案**：
```python
def quality_check(records: List[AttachmentRecord], pdf_path: str) -> List[QualityIssue]:
    """独立的质量检查阶段"""
    issues = []
    
    # 1. 检查提取数量与文本中引用的一致性
    # 2. 检查图像尺寸合理性
    # 3. 检查是否有编号跳跃
    # 4. 检查续页完整性
    
    return issues
```

**验收标准**：
- [ ] 提取数量与文本引用数对比
- [ ] 图像尺寸合理性检查
- [ ] 编号连续性检查
- [ ] 续页完整性检查

---

### P1-05 ⭐ 全局锚点微弱优势回退

**问题描述**：  
当 `above_total` 和 `below_total` 非常接近（差距 < 2%）时，可能因噪声导致全篇错误选择方向。

**修复方案**：
```python
CLOSE_MARGIN = 0.05  # 5% 以内视为"势均力敌"

if abs(below_total - above_total) / max(1.0, above_total + below_total) < CLOSE_MARGIN:
    global_side = None  # 不使用全局方向，按页独立决策
    print("[INFO] Global anchor undecided, using per-page decision")
```

**验收标准**：
- [ ] 差距 < 5% 时回退到按页决策
- [ ] 日志记录决策原因

---

### P1-06 ⭐ index.json 扩展为可追溯格式

**目标**：增加元数据，便于复现和诊断

**扩展字段**：
```json
{
  "version": "2.0",
  "meta": {
    "pdf": "paper.pdf",
    "pdf_hash": "sha256:abc123...",
    "pages": 12,
    "extracted_at": "2025-12-22T10:30:00Z",
    "extractor_version": "2.0.0",
    "preset": "robust"
  },
  "layout": {
    "columns": 2,
    "typical_line_height": 11.2
  },
  "figures": [
    {
      "type": "figure",
      "id": "1",
      "page": 3,
      "caption": "Figure 1: ...",
      "file": "Figure_1_*.png",
      "anchor_mode": "v2",
      "side": "above",
      "stages_applied": ["A", "B", "D"],
      "confidence": 0.92,
      "bbox_pt": [72.0, 150.0, 540.0, 400.0]
    }
  ],
  "quality_issues": [...]
}
```

---

### P1-07 ⭐ 精裁验收阈值动态化

**问题描述**：  
固定的 60%/55% 阈值不适合所有尺寸的图表。

**修复方案**：
```python
def adaptive_thresholds(base_height):
    if base_height > 400:
        return 0.50, 0.45  # 大图可以更激进
    elif base_height > 200:
        return 0.60, 0.55  # 中等图使用默认
    else:
        return 0.75, 0.70  # 小图更保守
```

---

### P1-08 ⭐ 正则表达式覆盖扩展

**当前不支持的格式**：
- `Fig. 1A` / `Figure 1a`（带子图标签）
- `图1`（中文无空格）
- `Figure I`（罗马数字）
- `Figure 1 (a)`（子图在括号中）

**修复方案**：
```python
figure_line_re = re.compile(
    r"^\s*(?:Extended\s+Data\s+Figure|Supplementary\s+Figure|Figure|Fig\.?|图表|附图|图)\s*"
    r"(?:S\s*)?"
    r"(\d+|[IVX]+)"  # 支持罗马数字
    r"(?:\s*[A-Za-z]|\s*\([A-Za-z]\))?"  # 支持子图标签
    r"(?:\s*\(continued\)|\s*续|\s*接上页)?",
    re.IGNORECASE,
)
```

---

### P1-09 ⭐ 为每个 Figure/Table 建立“正文上下文锚点”（强烈建议）

**目标**：让“图表解释/重命名/摘要生成”更贴近论文原意，避免只看 caption+PNG 的泛化“看图说话”。

**为什么是 P1 级别**：  
图表重命名与 1–2 句解释的质量，往往取决于正文中首次提及与邻近段落对图表的解释。把这些上下文结构化下来，会显著提升摘要阶段的稳定性与一致性。

**最小版本（MVP）**：
- [ ] 在 `index.json` 的每个条目扩展字段（或单独产物 `images/figure_contexts.json`）：
  - `first_mention_spans`：正文中首次提及该 Figure/Table 的位置与附近 1–2 段文本（可先用“文本行号/段落序号”表示位置）
  - `caption_page_text_window`：图注所在页附近正文窗口（同栏/邻近段落优先；如暂无法定位栏，可用“页邻近文本窗口”替代）
- [ ] 覆盖提及形式（至少）：`Figure 3 / Fig. 3 / Figure S1 / Table S2 / 图3 / 图 3 / 表2 / 表 2`

**扩展版本（建议）**：
- [ ] 结合 Gathering（P1-02）的“段落/标题/阅读顺序”结构，将 `first_mention_spans` 指向结构化 chunk（`section_id/paragraph_id/span_offsets`）
- [ ] 对 continued 图表/跨页表格：支持“多页上下文”合并（同一 ident 的上下文聚合）

**验收标准**：
- [ ] 90%+ 图表条目能生成 `first_mention_spans`（无提及则显式为空，并记录原因）
- [ ] 对 `S1`、罗马数字、中文编号不会误配到 `1`
- [ ] 同一 PDF 重跑结果稳定（相同输入→相同上下文定位与内容）

---

### P1-10 ⭐ 重命名工作流半自动化与可验收闭环

**目标**：把“重命名图表文件”从手工步骤升级为“有计划、有校验、可复现”的标准化环节，减少漏改/错改/忘同步 index 的概率。

**最小版本（MVP）**：
- [ ] 自动生成重命名计划文件：
  - macOS/Linux：`rename_plan.sh`
  - Windows/PowerShell：`rename_plan.ps1`
- [ ] 计划中包含：
  - 所有 `images/Figure_*.png` / `images/Table_*.png` 的“原文件名 → 建议新文件名”
  - 碰撞检测（同名、sanitize 后同名、大小写冲突）
  - 覆盖完整性检查（是否遗漏任何条目）
- [ ] 执行计划后自动联动：
  - 运行 `python scripts/sync_index_after_rename.py <PDF_DIR>`
  - 做一致性校验（`index.json` 的 `file` 必须存在；不存在则失败并给出诊断）

**扩展版本（建议）**：
- [ ] 在 `index.json` 记录映射关系，便于审计与回滚（与 QA-05 联动）：
  - `original_file`：脚本生成的临时文件名
  - `current_file`：当前生效文件名
- [ ] 支持“dry-run/只生成不执行”模式，便于先 review 再改名

**验收标准**：
- [ ] 任何一次重命名后，`images/index.json` 与实际 PNG 文件 100% 一致
- [ ] 文件名碰撞不会静默覆盖（必须失败或自动消歧并记录）

---

### P1-11 ⭐ 摘要生成阶段的“结构化输入合同”（而非仅 txt + png）

**目标**：将“摘要生成”从靠 prompt 运气，升级为可复用、可回归、可稳定迭代的标准化生成流程。

**建议固定输入产物（合同）**：
- [ ] `images/index.json`：图表清单（顺序/编号/页码/caption/continued/可选 bbox/confidence/side/stages）
- [ ] `text/gathered_text.json`：结构化正文（章节/段落/阅读顺序/去页眉页脚/双栏重排后的文本）
- [ ] `images/figure_contexts.json`：图表正文上下文（P1-09 的 `first_mention_spans` 与 `caption_page_text_window`）

**与现有 AGENTS.md 的关系**：  
仍然要求“摘要生成时必须提供 txt + 全部 png”，但新增结构化合同让模型有稳定的“对齐与证据”，从而更容易产出固定结构（研究动机/方法/训练与后训练/评测与效率/局限与展望/结论）。

**验收标准**：
- [ ] 同一 PDF 在不改代码的情况下，摘要结构稳定且图表解释能引用对应上下文要点
- [ ] 当 `index.json`/`gathered_text.json`/`figure_contexts.json` 任一缺失时，流程能给出明确错误与补救建议（而非悄悄退化）

---

## P2 长期演进（架构升级）

### P2-01 🔮 模块化流水线架构

**目标**：借鉴 Uni-Parser 的松耦合架构

**改造方向**：
```
Precheck → Layout/Grouping → Parse → Gather → Export
    ↓           ↓              ↓        ↓        ↓
  (验证)     (版式分析)     (提取)   (后处理)  (输出)
```

**具体工作**：
- [ ] 拆分大函数为独立 stage
- [ ] 定义每个 stage 的输入/输出 JSON schema
- [ ] 支持单独运行某个 stage（调试用）
- [ ] 便于未来替换（如接入更强的 layout model）

---

### P2-02 🔮 表格/图表专家分离

**目标**：为 Table 和 Figure 建立专门的处理器

**TableExpert**：
```python
class TableExpert:
    def detect_grid_lines(self, clip, page): ...
    def detect_column_alignment(self, clip, page): ...
    def refine_table_boundary(self, clip, page): ...
```

**FigureExpert**：
```python
class FigureExpert:
    def detect_subfigures(self, clip, page): ...
    def detect_axes(self, clip, page): ...
    def estimate_figure_type(self, clip, page): ...
```

---

### P2-03 🔮 结构化分组输出

**目标**：输出"Uni-Parser 风格"的层次化 layout tree

**产物建议**：
- `images/document.json`（或 `<pdf_stem>.structured.json`）
- 包含：每页 block 列表、caption-对象配对、阅读顺序

---

### P2-04 🔮 图表内容级辅助

**目标**：让摘要阶段更依赖"图表内容"

**可选功能**：
- [ ] 对图表 PNG 运行轻量 OCR（提取标签/坐标轴/列名）
- [ ] 接入外部 VLM 做图像 caption
- [ ] 结果写入 index.json

---

### P2-05 🔮 并行化处理

**目标**：提升大批量处理的吞吐量

**借鉴方向**：
- CPU 预处理队列
- 多进程页面处理
- 异步 I/O

---

## QA 质量保证（贯穿全流程）

### QA-01 ✅ 基准与回归测试

- [ ] 为关键正则（Figure/Table/S1/罗马数字/附录表）添加单元测试
- [ ] 为关键行为添加"golden index.json"对比测试
- [ ] 在 `tests/` 目录维护标准测试 PDF

---

### QA-02 ✅ 异常处理规范化

**问题描述**：代码中有多处 `except Exception: pass`

**修复方案**：
```python
import logging
logger = logging.getLogger(__name__)

try:
    for dr in page_s.get_drawings():
        ...
except Exception as e:
    logger.warning(f"Failed to get drawings on page {pno}: {e}")
```

---

### QA-03 ✅ 可视化调试统一化

- [ ] 把 debug 输出与 index 关联（`debug_artifacts` 字段）
- [ ] 保证 debug 文件命名稳定可追溯
- [ ] 文档说明各颜色含义

---

### QA-04 ✅ 失败分级与可解释日志

- [ ] 把 "refinement rejected / fallback" 提升为结构化事件
- [ ] 写到 index 或单独 `run.log.jsonl`
- [ ] 便于批量复盘

---

### QA-05 ✅ 重命名工作流联动

**问题描述**：二次重命名图表文件后，可能导致索引失配

**修复方案**：
```json
{
  "original_file": "Figure_1_Overview_of_the_proposed.png",
  "current_file": "Figure_1_Multimodal_Transformer_Architecture.png"
}
```

---

## 实施建议

### 第一阶段（1-2 周）：P0 紧急修复

| 任务 | 预估工时 | 风险 |
|------|----------|------|
| P0-01 环境变量污染 | 2h | 低 |
| P0-02 两行检测误裁 | 4h | 低 |
| P0-03 Supplementary 编号 | 8h | 中 |
| P0-04 v2 强制方向 | 4h | 低 |
| P0-05 表格 text_trim | 1h | 低 |
| P0-06 输出隔离 | 4h | 低 |
| P0-07 文件名碰撞 | 2h | 低 |

**总计**：约 25 小时

### 第二阶段（2-4 周）：P1 核心提升

| 任务 | 预估工时 | 依赖 |
|------|----------|------|
| P1-01 版式分析默认启用 | 8h | P0 完成 |
| P1-02 Gathering 阶段 | 16h | P1-01 |
| P1-03 PDF 预验证 | 4h | 无 |
| P1-04 QC 独立化 | 8h | 无 |
| P1-05 全局锚点回退 | 2h | 无 |
| P1-06 index.json 扩展 | 4h | 无 |
| P1-07 动态阈值 | 4h | 无 |
| P1-08 正则表达式扩展 | 4h | P0-03 |
| P1-09 图表正文上下文锚点 | 8h | P1-02（建议） |
| P1-10 重命名半自动与验收闭环 | 6h | P0-07 + QA-05（建议） |
| P1-11 摘要结构化输入合同 | 6h | P1-06 + P1-02 + P1-09（建议） |

**总计**：约 70 小时

### 第三阶段（规划中）：P2 + QA

根据实际需求和资源逐步推进。

---

## 参考资料

- [Uni-Parser 论文](ref/2512.15098v1-Uni-Parser.pdf)
- [PDF图表提取流程分析与改进建议](docs/20251221/PDF图表提取流程分析与改进建议-20251221.md)
- [Uni-Parser启发_改造清单](docs/20251221/Uni-Parser启发_改造清单-20251221.md)
- [PDF图表提取全流程 Mermaid](docs/20251221/PDF图表提取全流程-mermaid.md)

---

*文档结束*
