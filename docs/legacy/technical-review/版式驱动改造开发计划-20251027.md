# ç‰ˆå¼é©±åŠ¨æ”¹é€ å¼€å‘è®¡åˆ’

**æ–‡æ¡£æ—¥æœŸ**: 2025-10-27  
**è®¡åˆ’ç±»å‹**: åˆ†é˜¶æ®µå®æ–½è·¯çº¿å›¾  
**çŠ¶æ€**: ğŸŸ¢ å‡†å¤‡å¯åŠ¨

---

## ğŸ“‹ æ€»ä½“ç›®æ ‡

å°†ç‰ˆå¼ä¿¡æ¯ï¼ˆ`DocumentLayoutModel`ï¼‰ä»"åç½®è°ƒæ•´"å‡çº§ä¸º"å…¨æµç¨‹è½¯çº¦æŸ"ï¼Œæå‡å›¾è¡¨æå–å‡†ç¡®ç‡çº¦3-5%ï¼ŒåŒæ—¶ä¿æŒç¨³å®šæ€§å’Œå¯å›é€€æ€§ã€‚

---

## ğŸ¯ ä¸‰é˜¶æ®µæ”¹é€ è·¯çº¿å›¾

### é˜¶æ®µ1ï¼šä½é£é™©é«˜æ”¶ç›Šæ”¹é€ ï¼ˆé¢„è®¡2å‘¨ï¼‰

**ç›®æ ‡**: Phase Dæ©è†œ + Phase Bè½¯çº¦æŸ

#### 1.1 Phase D: ç‰ˆå¼é©±åŠ¨çš„æ–‡æœ¬æ©è†œ

**èƒŒæ™¯**: å½“å‰`_build_text_masks_px()`ä½¿ç”¨è¡Œçº§å¯å‘å¼ï¼ˆå­—å·+å®½åº¦æ¯”ï¼‰ï¼Œå®¹æ˜“è¯¯åˆ¤ã€‚

**æ”¹é€ æ–¹æ¡ˆ**:
```python
def _build_text_masks_px_v2(
    clip: fitz.Rect,
    layout_model: Optional[DocumentLayoutModel],
    page_num: int,
    *,
    scale: float,
    direction: str = 'above',
    near_frac: float = 0.6,
    confidence_th: float = 0.75,
    fallback_to_heuristic: bool = True,
) -> List[Tuple[int, int, int, int]]:
    """
    ä½¿ç”¨ç‰ˆå¼æ¨¡å‹æ„å»ºæ–‡æœ¬æ©è†œï¼Œå¤±è´¥åˆ™å›é€€åˆ°è¡Œçº§å¯å‘å¼
    
    ç­–ç•¥:
    1. ä»text_blocksç­›é€‰paragraph_group/titleç±»å‹çš„block
    2. æ£€æŸ¥ç½®ä¿¡åº¦â‰¥0.75 ä¸”ä½äºè¿‘ä¾§åŒºåŸŸ
    3. æ’é™¤in_figure_textç±»å‹ï¼ˆå›¾è¡¨å†…æ–‡å­—ä¸æ©è†œï¼‰
    4. å¦‚æœç‰ˆå¼å—<3ä¸ªï¼Œå›é€€åˆ°å¯å‘å¼
    """
```

**å…³é”®å‚æ•°**:
- `--mask-from-layout`: å¯ç”¨ç‰ˆå¼é©±åŠ¨æ©è†œï¼ˆé»˜è®¤Falseï¼Œå‘åå…¼å®¹ï¼‰
- `--mask-confidence-th 0.75`: æ–‡æœ¬å—ç½®ä¿¡åº¦é˜ˆå€¼
- `--mask-fallback-th 3`: ç‰ˆå¼å—å°‘äºNä¸ªæ—¶å›é€€åˆ°å¯å‘å¼

**ä»£ç ä½ç½®**: 
- æ–°å¢å‡½æ•°: `_build_text_masks_px_v2()` (åœ¨Line 1304åæ’å…¥)
- è°ƒç”¨å¤„: å›¾æå– Line ~2750, è¡¨æå– Line ~3850

**æµ‹è¯•æŒ‡æ ‡**:
- å¯¹æ¯”å¯ç”¨/ç¦ç”¨`--mask-from-layout`çš„å‡†ç¡®ç‡
- ç»Ÿè®¡ç‰ˆå¼æ©è†œè§¦å‘ç‡
- è®°å½•å›é€€åˆ°å¯å‘å¼çš„æ¡ˆä¾‹

---

#### 1.2 Phase B: å¯¹è±¡å¯¹é½çš„è½¯çº¦æŸ

**èƒŒæ™¯**: å½“å‰`_refine_clip_by_objects()`å¯èƒ½å°†è¾¹ç•Œæ‰©å¼ åˆ°å¤–éƒ¨æ®µè½ã€‚

**æ”¹é€ æ–¹æ¡ˆ**:
```python
def _refine_clip_by_objects_v2(
    clip: fitz.Rect,
    caption_rect: fitz.Rect,
    direction: str,
    image_rects: List[fitz.Rect],
    vector_rects: List[fitz.Rect],
    layout_model: Optional[DocumentLayoutModel] = None,  # æ–°å¢
    page_num: int = 0,  # æ–°å¢
    *,
    object_pad: float = 8.0,
    min_area_ratio: float = 0.015,
    merge_gap: float = 6.0,
    near_edge_only: bool = True,
    use_axis_union: bool = True,
    use_horizontal_union: bool = False,
    layout_constraint: bool = True,  # æ–°å¢ï¼šè½¯çº¦æŸå¼€å…³
    layout_gap: float = 2.0,  # æ–°å¢ï¼šä¸blockè¾¹ç•Œçš„é—´éš™
    layout_confidence_th: float = 0.70,  # æ–°å¢ï¼šç½®ä¿¡åº¦é˜ˆå€¼
) -> fitz.Rect:
    """
    æ·»åŠ ç‰ˆå¼è½¯çº¦æŸï¼šè¾¹ç•Œæ‰©å¼ æ—¶ä¸è·¨å…¥å¤–éƒ¨paragraph/title block
    
    ç­–ç•¥:
    1. åŸé€»è¾‘ï¼šå¯¹è±¡å¹¶é›†+padding
    2. æ–°å¢ï¼šæ£€æŸ¥æ‰©å¼ åçš„clipä¸å¤–éƒ¨blocké‡å 
    3. å¦‚æœé‡å >5%ï¼Œè°ƒæ•´è¾¹ç•Œè´´åˆblockè¾¹ç•Œ-2pt
    4. åªçº¦æŸå¤–éƒ¨blockï¼ˆè¿œç¦»captionçš„ï¼‰ï¼Œä¸çº¦æŸå†…å®¹åŒºå—
    """
```

**å…³é”®é€»è¾‘**:
```python
# ä¼ªä»£ç 
if layout_constraint and layout_model:
    external_blocks = get_external_blocks(layout_model, page_num, caption_rect, direction)
    for block in external_blocks:
        if block.confidence < layout_confidence_th:
            continue  # ä½ç½®ä¿¡åº¦blockä¸çº¦æŸ
        
        overlap = extended_clip & block.bbox
        overlap_ratio = overlap.area / extended_clip.area
        
        if overlap_ratio > 0.05:  # é‡å >5%
            # è°ƒæ•´è¾¹ç•Œï¼šåœåœ¨blockè¾¹ç•Œ-gap
            if direction == 'above' and extended_clip.y1 > block.bbox.y0:
                extended_clip.y1 = block.bbox.y0 - layout_gap
            elif direction == 'below' and extended_clip.y0 < block.bbox.y1:
                extended_clip.y0 = block.bbox.y1 + layout_gap
```

**å…³é”®å‚æ•°**:
- `--layout-constraint-b`: å¯ç”¨Phase Bè½¯çº¦æŸï¼ˆé»˜è®¤Falseï¼‰
- `--layout-gap 2.0`: ä¸blockè¾¹ç•Œçš„å®‰å…¨é—´éš™ï¼ˆptï¼‰
- `--layout-confidence-th-b 0.70`: Blockç½®ä¿¡åº¦é˜ˆå€¼

**ä»£ç ä½ç½®**:
- ä¿®æ”¹å‡½æ•°: `_refine_clip_by_objects()` (Line 1165)
- è°ƒç”¨å¤„: å›¾æå– Line ~2700, è¡¨æå– Line ~3800

**æµ‹è¯•æŒ‡æ ‡**:
- ç»Ÿè®¡è½¯çº¦æŸè§¦å‘æ¬¡æ•°
- å¯¹æ¯”å¯ç”¨/ç¦ç”¨çš„è¾¹ç•Œå·®å¼‚
- è®°å½•è¢«çº¦æŸçš„blockç±»å‹åˆ†å¸ƒ

---

#### 1.3 Debugå¯è§†åŒ–å¢å¼º

**æ–°å¢åŠŸèƒ½**: åœ¨`--debug-visual`æ¨¡å¼ä¸‹æ ‡æ³¨æ–‡æœ¬å—çš„ç±»å‹å’Œç½®ä¿¡åº¦

```python
# åœ¨save_debug_visualization()ä¸­æ·»åŠ 
for block in text_blocks:
    # ç»˜åˆ¶blockè¾¹ç•Œ
    draw_rect(block.bbox, color=(255, 105, 180), style='dashed')
    
    # æ ‡æ³¨ç±»å‹å’Œç½®ä¿¡åº¦
    label = f"{block.block_type} ({block.confidence:.2f})"
    draw_text(block.bbox.tl, label, font_size=8, color=(200, 0, 100))
    
    # ä½ç½®ä¿¡åº¦è­¦å‘Š
    if block.confidence < 0.70:
        draw_warning_icon(block.bbox.tl, symbol='âš ')
```

**è¾“å‡ºç¤ºä¾‹**:
```
images/debug/Figure_3_p5_debug_stages.png
  ç²‰è‰²è™šçº¿æ¡† + æ ‡ç­¾ "paragraph_group (0.85)"
  ç²‰è‰²å®çº¿æ¡† + æ ‡ç­¾ "title_h2 (0.90)"
  ç°è‰²æ¡† + è­¦å‘Šå›¾æ ‡ "in_figure_text (0.62)" âš 
```

**ä»£ç ä½ç½®**: `save_debug_visualization()` (Line ~3015)

---

#### 1.4 A/Bæµ‹è¯•å·¥å…·

**æ–°å¢è„šæœ¬**: `scripts/ab_test_layout.py`

```python
def ab_test_layout_constraints(pdf_list, output_csv='ab_test_results.csv'):
    """
    å¯¹æ¯”å¯ç”¨/ç¦ç”¨ç‰ˆå¼çº¦æŸçš„æ•ˆæœ
    
    è¿è¡Œæ¨¡å¼:
    - Mode A: çº¯å¯å‘å¼ï¼ˆbaselineï¼‰
    - Mode B: ç‰ˆå¼é©±åŠ¨æ©è†œï¼ˆé˜¶æ®µ1-Dï¼‰
    - Mode C: ç‰ˆå¼é©±åŠ¨æ©è†œ+è½¯çº¦æŸï¼ˆé˜¶æ®µ1-D+Bï¼‰
    
    è¾“å‡º:
    - ab_test_results.csv: æ¯ä¸ªPDFçš„å¯¹æ¯”ç»“æœ
    - ab_test_summary.txt: ç»Ÿè®¡æ‘˜è¦
    """
```

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
python scripts/ab_test_layout.py \
  --pdfs tests/basic-benchmark/*/*.pdf \
  --modes baseline,mask_only,mask_and_constraint \
  --output ab_test_results.csv
```

---

### é˜¶æ®µ2ï¼šä¸­é£é™©æ”¹é€ ï¼ˆé¢„è®¡3-4å‘¨ï¼‰

**ç›®æ ‡**: Phase A blockçº§è£åˆ‡ + Anchor V2ç‰ˆå¼èå…¥

#### 2.1 Phase A: Blockçº§æ–‡æœ¬è£åˆ‡

**æ”¹é€ æ–¹æ¡ˆ**:
```python
def _trim_clip_head_by_text_v3(
    clip: fitz.Rect,
    caption_rect: fitz.Rect,
    direction: str,
    text_lines: List[Tuple[fitz.Rect, float, str]],
    layout_model: Optional[DocumentLayoutModel] = None,
    page_num: int = 0,
    *,
    use_layout: bool = True,
    layout_confidence_th: float = 0.75,
    consistency_check: bool = True,
    consistency_th: float = 0.15,
    # ... åŸå¯å‘å¼å‚æ•°
) -> fitz.Rect:
    """
    ä¼˜å…ˆä½¿ç”¨text_blocksè¿›è¡Œblockçº§è£åˆ‡ï¼ŒåŒé‡éªŒè¯åé€‰æ‹©ç»“æœ
    
    ç­–ç•¥:
    1. æ–¹æ³•1ï¼ˆç‰ˆå¼é©±åŠ¨ï¼‰ï¼šåŸºäºparagraph_group/title_* blockè£åˆ‡
    2. æ–¹æ³•2ï¼ˆå¯å‘å¼ï¼‰ï¼šåŸ_trim_clip_head_by_text_v2é€»è¾‘
    3. ä¸€è‡´æ€§æ£€æŸ¥ï¼šå¦‚æœä¸¤è€…é«˜åº¦å·®å¼‚<15%ï¼Œä½¿ç”¨æ–¹æ³•1
    4. å·®å¼‚å¤§æ—¶ï¼šä½¿ç”¨æ›´ä¿å®ˆçš„ç»“æœï¼ˆé«˜åº¦æ›´å¤§çš„ï¼‰
    """
```

**å…³é”®é€»è¾‘**:
```python
if use_layout and layout_model:
    # æ–¹æ³•1ï¼šç‰ˆå¼é©±åŠ¨
    layout_result = trim_by_blocks(clip, layout_model.text_blocks[page_num], direction)
    
    # æ–¹æ³•2ï¼šå¯å‘å¼
    heuristic_result = trim_by_heuristic(clip, text_lines, direction)
    
    # ä¸€è‡´æ€§æ£€æŸ¥
    height_diff_ratio = abs(layout_result.height - heuristic_result.height) / clip.height
    
    if height_diff_ratio < consistency_th:
        # ç»“æœæ¥è¿‘ï¼Œä½¿ç”¨ç‰ˆå¼
        return layout_result
    else:
        # ç»“æœå·®å¼‚å¤§ï¼Œä½¿ç”¨ä¿å®ˆç­–ç•¥
        if layout_result.height > heuristic_result.height:
            return layout_result  # ç‰ˆå¼æ›´ä¿å®ˆ
        else:
            return heuristic_result  # å¯å‘å¼æ›´ä¿å®ˆ
```

**å…³é”®å‚æ•°**:
- `--use-layout-trim-a`: å¯ç”¨Phase Aç‰ˆå¼é©±åŠ¨ï¼ˆé»˜è®¤Falseï¼‰
- `--layout-confidence-th-a 0.75`: Blockç½®ä¿¡åº¦é˜ˆå€¼
- `--layout-consistency-th 0.15`: ä¸€è‡´æ€§æ£€æŸ¥é˜ˆå€¼ï¼ˆ15%ï¼‰

**ä»£ç ä½ç½®**:
- æ–°å¢å‡½æ•°: `_trim_clip_head_by_text_v3()` (åœ¨Line 1163åæ’å…¥)
- ä¿®æ”¹è°ƒç”¨: å›¾æå– Line ~2650, è¡¨æå– Line ~3750

---

#### 2.2 Anchor V2: èå…¥ç‰ˆå¼è¯„åˆ†

**æ”¹é€ æ–¹æ¡ˆ**:
åœ¨`figure_score()`å’Œ`score_table_clip()`ä¸­å¢åŠ ç‰ˆå¼è¯„åˆ†é¡¹

```python
def figure_score_v2(
    clip: fitz.Rect,
    pix: fitz.Pixmap,
    image_rects: List[fitz.Rect],
    vector_rects: List[fitz.Rect],
    text_lines: List[Tuple[fitz.Rect, float, str]],
    layout_model: Optional[DocumentLayoutModel] = None,  # æ–°å¢
    page_num: int = 0,  # æ–°å¢
    *,
    width_ratio: float = 0.55,
    font_min: float = 7.0,
    font_max: float = 16.0,
    layout_weight: float = 0.15,  # æ–°å¢ï¼šç‰ˆå¼æƒé‡ï¼ˆ15%ï¼‰
) -> float:
    """
    åŸè¯„åˆ† + ç‰ˆå¼è¯„åˆ†
    
    åŸè¯„åˆ†ï¼ˆ85%ï¼‰:
    - 0.55 * ink_ratio
    - 0.25 * object_coverage
    - -0.20 * paragraph_ratio
    - 0.08 * component_bonus
    
    æ–°å¢ç‰ˆå¼è¯„åˆ†ï¼ˆ15%ï¼‰:
    - +0.10 * vacant_overlap_ratio  ï¼ˆä¸ç•™ç™½åŒºåŸŸé‡å ï¼‰
    - -0.10 * paragraph_overlap_ratio  ï¼ˆä¸å¤–éƒ¨æ®µè½é‡å ï¼‰
    - +0.05 * title_avoidance_bonus  ï¼ˆé¿å¼€æ ‡é¢˜ï¼‰
    """
```

**å…³é”®é€»è¾‘**:
```python
# åŸºç¡€è¯„åˆ†ï¼ˆåŸé€»è¾‘ï¼‰
base_score = 0.55 * ink + 0.25 * obj - 0.20 * para + 0.08 * comp

# ç‰ˆå¼è¯„åˆ†ï¼ˆæ–°å¢ï¼‰
if layout_model and layout_weight > 0:
    vacant_regions = layout_model.vacant_regions.get(page_num, [])
    text_blocks = layout_model.text_blocks.get(page_num, [])
    
    # 1. ä¸ç•™ç™½åŒºåŸŸé‡å ï¼ˆæ­£å‘ï¼‰
    vacant_overlap = compute_overlap_ratio(clip, vacant_regions)
    
    # 2. ä¸å¤–éƒ¨æ®µè½é‡å ï¼ˆè´Ÿå‘ï¼‰
    external_para = [b for b in text_blocks if b.block_type == 'paragraph_group']
    para_overlap = compute_overlap_ratio(clip, external_para)
    
    # 3. é¿å¼€æ ‡é¢˜ï¼ˆæ­£å‘ï¼‰
    titles = [b for b in text_blocks if b.block_type.startswith('title_')]
    title_avoidance = 1.0 - compute_overlap_ratio(clip, titles)
    
    layout_score = (0.10 * vacant_overlap 
                   - 0.10 * para_overlap 
                   + 0.05 * title_avoidance)
    
    final_score = base_score * (1 - layout_weight) + layout_score * layout_weight
    return final_score
else:
    return base_score
```

**å…³é”®å‚æ•°**:
- `--use-layout-anchor`: å¯ç”¨Anchorç‰ˆå¼è¯„åˆ†ï¼ˆé»˜è®¤Falseï¼‰
- `--layout-weight-anchor 0.15`: ç‰ˆå¼æƒé‡ï¼ˆ0-1ï¼Œé»˜è®¤0.15=15%ï¼‰

**ä»£ç ä½ç½®**:
- ä¿®æ”¹å‡½æ•°: `figure_score()` (Line ~2242), `score_table_clip()` (Line ~3547)

---

### é˜¶æ®µ3ï¼šå¯é€‰å¢å¼ºï¼ˆé¢„è®¡2å‘¨ï¼‰

**ç›®æ ‡**: å€™é€‰çª—å£é¢„ç­› + ç‰ˆå¼è´¨é‡è¯„ä¼°

#### 3.1 åŸºäºvacant_regionsçš„å€™é€‰é¢„ç­›

**æ”¹é€ æ–¹æ¡ˆ**:
åœ¨Anchor V2çš„å¤šå°ºåº¦æ‰«æä¸­ï¼Œä¼˜å…ˆç­›é€‰ä¸`vacant_regions`é‡å åº¦é«˜çš„å€™é€‰

```python
def scan_candidate_windows_v2(
    caption_rect: fitz.Rect,
    page_rect: fitz.Rect,
    scan_heights: List[float],
    layout_model: Optional[DocumentLayoutModel] = None,
    page_num: int = 0,
    pre_filter: bool = True,  # æ–°å¢ï¼šé¢„ç­›é€‰å¼€å…³
    vacant_overlap_th: float = 0.30,  # æ–°å¢ï¼šç•™ç™½é‡å é˜ˆå€¼
) -> List[Tuple[float, str, fitz.Rect]]:
    """
    å€™é€‰çª—å£é¢„ç­›ï¼šè·¨å¤§é‡æ®µè½çš„çª—å£ç›´æ¥ä¸¢å¼ƒ
    """
```

**å…³é”®é€»è¾‘**:
```python
for height in scan_heights:
    for y_offset in offsets:
        candidate = create_window(caption_rect, height, y_offset)
        
        # é¢„ç­›é€‰ï¼ˆæ–°å¢ï¼‰
        if pre_filter and layout_model:
            vacant_regions = layout_model.vacant_regions.get(page_num, [])
            text_blocks = layout_model.text_blocks.get(page_num, [])
            
            # 1. ä¸ç•™ç™½é‡å å¤ªå°‘ï¼Œè·³è¿‡
            vacant_overlap = compute_overlap(candidate, vacant_regions)
            if vacant_overlap < vacant_overlap_th:
                continue
            
            # 2. è·¨å¤šä¸ªæ®µè½ï¼Œè·³è¿‡
            para_blocks = [b for b in text_blocks if b.block_type == 'paragraph_group']
            crossed_paras = count_crossed_blocks(candidate, para_blocks)
            if crossed_paras > 2:  # è·¨3ä¸ªä»¥ä¸Šæ®µè½
                continue
        
        # è®¡ç®—è¯„åˆ†
        score = compute_score(candidate)
        candidates.append((score, direction, candidate))
```

**å…³é”®å‚æ•°**:
- `--pre-filter-candidates`: å¯ç”¨å€™é€‰é¢„ç­›ï¼ˆé»˜è®¤Falseï¼‰
- `--vacant-overlap-th 0.30`: ç•™ç™½é‡å é˜ˆå€¼ï¼ˆ30%ï¼‰

---

#### 3.2 ç‰ˆå¼è´¨é‡è¯„ä¼°å·¥å…·

**æ–°å¢è„šæœ¬**: `scripts/evaluate_layout_quality.py`

```python
def evaluate_layout_quality(
    pdf_path: str,
    ground_truth_json: Optional[str] = None,
    output_report: str = 'layout_quality_report.txt'
):
    """
    è¯„ä¼°ç‰ˆå¼æå–çš„è´¨é‡
    
    è¯„ä¼°ç»´åº¦:
    1. æ–‡æœ¬åˆ†ç±»å‡†ç¡®ç‡ï¼ˆå¦‚æœæœ‰ground truthï¼‰
    2. Titleå¬å›ç‡/ç²¾ç¡®ç‡
    3. In-Figure Text F1åˆ†æ•°
    4. åŒæ æ£€æµ‹å‡†ç¡®ç‡
    5. Text blocksè¦†ç›–ç‡
    
    è¾“å‡º:
    - layout_quality_report.txt: è¯¦ç»†æŠ¥å‘Š
    - layout_quality_metrics.json: å¯é‡åŒ–æŒ‡æ ‡
    """
```

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# æ— ground truthï¼šè¯„ä¼°è¦†ç›–ç‡å’Œåˆ†å¸ƒ
python scripts/evaluate_layout_quality.py --pdf paper.pdf

# æœ‰ground truthï¼šè¯„ä¼°å‡†ç¡®ç‡
python scripts/evaluate_layout_quality.py \
  --pdf paper.pdf \
  --gt layout_gt.json \
  --output report.txt
```

---

## ğŸ“Š å®æ–½æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡è€—æ—¶ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|------|----------|--------|------|
| **é˜¶æ®µ1** | Phase Dæ©è†œæ”¹é€  | 3å¤© | â­â­â­ é«˜ | æ—  |
| | Phase Bè½¯çº¦æŸæ”¹é€  | 2å¤© | â­â­â­ é«˜ | æ—  |
| | Debugå¯è§†åŒ–å¢å¼º | 1å¤© | â­â­â­ é«˜ | æ—  |
| | A/Bæµ‹è¯•å·¥å…·å¼€å‘ | 2å¤© | â­â­ ä¸­ | æ—  |
| | æµ‹è¯•ä¸æ–‡æ¡£ | 2å¤© | â­â­â­ é«˜ | ä¸Šè¿°å…¨éƒ¨ |
| **é˜¶æ®µ2** | Phase A blockçº§è£åˆ‡ | 4å¤© | â­â­ ä¸­ | é˜¶æ®µ1 |
| | Anchor V2ç‰ˆå¼èå…¥ | 3å¤© | â­â­ ä¸­ | é˜¶æ®µ1 |
| | ä¸€è‡´æ€§æ£€æŸ¥é€»è¾‘ | 2å¤© | â­â­ ä¸­ | Phase A |
| | æµ‹è¯•ä¸è°ƒä¼˜ | 3å¤© | â­â­â­ é«˜ | ä¸Šè¿°å…¨éƒ¨ |
| **é˜¶æ®µ3** | å€™é€‰é¢„ç­›åŠŸèƒ½ | 3å¤© | â­ ä½ | é˜¶æ®µ2 |
| | ç‰ˆå¼è´¨é‡è¯„ä¼°å·¥å…· | 3å¤© | â­ ä½ | æ—  |
| | Ground truthæ ‡æ³¨ | 2å¤© | â­ ä½ | æ—  |
| | æœ€ç»ˆæŠ¥å‘Š | 2å¤© | â­â­ ä¸­ | ä¸Šè¿°å…¨éƒ¨ |

**æ€»è®¡**: 
- é˜¶æ®µ1: 10å¤©ï¼ˆ2å‘¨ï¼‰
- é˜¶æ®µ2: 12å¤©ï¼ˆ2.5å‘¨ï¼‰
- é˜¶æ®µ3: 10å¤©ï¼ˆ2å‘¨ï¼‰
- **æ€»è®¡**: 32å¤©ï¼ˆçº¦6.5å‘¨ï¼‰

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### é˜¶æ®µ1ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|--------|----------|
| æ•´ä½“å‡†ç¡®ç‡ | 92.1% | **94-95%** | 10ç¯‡æµ‹è¯•é›†å®Œæ•´æå–ç‡ |
| è¯¯è£ç‡ | 1.8% | **<1.0%** | åŠå¹…/è¿‡è£æ¡ˆä¾‹æ•° |
| ç‰ˆå¼æ©è†œè§¦å‘ç‡ | N/A | **>70%** | å¯ç”¨ç‰ˆå¼æ©è†œçš„å›¾è¡¨å æ¯” |
| è½¯çº¦æŸè§¦å‘ç‡ | N/A | **>40%** | Phase Bè§¦å‘çº¦æŸçš„å›¾è¡¨å æ¯” |
| å›é€€ç‡ | N/A | **<10%** | ç‰ˆå¼å¤±æ•ˆå›é€€åˆ°å¯å‘å¼çš„å æ¯” |

### é˜¶æ®µ2ç›®æ ‡

| æŒ‡æ ‡ | é˜¶æ®µ1å | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|---------|--------|----------|
| æ•´ä½“å‡†ç¡®ç‡ | 94-95% | **95-96%** | ç»§ç»­æå‡ |
| Phase Aè§¦å‘ç‡ | N/A | **>60%** | ä½¿ç”¨blockçº§è£åˆ‡çš„å æ¯” |
| Anchorä¼˜åŒ–ç‡ | N/A | **>50%** | ç‰ˆå¼è¯„åˆ†æ”¹å˜é€‰æ‹©çš„å æ¯” |
| ä¸€è‡´æ€§é€šè¿‡ç‡ | N/A | **>80%** | ç‰ˆå¼ä¸å¯å‘å¼ç»“æœä¸€è‡´çš„å æ¯” |

### é˜¶æ®µ3ç›®æ ‡

| æŒ‡æ ‡ | é˜¶æ®µ2å | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|---------|--------|----------|
| å€™é€‰é¢„ç­›è¿‡æ»¤ç‡ | N/A | **20-30%** | è¢«é¢„ç­›è¿‡æ»¤çš„å€™é€‰çª—å£å æ¯” |
| ç‰ˆå¼è´¨é‡è¯„åˆ† | N/A | **>85%** | æ–‡æœ¬åˆ†ç±»ç»¼åˆå‡†ç¡®ç‡ |

---

## ğŸ”§ å¼€å‘ç¯å¢ƒå‡†å¤‡

### ä¾èµ–æ£€æŸ¥

```bash
# å¿…éœ€ä¾èµ–
pip install pymupdf pdfminer.six

# å¯é€‰ä¾èµ–ï¼ˆç”¨äºç‰ˆå¼æ£€æµ‹ï¼‰
pip install numpy scipy scikit-learn

# å¼€å‘å·¥å…·
pip install pytest black mypy
```

### æµ‹è¯•æ•°æ®é›†

```
tests/basic-benchmark/
â”œâ”€â”€ DeepSeek_V3_2/              # æ ‡å‡†åŒæ ï¼Œ92%å‡†ç¡®ç‡
â”œâ”€â”€ FunAudio-ASR/               # è¿œè·æ–‡å­—åœºæ™¯
â”œâ”€â”€ 1706.03762v7-attention/     # å¤šå­å›¾åœºæ™¯
â”œâ”€â”€ gemini_v2_5_report/         # æ··åˆæ’ç‰ˆ
â”œâ”€â”€ gpt-5-system-card/          # æ ‡å‡†å•æ 
â””â”€â”€ Qwen3-Omni/                 # æ–°å¢æµ‹è¯•æ ·æœ¬ï¼ˆæœ¬æ¬¡ï¼‰
```

---

## ğŸ“ å¼€å‘æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1ï¼ˆæœ¬æ¬¡å®æ–½ï¼‰

- [ ] **Phase Dæ©è†œæ”¹é€ **
  - [ ] æ–°å¢`_build_text_masks_px_v2()`å‡½æ•°
  - [ ] æ·»åŠ å›é€€é€»è¾‘
  - [ ] é›†æˆåˆ°å›¾/è¡¨æå–æµç¨‹
  - [ ] æ·»åŠ `--mask-from-layout`ç­‰å‚æ•°
  
- [ ] **Phase Bè½¯çº¦æŸæ”¹é€ **
  - [ ] ä¿®æ”¹`_refine_clip_by_objects()`
  - [ ] å®ç°å¤–éƒ¨blockæ£€æµ‹é€»è¾‘
  - [ ] å®ç°è¾¹ç•Œè°ƒæ•´é€»è¾‘
  - [ ] æ·»åŠ `--layout-constraint-b`ç­‰å‚æ•°
  
- [ ] **Debugå¯è§†åŒ–å¢å¼º**
  - [ ] åœ¨debugå›¾ä¸­æ ‡æ³¨blockç±»å‹
  - [ ] åœ¨debugå›¾ä¸­æ ‡æ³¨ç½®ä¿¡åº¦
  - [ ] åœ¨legendä¸­æ·»åŠ blockç»Ÿè®¡
  
- [ ] **æµ‹è¯•ä¸éªŒè¯**
  - [ ] åœ¨Qwen3-Omni PDFä¸Šæµ‹è¯•
  - [ ] åœ¨å…¨éƒ¨æµ‹è¯•é›†ä¸ŠA/Bæµ‹è¯•
  - [ ] è®°å½•è§¦å‘ç‡å’Œå›é€€ç‡
  - [ ] ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š

---

## ğŸš€ åç»­è¡ŒåŠ¨

### ç«‹å³å¯åŠ¨ï¼ˆæœ¬å‘¨ï¼‰

1. âœ… å®æ–½é˜¶æ®µ1-Phase Dæ©è†œæ”¹é€ 
2. âœ… å®æ–½é˜¶æ®µ1-Phase Bè½¯çº¦æŸæ”¹é€ 
3. âœ… å®æ–½debugå¯è§†åŒ–å¢å¼º
4. âœ… åœ¨Qwen3-Omni PDFä¸Šæµ‹è¯•

### ä¸‹å‘¨è®¡åˆ’

1. â³ å®ŒæˆA/Bæµ‹è¯•å·¥å…·
2. â³ åœ¨å…¨éƒ¨æµ‹è¯•é›†ä¸Šè¿è¡Œå¯¹æ¯”
3. â³ åˆ†æç»“æœï¼Œè°ƒæ•´å‚æ•°
4. â³ å†³å®šæ˜¯å¦å¯åŠ¨é˜¶æ®µ2

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-27  
**ä¸‹æ¬¡å®¡æŸ¥**: 2025-11-03ï¼ˆé˜¶æ®µ1å®Œæˆåï¼‰  
**å®¡æ ¸çŠ¶æ€**: âœ… è®¡åˆ’å·²æ‰¹å‡†ï¼Œå‡†å¤‡å®æ–½

