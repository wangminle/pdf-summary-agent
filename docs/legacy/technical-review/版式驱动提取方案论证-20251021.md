# ç‰ˆå¼é©±åŠ¨æå–æ–¹æ¡ˆè®ºè¯æŠ¥å‘Š

**ææ¡ˆæ—¥æœŸ**: 2025-10-21  
**ææ¡ˆæ¥æº**: ç”¨æˆ·éœ€æ±‚  
**è¯„ä¼°äºº**: PDF Summary Agent Team  
**çŠ¶æ€**: ğŸŸ¡ å¾…è®¨è®º

---

## ğŸ“‹ ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 æ ¸å¿ƒæ€è·¯

å°†å½“å‰çš„**"Captioné©±åŠ¨å®šä½"**è¿›åŒ–ä¸º**"ç‰ˆå¼ç»“æ„é©±åŠ¨å®šä½"**ï¼Œé€šè¿‡ä¸‰æ­¥èµ°ç­–ç•¥ï¼š

```mermaid
graph LR
    A[Step 1: å¢å¼ºæ–‡æœ¬æå–] --> B[Step 2: ç»˜åˆ¶æ–‡æœ¬åŒºå—å›¾]
    B --> C[Step 3: ä¼˜åŒ–å›¾è¡¨æå–]
    
    A1[ä¿ç•™å®Œæ•´æ ¼å¼ä¿¡æ¯] --> A
    A2[æ ‡æ³¨æ–‡æœ¬ç±»å‹] --> A
    
    B1[æ„å»ºç‰ˆå¼æ¨¡å‹] --> B
    B2[è¯†åˆ«ç•™ç™½åŒºåŸŸ] --> B
    
    C1[é¢„æµ‹å›¾è¡¨ä½ç½®] --> C
    C2[ç²¾ç¡®è¾¹ç•Œè£å‰ª] --> C
```

### 1.2 ä¸‰æ­¥éª¤è¯¦è§£

#### Step 1: å¢å¼ºæ–‡æœ¬æå–ï¼ˆFormat-Aware Text Extractionï¼‰
åœ¨æå–æ–‡æœ¬æ—¶ï¼Œå®Œæ•´ä¿ç•™å¹¶ç»“æ„åŒ–ä»¥ä¸‹ä¿¡æ¯ï¼š
- **ä½ç½®ä¿¡æ¯**: bbox (x0, y0, x1, y1)
- **æ ¼å¼ä¿¡æ¯**: å­—ä½“åç§°ã€å­—å·ã€å­—é‡ï¼ˆåŠ ç²—/å¸¸è§„ï¼‰ã€é¢œè‰²
- **ç±»å‹æ ‡æ³¨**: æ ‡é¢˜(H1/H2/H3)ã€æ®µè½ã€å›¾æ³¨ã€è¡¨æ³¨ã€åˆ—è¡¨ã€å…¬å¼
- **æ’ç‰ˆä¿¡æ¯**: å•æ /åŒæ ã€å·¦å³å¯¹é½ã€ç¼©è¿›
- **å±‚çº§å…³ç³»**: å—(block) â†’ è¡Œ(line) â†’ è·¨åº¦(span)

#### Step 2: ç»˜åˆ¶æ–‡æœ¬åŒºå—ä½ç½®å›¾ï¼ˆText Layout Mappingï¼‰
åŸºäºStep 1çš„æ ¼å¼ä¿¡æ¯ï¼Œæ„å»ºå…¨æ–‡çš„"æ–‡æœ¬å ç”¨åœ°å›¾"ï¼š
- **æ–‡æœ¬å¯†é›†åŒº**: æ­£æ–‡æ®µè½ã€åˆ—è¡¨ã€ä»£ç å—
- **å›¾æ³¨åŒº**: Figure/Table captionï¼ˆé€šå¸¸ç‹¬ç«‹æˆè¡Œï¼Œå­—å·ç•¥å°ï¼‰
- **æ ‡é¢˜åŒº**: Section/Subsectionæ ‡é¢˜ï¼ˆé€šå¸¸åŠ ç²—ï¼Œå­—å·å¤§ï¼‰
- **ç•™ç™½åŒº**: å¯èƒ½åŒ…å«å›¾è¡¨çš„åŒºåŸŸï¼ˆæ–‡æœ¬ç¨€ç–æˆ–ç©ºç™½ï¼‰

#### Step 3: ä¼˜åŒ–å›¾è¡¨æå–ï¼ˆLayout-Guided Figure Extractionï¼‰
åœ¨å·²çŸ¥æ–‡æœ¬åŒºå—çš„åŸºç¡€ä¸Šï¼Œä¼˜åŒ–å›¾è¡¨æå–ï¼š
- **æ’é™¤ç­–ç•¥**: å›¾è¡¨ä¸åº”ä¸å¯†é›†æ–‡æœ¬åŒºé‡å ï¼ˆå‡å°‘è¯¯æˆªæ­£æ–‡ï¼‰
- **é¢„æµ‹ç­–ç•¥**: ç•™ç™½åŒº + å›¾æ³¨é™„è¿‘ = é«˜æ¦‚ç‡å›¾è¡¨åŒº
- **è¾¹ç•Œä¼˜åŒ–**: æ–‡æœ¬åŒºå—è¾¹ç•Œä½œä¸ºè£å‰ªçš„"è½¯çº¦æŸ"
- **éªŒæ”¶å¼ºåŒ–**: åˆ©ç”¨ç‰ˆå¼ä¿¡æ¯éªŒè¯æå–ç»“æœçš„åˆç†æ€§

---

## ğŸ” äºŒã€ç°æœ‰å®ç°è¯„ä¼°

### 2.1 å·²å®ç°éƒ¨åˆ†ï¼ˆâœ…ï¼‰

| åŠŸèƒ½ | å®ç°ä½ç½® | å®Œæˆåº¦ | è¯´æ˜ |
|------|---------|--------|------|
| **è¡Œé«˜ç»Ÿè®¡** | `_estimate_document_line_metrics()` | âœ… 100% | ç»Ÿè®¡å…¸å‹å­—å·ã€è¡Œé«˜ã€è¡Œè· |
| **æ–‡æœ¬è¡Œæ”¶é›†** | `_collect_text_lines()` | âœ… 100% | æå–è¡Œçº§æ–‡æœ¬ + bbox + å­—å· |
| **å­—ä½“ä¿¡æ¯è·å–** | `page.get_text("dict")` | âœ… 100% | PyMuPDFæ”¯æŒspansçº§å­—ä½“ä¿¡æ¯ |
| **Captionæ™ºèƒ½æ£€æµ‹** | `build_caption_index()` | âœ… 100% | åŒºåˆ†çœŸå®å›¾æ³¨ vs æ­£æ–‡å¼•ç”¨ |

### 2.2 æœªå®ç°éƒ¨åˆ†ï¼ˆâŒï¼‰

| åŠŸèƒ½ | ç¼ºå¤±å†…å®¹ | å½±å“ |
|------|---------|------|
| **æ ¼å¼ä¿¡æ¯ä¿å­˜** | æ–‡æœ¬æå–æ—¶ä»…ä¿å­˜çº¯æ–‡æœ¬ | ä¸¢å¤±å­—ä½“ã€å­—å·ã€åŠ ç²—ç­‰ä¿¡æ¯ |
| **æ–‡æœ¬ç±»å‹åˆ†ç±»** | æœªåŒºåˆ†æ ‡é¢˜/æ®µè½/å›¾æ³¨/è¡¨æ³¨ | æ— æ³•æ„å»ºè¯­ä¹‰å±‚çº§ |
| **ç‰ˆå¼æ¨¡å‹æ„å»º** | æœªå»ºç«‹å…¨æ–‡çš„ç©ºé—´å¸ƒå±€æ¨¡å‹ | ç¼ºå°‘"æ–‡æœ¬å ç”¨åœ°å›¾" |
| **ç•™ç™½åŒºåŸŸè¯†åˆ«** | æœªä¸»åŠ¨æ£€æµ‹ç©ºç™½æˆ–ç¨€ç–åŒºåŸŸ | å›¾è¡¨é¢„æµ‹ç¼ºå°‘å…ˆéªŒä¿¡æ¯ |
| **åŒæ æ£€æµ‹** | æœªè¯†åˆ«å•æ /åŒæ æ’ç‰ˆ | å®½åº¦å‚æ•°å›ºå®šï¼Œé€‚åº”æ€§å·® |

### 2.3 ç°æœ‰æ¶æ„çš„å±€é™æ€§

**å½“å‰æ¶æ„ï¼ˆCaptioné©±åŠ¨ï¼‰**:
```python
# ç®€åŒ–é€»è¾‘
1. æ‰¾åˆ° "Figure 1" è¿™ä¸ªæ–‡æœ¬
2. åœ¨å›¾æ³¨ä¸Šæ–¹/ä¸‹æ–¹æ„é€ ä¸€ä¸ªå›ºå®šé«˜åº¦çš„çª—å£ï¼ˆå¦‚520ptï¼‰
3. åœ¨çª—å£å†…æœç´¢å›¾åƒ/çŸ¢é‡å¯¹è±¡
4. ç²¾ç‚¼è¾¹ç•Œï¼ˆå»æ–‡å­—ã€å¯¹è±¡å¯¹é½ã€è‡ªåŠ¨è£å‰ªï¼‰
5. éªŒæ”¶å¹¶è¾“å‡º
```

**é—®é¢˜**:
- âŒ çª—å£é«˜åº¦å›ºå®š â†’ å¤šå­å›¾å †å æ—¶å¯èƒ½æˆªä¸å®Œæ•´
- âŒ ä¸çŸ¥é“æ­£æ–‡åœ¨å“ªé‡Œ â†’ å®¹æ˜“è¯¯åŒ…å«Abstract/Introduction
- âŒ ä¸çŸ¥é“å›¾è¡¨"åº”è¯¥"åœ¨å“ªé‡Œ â†’ å®Œå…¨ä¾èµ–Captionå®šä½
- âŒ ç¼ºå°‘å…ˆéªŒçŸ¥è¯† â†’ éªŒæ”¶é˜ˆå€¼éš¾ä»¥åŠ¨æ€è°ƒæ•´

---

## ğŸ’¡ ä¸‰ã€æ–¹æ¡ˆè¯¦ç»†è®¾è®¡

### 3.1 æ¶æ„å¯¹æ¯”

| ç»´åº¦ | å½“å‰æ¶æ„ï¼ˆCaptioné©±åŠ¨ï¼‰ | æ–°æ¶æ„ï¼ˆç‰ˆå¼é©±åŠ¨ï¼‰ |
|------|---------------------|------------------|
| **å®šä½ç­–ç•¥** | Caption â†’ å›ºå®šçª—å£ â†’ æœç´¢å¯¹è±¡ | ç‰ˆå¼åˆ†æ â†’ ç•™ç™½åŒºé¢„æµ‹ â†’ CaptionéªŒè¯ |
| **æ–‡æœ¬å¤„ç†** | äº‹åè£é™¤ï¼ˆPhase A/Cï¼‰ | äº‹å‰æ’é™¤ï¼ˆç‰ˆå¼æ¨¡å‹ï¼‰ |
| **çª—å£å¤§å°** | å›ºå®šé«˜åº¦ï¼ˆ520-820ptï¼‰ | åŠ¨æ€é«˜åº¦ï¼ˆåŸºäºç•™ç™½åŒºè¾¹ç•Œï¼‰ |
| **å…ˆéªŒçŸ¥è¯†** | æ—  | æ–‡æœ¬åŒºå—åœ°å›¾ |
| **é€‚åº”æ€§** | ä¸­ç­‰ï¼ˆéœ€è°ƒå‚ï¼‰ | é«˜ï¼ˆè‡ªé€‚åº”ç‰ˆå¼ï¼‰ |

### 3.2 æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡

#### 3.2.1 å¢å¼ºçš„æ–‡æœ¬å•å…ƒï¼ˆEnhancedTextUnitï¼‰

```python
@dataclass
class EnhancedTextUnit:
    """å¢å¼ºçš„æ–‡æœ¬å•å…ƒï¼ˆè¡Œçº§æˆ–å—çº§ï¼‰"""
    bbox: fitz.Rect              # è¾¹ç•Œæ¡†
    text: str                    # æ–‡æœ¬å†…å®¹
    page: int                    # é¡µç ï¼ˆ0-basedï¼‰
    
    # æ ¼å¼ä¿¡æ¯
    font_name: str               # å­—ä½“åç§°ï¼ˆå¦‚ 'TimesNewRoman'ï¼‰
    font_size: float             # å­—å·ï¼ˆptï¼‰
    font_weight: str             # 'bold' | 'regular'
    font_flags: int              # PyMuPDF flags (bit flags)
    color: Tuple[int,int,int]    # RGBé¢œè‰²
    
    # ç±»å‹æ ‡æ³¨ï¼ˆç”±åˆ†ç±»å™¨æ¨æ–­ï¼‰
    text_type: str               # 'title_h1' | 'title_h2' | 'paragraph' | 
                                 # 'caption_figure' | 'caption_table' | 
                                 # 'list' | 'equation'
    confidence: float            # ç±»å‹åˆ†ç±»çš„ç½®ä¿¡åº¦ï¼ˆ0~1ï¼‰
    
    # æ’ç‰ˆä¿¡æ¯
    column: int                  # æ‰€åœ¨æ ï¼ˆ0=å·¦æ , 1=å³æ , -1=å•æ ï¼‰
    indent: float                # ç¼©è¿›ï¼ˆptï¼‰
    alignment: str               # 'left' | 'center' | 'right' | 'justify'
    
    # å±‚çº§å…³ç³»
    block_idx: int               # æ‰€åœ¨ block ç´¢å¼•
    line_idx: int                # æ‰€åœ¨ line ç´¢å¼•
    parent_block: Optional['EnhancedTextBlock'] = None
```

#### 3.2.2 æ–‡æœ¬åŒºå—ï¼ˆTextBlockï¼‰

```python
@dataclass
class TextBlock:
    """æ–‡æœ¬å¯†é›†åŒºåŸŸçš„èšåˆå•å…ƒ"""
    bbox: fitz.Rect              # èšåˆåçš„è¾¹ç•Œæ¡†
    units: List[EnhancedTextUnit] # åŒ…å«çš„æ–‡æœ¬å•å…ƒ
    block_type: str              # 'paragraph_group' | 'caption' | 'title'
    page: int
    column: int                  # æ‰€åœ¨æ 
```

#### 3.2.3 æ–‡æ¡£ç‰ˆå¼æ¨¡å‹ï¼ˆDocumentLayoutModelï¼‰

```python
@dataclass
class DocumentLayoutModel:
    """å…¨æ–‡æ¡£çš„ç‰ˆå¼æ¨¡å‹"""
    # å…¨å±€å±æ€§
    page_size: Tuple[float, float]  # (width, height) in pt
    num_columns: int                # 1=å•æ , 2=åŒæ 
    margin_left: float
    margin_right: float
    margin_top: float
    margin_bottom: float
    column_gap: float               # åŒæ æ—¶çš„æ é—´è·
    
    # å…¸å‹å°ºå¯¸
    typical_font_size: float        # æ­£æ–‡å­—å·
    typical_line_height: float      # è¡Œé«˜
    typical_line_gap: float         # è¡Œè·
    
    # æ–‡æœ¬åŒºå—åœ°å›¾ï¼ˆæŒ‰é¡µç»„ç»‡ï¼‰
    text_blocks: Dict[int, List[TextBlock]]  # key=page_num
    
    # ç•™ç™½åŒºåŸŸï¼ˆå¯èƒ½åŒ…å«å›¾è¡¨çš„åŒºåŸŸï¼‰
    vacant_regions: Dict[int, List[fitz.Rect]]  # key=page_num
    
    # Captionç´¢å¼•ï¼ˆå¤ç”¨ç°æœ‰ï¼‰
    caption_index: CaptionIndex
    
    def get_text_density_map(self, page: int) -> np.ndarray:
        """ç”Ÿæˆæ–‡æœ¬å¯†åº¦çƒ­åŠ›å›¾ï¼ˆç”¨äºå¯è§†åŒ–ï¼‰"""
        pass
    
    def predict_figure_regions(self, page: int, caption_rect: fitz.Rect) -> List[fitz.Rect]:
        """åŸºäºç‰ˆå¼é¢„æµ‹å›¾è¡¨å¯èƒ½çš„ä½ç½®"""
        pass
```

### 3.3 å®æ–½æ­¥éª¤

#### Phase 1: å¢å¼ºæ–‡æœ¬æå–ï¼ˆ2-3å‘¨ï¼‰

**ä»»åŠ¡1.1: æ‰©å±•æ–‡æœ¬æå–å‡½æ•°** (~3å¤©)
```python
def extract_text_with_format(
    pdf_path: str,
    out_json: str,
    sample_pages: Optional[int] = None
) -> DocumentLayoutModel:
    """
    æå–æ–‡æœ¬å¹¶ä¿ç•™å®Œæ•´æ ¼å¼ä¿¡æ¯
    
    è¿”å›:
        - DocumentLayoutModel: ç‰ˆå¼æ¨¡å‹å¯¹è±¡
    è¾“å‡º:
        - out_json: ä¿å­˜ä¸ºJSONï¼ˆä¾¿äºåç»­åˆ†æ/è°ƒè¯•ï¼‰
    """
    doc = fitz.open(pdf_path)
    
    # 1. ç»Ÿè®¡å…¨å±€å±æ€§
    page_size = doc[0].rect.width, doc[0].rect.height
    typical_metrics = _estimate_document_line_metrics(doc)
    
    # 2. æå–æ¯é¡µçš„å¢å¼ºæ–‡æœ¬å•å…ƒ
    all_units: Dict[int, List[EnhancedTextUnit]] = {}
    for pno in range(len(doc)):
        page = doc[pno]
        dict_data = page.get_text("dict")
        
        units = []
        for blk_idx, blk in enumerate(dict_data.get("blocks", [])):
            if blk.get("type") != 0:  # ä»…æ–‡æœ¬å—
                continue
            for ln_idx, ln in enumerate(blk.get("lines", [])):
                # æå–æ ¼å¼ä¿¡æ¯
                spans = ln.get("spans", [])
                if not spans:
                    continue
                
                # åˆå¹¶spançº§ä¿¡æ¯
                text = "".join(sp.get("text", "") for sp in spans)
                bbox = fitz.Rect(ln["bbox"])
                
                # å­—ä½“ä¿¡æ¯ï¼ˆå–ä¸»è¦spanï¼‰
                main_span = max(spans, key=lambda s: len(s.get("text", "")))
                font_name = main_span.get("font", "unknown")
                font_size = main_span.get("size", 10.0)
                font_flags = main_span.get("flags", 0)
                color = main_span.get("color", 0)  # intå½¢å¼çš„RGB
                
                # åˆ¤æ–­åŠ ç²—ï¼ˆflagsçš„bit 16è¡¨ç¤ºboldï¼‰
                font_weight = 'bold' if (font_flags & (1 << 4)) else 'regular'
                
                # åˆ›å»ºå¢å¼ºæ–‡æœ¬å•å…ƒ
                unit = EnhancedTextUnit(
                    bbox=bbox,
                    text=text,
                    page=pno,
                    font_name=font_name,
                    font_size=font_size,
                    font_weight=font_weight,
                    font_flags=font_flags,
                    color=(color >> 16, (color >> 8) & 0xFF, color & 0xFF),
                    text_type='unknown',  # å¾…åˆ†ç±»
                    confidence=0.0,
                    column=-1,  # å¾…æ£€æµ‹
                    indent=bbox.x0,  # æš‚ç”¨å·¦è¾¹ç•Œè¡¨ç¤º
                    alignment='left',  # æš‚æ—¶é»˜è®¤
                    block_idx=blk_idx,
                    line_idx=ln_idx
                )
                units.append(unit)
        
        all_units[pno] = units
    
    # 3. æ–‡æœ¬ç±»å‹åˆ†ç±»
    layout_model = _classify_text_types(all_units, typical_metrics)
    
    # 4. åŒæ æ£€æµ‹
    layout_model = _detect_columns(layout_model)
    
    # 5. æ„å»ºæ–‡æœ¬åŒºå—
    layout_model = _build_text_blocks(layout_model)
    
    # 6. è¯†åˆ«ç•™ç™½åŒºåŸŸ
    layout_model = _detect_vacant_regions(layout_model, doc)
    
    # 7. ä¿å­˜ä¸ºJSON
    with open(out_json, 'w', encoding='utf-8') as f:
        json.dump(layout_model.to_dict(), f, indent=2, ensure_ascii=False)
    
    return layout_model
```

**ä»»åŠ¡1.2: å®ç°æ–‡æœ¬ç±»å‹åˆ†ç±»å™¨** (~4å¤©)
```python
def _classify_text_types(
    all_units: Dict[int, List[EnhancedTextUnit]],
    typical_metrics: Dict[str, float]
) -> List[EnhancedTextUnit]:
    """
    åŸºäºè§„åˆ™çš„æ–‡æœ¬ç±»å‹åˆ†ç±»å™¨
    
    åˆ†ç±»è§„åˆ™ï¼š
    1. Captionï¼ˆå›¾æ³¨/è¡¨æ³¨ï¼‰:
       - åŒ¹é…æ­£åˆ™ï¼šFigure/Table + ç¼–å·
       - å­—å·ï¼šç•¥å°äºæ­£æ–‡ï¼ˆ0.9-1.1Ã—typicalï¼‰
       - ä½ç½®ï¼šç‹¬ç«‹æˆè¡Œ
       
    2. Titleï¼ˆæ ‡é¢˜ï¼‰:
       - H1: å­—å· > 1.3Ã—typical + åŠ ç²—
       - H2: å­—å· > 1.15Ã—typical + åŠ ç²—
       - H3: å­—å· â‰ˆ typical + åŠ ç²—
       - ç‰¹å¾ï¼šç‹¬ç«‹æˆè¡Œï¼Œä¸Šä¸‹ç•™ç™½å¤§
       
    3. Paragraphï¼ˆæ®µè½ï¼‰:
       - å­—å·ï¼šâ‰ˆ typical
       - å®½åº¦ï¼š> 70% é¡µé¢å®½åº¦
       - è¡Œè·ï¼šâ‰ˆ typical_line_gap
       
    4. Listï¼ˆåˆ—è¡¨ï¼‰:
       - ç‰¹å¾ï¼šbulletç‚¹ï¼ˆâ€¢/-ï¼‰æˆ–ç¼–å·ï¼ˆ1./a.ï¼‰
       - ç¼©è¿›ï¼š> 0
       
    5. Equationï¼ˆå…¬å¼ï¼‰:
       - ç‰¹å¾ï¼šç‹¬ç«‹æˆè¡Œï¼Œå±…ä¸­ï¼ŒåŒ…å«ç‰¹æ®Šç¬¦å·
    """
    typical_size = typical_metrics['typical_font_size']
    
    for units in all_units.values():
        for unit in units:
            # è§„åˆ™1: Captionæ£€æµ‹
            if re.match(r'^\s*(Figure|Table|Fig\.|å›¾|è¡¨)\s+\S', unit.text, re.I):
                unit.text_type = 'caption_figure' if 'fig' in unit.text.lower() or 'å›¾' in unit.text else 'caption_table'
                unit.confidence = 0.95
                continue
            
            # è§„åˆ™2: Titleæ£€æµ‹
            if unit.font_weight == 'bold':
                ratio = unit.font_size / typical_size
                if ratio > 1.3:
                    unit.text_type = 'title_h1'
                    unit.confidence = 0.90
                elif ratio > 1.15:
                    unit.text_type = 'title_h2'
                    unit.confidence = 0.85
                elif ratio > 1.05:
                    unit.text_type = 'title_h3'
                    unit.confidence = 0.80
                else:
                    unit.text_type = 'paragraph'
                    unit.confidence = 0.70
                continue
            
            # è§„åˆ™3: Listæ£€æµ‹
            if re.match(r'^\s*[â€¢\-\*]\s+', unit.text) or re.match(r'^\s*\d+[\.\)]\s+', unit.text):
                unit.text_type = 'list'
                unit.confidence = 0.85
                continue
            
            # è§„åˆ™4: Equationæ£€æµ‹ï¼ˆç®€åŒ–ï¼‰
            if len(set(unit.text) & set('âˆ«âˆ‘âˆâˆšÂ±â‰ˆâ‰ â‰¤â‰¥âˆ')) > 0 and unit.bbox.width < 0.6 * page_width:
                unit.text_type = 'equation'
                unit.confidence = 0.75
                continue
            
            # é»˜è®¤: Paragraph
            unit.text_type = 'paragraph'
            unit.confidence = 0.60
    
    return all_units
```

**ä»»åŠ¡1.3: å®ç°åŒæ æ£€æµ‹** (~2å¤©)
```python
def _detect_columns(layout_model: DocumentLayoutModel) -> DocumentLayoutModel:
    """
    æ£€æµ‹æ–‡æ¡£æ˜¯å•æ è¿˜æ˜¯åŒæ 
    
    æ–¹æ³•ï¼š
    1. ç»Ÿè®¡æ¯é¡µæ–‡æœ¬å•å…ƒçš„x0åˆ†å¸ƒï¼ˆå·¦è¾¹ç•Œï¼‰
    2. å¦‚æœæœ‰æ˜æ˜¾çš„åŒå³° â†’ åŒæ 
    3. è®¡ç®—æ é—´è·ï¼ˆä¸¤å³°ä¹‹é—´çš„ç©ºç™½åŒºåŸŸï¼‰
    """
    # é‡‡æ ·å‰5é¡µ
    x0_values = []
    for pno in range(min(5, len(layout_model.text_blocks))):
        units = layout_model.text_blocks.get(pno, [])
        for unit in units:
            if unit.text_type == 'paragraph':  # åªç»Ÿè®¡æ®µè½
                x0_values.append(unit.bbox.x0)
    
    if not x0_values:
        layout_model.num_columns = 1
        return layout_model
    
    # ç›´æ–¹å›¾åˆ†æ
    hist, bins = np.histogram(x0_values, bins=20)
    peaks = find_peaks(hist, height=len(x0_values) * 0.1)[0]
    
    if len(peaks) >= 2:
        # åŒæ 
        layout_model.num_columns = 2
        # è®¡ç®—æ è¾¹ç•Œ
        peak1_x = bins[peaks[0]]
        peak2_x = bins[peaks[1]]
        layout_model.column_gap = peak2_x - peak1_x - (layout_model.page_size[0] - peak2_x)
        
        # æ ‡æ³¨æ¯ä¸ªå•å…ƒæ‰€åœ¨æ 
        for units in layout_model.text_blocks.values():
            for unit in units:
                unit.column = 0 if unit.bbox.x0 < (peak1_x + peak2_x) / 2 else 1
    else:
        # å•æ 
        layout_model.num_columns = 1
        for units in layout_model.text_blocks.values():
            for unit in units:
                unit.column = -1
    
    return layout_model
```

**ä»»åŠ¡1.4: æ„å»ºæ–‡æœ¬åŒºå—** (~3å¤©)
```python
def _build_text_blocks(layout_model: DocumentLayoutModel) -> DocumentLayoutModel:
    """
    å°†ç›¸é‚»çš„æ–‡æœ¬å•å…ƒèšåˆæˆæ–‡æœ¬åŒºå—
    
    èšåˆè§„åˆ™ï¼š
    1. åŒç±»å‹ï¼ˆå¦‚éƒ½æ˜¯paragraphï¼‰
    2. å‚ç›´è·ç¦» < 2Ã—typical_line_height
    3. åŒä¸€æ 
    """
    typical_line_h = layout_model.typical_line_height
    
    for pno, units in layout_model.text_blocks.items():
        if not units:
            continue
        
        # æŒ‰yåæ ‡æ’åº
        units.sort(key=lambda u: u.bbox.y0)
        
        blocks: List[TextBlock] = []
        current_block_units = [units[0]]
        current_type = units[0].text_type
        current_column = units[0].column
        
        for i in range(1, len(units)):
            unit = units[i]
            prev_unit = units[i-1]
            
            # æ£€æŸ¥æ˜¯å¦åº”è¯¥èšåˆ
            same_type = unit.text_type == current_type
            same_column = unit.column == current_column
            close_distance = (unit.bbox.y0 - prev_unit.bbox.y1) < 2 * typical_line_h
            
            if same_type and same_column and close_distance:
                current_block_units.append(unit)
            else:
                # åˆ›å»ºæ–°åŒºå—
                if current_block_units:
                    merged_bbox = fitz.Rect()
                    for u in current_block_units:
                        merged_bbox |= u.bbox
                    blocks.append(TextBlock(
                        bbox=merged_bbox,
                        units=current_block_units,
                        block_type=current_type,
                        page=pno,
                        column=current_column
                    ))
                
                # å¼€å§‹æ–°åŒºå—
                current_block_units = [unit]
                current_type = unit.text_type
                current_column = unit.column
        
        # å¤„ç†æœ€åä¸€ä¸ªåŒºå—
        if current_block_units:
            merged_bbox = fitz.Rect()
            for u in current_block_units:
                merged_bbox |= u.bbox
            blocks.append(TextBlock(
                bbox=merged_bbox,
                units=current_block_units,
                block_type=current_type,
                page=pno,
                column=current_column
            ))
        
        layout_model.text_blocks[pno] = blocks
    
    return layout_model
```

**ä»»åŠ¡1.5: è¯†åˆ«ç•™ç™½åŒºåŸŸ** (~3å¤©)
```python
def _detect_vacant_regions(
    layout_model: DocumentLayoutModel,
    doc: fitz.Document
) -> DocumentLayoutModel:
    """
    è¯†åˆ«é¡µé¢ä¸­çš„ç•™ç™½åŒºåŸŸï¼ˆå¯èƒ½åŒ…å«å›¾è¡¨ï¼‰
    
    æ–¹æ³•ï¼š
    1. å°†é¡µé¢åˆ’åˆ†ä¸ºç½‘æ ¼ï¼ˆå¦‚50Ã—50ptçš„æ ¼å­ï¼‰
    2. æ ‡è®°è¢«æ–‡æœ¬åŒºå—è¦†ç›–çš„æ ¼å­
    3. è¿é€šæœªè¦†ç›–çš„æ ¼å­ï¼Œå½¢æˆç•™ç™½åŒºåŸŸ
    4. è¿‡æ»¤å°åŒºåŸŸï¼ˆ< 0.05 Ã— page_areaï¼‰
    """
    grid_size = 50  # pt
    
    for pno in range(len(doc)):
        page = doc[pno]
        page_rect = page.rect
        
        # åˆ›å»ºç½‘æ ¼
        nx = int(page_rect.width / grid_size) + 1
        ny = int(page_rect.height / grid_size) + 1
        grid = np.zeros((ny, nx), dtype=bool)  # True = è¢«æ–‡æœ¬è¦†ç›–
        
        # æ ‡è®°æ–‡æœ¬åŒºå—
        blocks = layout_model.text_blocks.get(pno, [])
        for block in blocks:
            if block.block_type in ['paragraph', 'title_h2', 'title_h3', 'list']:
                # è®¡ç®—åŒºå—è¦†ç›–çš„ç½‘æ ¼èŒƒå›´
                x0_idx = int(block.bbox.x0 / grid_size)
                y0_idx = int(block.bbox.y0 / grid_size)
                x1_idx = int(block.bbox.x1 / grid_size) + 1
                y1_idx = int(block.bbox.y1 / grid_size) + 1
                
                grid[y0_idx:y1_idx, x0_idx:x1_idx] = True
        
        # è¿é€šåˆ†é‡åˆ†æï¼ˆæ‰¾åˆ°è¿ç»­çš„ç©ºç™½åŒºåŸŸï¼‰
        from scipy.ndimage import label
        labeled_grid, num_features = label(~grid)  # ~grid: æœªè¢«è¦†ç›–çš„åŒºåŸŸ
        
        vacant_rects = []
        for region_id in range(1, num_features + 1):
            # æå–è¯¥åŒºåŸŸçš„æ ¼å­åæ ‡
            coords = np.argwhere(labeled_grid == region_id)
            if len(coords) == 0:
                continue
            
            # è½¬æ¢ä¸ºpdfåæ ‡
            y0_idx, x0_idx = coords.min(axis=0)
            y1_idx, x1_idx = coords.max(axis=0)
            
            rect = fitz.Rect(
                x0_idx * grid_size,
                y0_idx * grid_size,
                (x1_idx + 1) * grid_size,
                (y1_idx + 1) * grid_size
            )
            
            # è¿‡æ»¤å°åŒºåŸŸ
            area_ratio = (rect.width * rect.height) / (page_rect.width * page_rect.height)
            if area_ratio > 0.05:  # è‡³å°‘å 5%é¡µé¢é¢ç§¯
                vacant_rects.append(rect)
        
        layout_model.vacant_regions[pno] = vacant_rects
    
    return layout_model
```

---

#### Phase 2: é›†æˆåˆ°å›¾è¡¨æå–æµç¨‹ï¼ˆ1-2å‘¨ï¼‰

**ä»»åŠ¡2.1: ä¿®æ”¹extract_figures()å‡½æ•°** (~5å¤©)

```python
def extract_figures_v2(
    pdf_path: str,
    out_dir: str,
    layout_model: Optional[DocumentLayoutModel] = None,  # æ–°å¢å‚æ•°
    **kwargs
) -> List[AttachmentRecord]:
    """
    ç‰ˆå¼é©±åŠ¨çš„å›¾è¡¨æå–ï¼ˆV2æ¶æ„ï¼‰
    
    æµç¨‹å˜åŒ–ï¼š
    1. å¦‚æœæä¾›layout_modelï¼Œä½¿ç”¨ç‰ˆå¼ä¿¡æ¯
    2. åŸºäºç•™ç™½åŒºåŸŸ + Captionä½ç½®é¢„æµ‹å›¾è¡¨åŒºåŸŸ
    3. åœ¨é¢„æµ‹åŒºåŸŸå†…æœç´¢å¯¹è±¡ï¼ˆå‡å°‘æœç´¢èŒƒå›´ï¼‰
    4. ä½¿ç”¨æ–‡æœ¬åŒºå—è¾¹ç•Œä½œä¸ºè£å‰ªçš„è½¯çº¦æŸ
    """
    
    # Step 1: æ„å»ºæˆ–åŠ è½½ç‰ˆå¼æ¨¡å‹
    if layout_model is None:
        # åŠ¨æ€æ„å»ºï¼ˆå¦‚æœç”¨æˆ·æœªé¢„å…ˆæå–ï¼‰
        layout_json = os.path.join(out_dir, "layout_model.json")
        if os.path.exists(layout_json):
            with open(layout_json, 'r') as f:
                layout_model = DocumentLayoutModel.from_dict(json.load(f))
        else:
            print("[INFO] Building layout model on-the-fly...")
            layout_model = extract_text_with_format(pdf_path, layout_json)
    
    # Step 2: éå†æ¯ä¸ªCaption
    for pno, (fig_no, cap_rect, caption) in enumerate(captions_on_page):
        
        # === æ–°å¢ï¼šç‰ˆå¼é©±åŠ¨é¢„æµ‹ ===
        predicted_regions = layout_model.predict_figure_regions(pno, cap_rect)
        
        if predicted_regions:
            # ä½¿ç”¨é¢„æµ‹åŒºåŸŸä½œä¸ºåˆå§‹çª—å£
            best_clip = max(predicted_regions, key=lambda r: figure_score(r))
        else:
            # å›é€€åˆ°åŸæœ‰é€»è¾‘ï¼ˆé”šç‚¹V2ï¼‰
            best_clip = _anchor_v2_selection(...)
        
        # === æ–°å¢ï¼šæ–‡æœ¬åŒºå—çº¦æŸ ===
        # æ£€æŸ¥best_clipæ˜¯å¦ä¸æ®µè½åŒºå—æœ‰è¿‡å¤šé‡å 
        text_blocks = layout_model.text_blocks.get(pno, [])
        paragraph_blocks = [b for b in text_blocks if b.block_type == 'paragraph']
        
        overlap_ratio = 0.0
        for para_block in paragraph_blocks:
            inter = best_clip & para_block.bbox
            if inter.height > 0 and inter.width > 0:
                overlap_ratio += (inter.width * inter.height) / (best_clip.width * best_clip.height)
        
        if overlap_ratio > 0.3:  # å¦‚æœä¸æ®µè½é‡å è¶…è¿‡30%
            print(f"[WARN] Fig {fig_no} p{pno+1}: high text overlap ({overlap_ratio:.1%}), adjusting...")
            # è°ƒæ•´çª—å£ä»¥é¿å¼€æ®µè½åŒºå—
            best_clip = _adjust_clip_to_avoid_text(best_clip, paragraph_blocks, cap_rect)
        
        # åç»­æµç¨‹ä¿æŒä¸å˜ï¼ˆA+B+Dç²¾ç‚¼ + éªŒæ”¶ï¼‰
        ...
```

**ä»»åŠ¡2.2: å®ç°å›¾è¡¨åŒºåŸŸé¢„æµ‹** (~3å¤©)

```python
def predict_figure_regions(
    self,
    page: int,
    caption_rect: fitz.Rect
) -> List[fitz.Rect]:
    """
    åŸºäºç‰ˆå¼æ¨¡å‹é¢„æµ‹å›¾è¡¨å¯èƒ½çš„ä½ç½®
    
    ç­–ç•¥ï¼š
    1. æ‰¾åˆ°captioné™„è¿‘çš„ç•™ç™½åŒºåŸŸ
    2. æ’é™¤ä¸æ®µè½åŒºå—é‡å çš„åŒºåŸŸ
    3. ä¼˜å…ˆé€‰æ‹©é¢ç§¯å¤§ã€è·ç¦»è¿‘çš„åŒºåŸŸ
    """
    vacant_rects = self.vacant_regions.get(page, [])
    if not vacant_rects:
        return []
    
    # è®¡ç®—æ¯ä¸ªç•™ç™½åŒºåŸŸçš„å¾—åˆ†
    candidates = []
    for vacant_rect in vacant_rects:
        # è·ç¦»å¾—åˆ†ï¼ˆè¶Šè¿‘è¶Šå¥½ï¼‰
        if caption_rect.y0 < vacant_rect.y1:  # captionåœ¨ä¸‹æ–¹
            distance = caption_rect.y0 - vacant_rect.y1
            direction = 'above'
        else:  # captionåœ¨ä¸Šæ–¹
            distance = vacant_rect.y0 - caption_rect.y1
            direction = 'below'
        
        if distance < 0 or distance > 600:  # è·ç¦»è¿‡è¿œæˆ–æ–¹å‘é”™è¯¯
            continue
        
        # é¢ç§¯å¾—åˆ†ï¼ˆè¶Šå¤§è¶Šå¥½ï¼‰
        area_ratio = (vacant_rect.width * vacant_rect.height) / (self.page_size[0] * self.page_size[1])
        
        # ç»¼åˆå¾—åˆ†
        distance_score = max(0, 1.0 - distance / 600)
        area_score = min(1.0, area_ratio / 0.2)  # 0.2ä½œä¸ºå…¸å‹å›¾è¡¨é¢ç§¯
        
        score = 0.6 * distance_score + 0.4 * area_score
        
        candidates.append((score, vacant_rect, direction))
    
    # æ’åºå¹¶è¿”å›top-3
    candidates.sort(key=lambda x: x[0], reverse=True)
    return [rect for (score, rect, direction) in candidates[:3]]
```

---

#### Phase 3: éªŒè¯ä¸ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡3.1: å›å½’æµ‹è¯•** (~3å¤©)
- åœ¨7ä¸ªæµ‹è¯•PDFä¸Šè¿è¡ŒV2æ¶æ„
- å¯¹æ¯”V1æ¶æ„çš„æå–ç»“æœ
- ç»Ÿè®¡å‡†ç¡®ç‡ã€è¯¯è£ç‡ã€å¤„ç†é€Ÿåº¦

**ä»»åŠ¡3.2: å‚æ•°è°ƒä¼˜** (~2å¤©)
- è°ƒæ•´ç•™ç™½åŒºåŸŸæ£€æµ‹çš„é˜ˆå€¼ï¼ˆgrid_size, min_area_ratioï¼‰
- è°ƒæ•´æ–‡æœ¬é‡å å®¹å¿åº¦ï¼ˆoverlap_ratioï¼‰
- è°ƒæ•´é¢„æµ‹åŒºåŸŸçš„è¯„åˆ†æƒé‡

**ä»»åŠ¡3.3: æ–‡æ¡£æ›´æ–°** (~2å¤©)
- æ›´æ–°AGENTS.mdï¼Œè¯´æ˜V2æ¶æ„çš„ä½¿ç”¨æ–¹æ³•
- ç¼–å†™ç‰ˆå¼æ¨¡å‹çš„å¯è§†åŒ–å·¥å…·ï¼ˆå¯¼å‡ºå¸¦æ ‡æ³¨çš„PDFï¼‰
- æ·»åŠ FAQï¼šV1 vs V2çš„é€‰æ‹©å»ºè®®

---

## ğŸ“Š å››ã€æ”¶ç›Šåˆ†æ

### 4.1 é¢„æœŸæå‡

| æŒ‡æ ‡ | å½“å‰ï¼ˆV1ï¼‰ | é¢„æœŸï¼ˆV2ï¼‰ | æå‡ |
|------|-----------|-----------|------|
| **å‡†ç¡®ç‡**ï¼ˆå®Œæ•´æå–ï¼‰ | 92.1% | **96-98%** | +4-6% |
| **è¯¯è£ç‡**ï¼ˆåŠå¹…/è¿‡è£ï¼‰ | 1.8% | **<0.5%** | -72% |
| **è¯¯åŒ…å«æ­£æ–‡** | ä¸­ç­‰ | **ä½** | -60% |
| **å¤šå­å›¾å®Œæ•´ç‡** | 94.0% | **98%** | +4% |
| **å¤„ç†é€Ÿåº¦** | 2.4s/å›¾ | 3.0s/å›¾ | -20% |
| **è°ƒå‚éš¾åº¦** | é«˜ | **ä½** | æ˜¾è‘—é™ä½ |

### 4.2 å®šæ€§æ”¶ç›Š

#### âœ… å‡†ç¡®æ€§æå‡
1. **å…ˆéªŒçŸ¥è¯†å¼•å¯¼**: çŸ¥é“å“ªé‡Œæ˜¯æ­£æ–‡ã€å“ªé‡Œæ˜¯ç•™ç™½ï¼Œå®šä½æ›´ç²¾å‡†
2. **å‡å°‘è¯¯åŒ…å«**: ä¸»åŠ¨é¿å¼€æ®µè½åŒºå—ï¼Œä¸å†ä¾èµ–Phase A/Cäº‹åè¡¥æ•‘
3. **åŠ¨æ€çª—å£**: çª—å£å¤§å°åŸºäºç•™ç™½åŒºè¾¹ç•Œï¼Œè‡ªé€‚åº”é«˜åº¦

#### âœ… é²æ£’æ€§å¢å¼º
1. **ç‰ˆå¼è‡ªé€‚åº”**: å•æ /åŒæ è‡ªåŠ¨æ£€æµ‹ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š
2. **é™ä½å‚æ•°æ•æ„Ÿåº¦**: è®¸å¤šå‚æ•°å¯åŸºäºç‰ˆå¼æ¨¡å‹åŠ¨æ€è°ƒæ•´
3. **å¤±è´¥å›é€€**: å¦‚æœç‰ˆå¼é¢„æµ‹å¤±è´¥ï¼Œå›é€€åˆ°V1é”šç‚¹ç­–ç•¥

#### âœ… å¯è§£é‡Šæ€§æ”¹å–„
1. **ç‰ˆå¼å¯è§†åŒ–**: å¯å¯¼å‡º"æ–‡æœ¬å ç”¨åœ°å›¾"ï¼Œç›´è§‚å±•ç¤ºåˆ†æè¿‡ç¨‹
2. **å†³ç­–é€æ˜**: ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªåŒºåŸŸï¼Ÿå› ä¸ºæ˜¯ç•™ç™½åŒº + è·ç¦»Captionè¿‘
3. **è°ƒè¯•å‹å¥½**: ç‰ˆå¼æ¨¡å‹ä¿å­˜ä¸ºJSONï¼Œä¾¿äºæ£€æŸ¥å’Œè°ƒè¯•

#### âœ… æ‰©å±•æ€§å¼º
1. **ä¸ºå…¬å¼æå–é“ºè·¯**: å…¬å¼ä¹Ÿå¯æ ‡æ³¨ä¸ºç‰¹æ®ŠåŒºå—ï¼Œä¾¿äºåç»­æå–
2. **æ”¯æŒæ›´å¤æ‚æ’ç‰ˆ**: ä¸‰æ ã€å›¾æ–‡æ··æ’ã€è·¨é¡µå›¾ç­‰
3. **ä¸ºOCRåå¤„ç†æä¾›åŸºç¡€**: çŸ¥é“æ¯ä¸ªæ–‡æœ¬çš„ç±»å‹å’Œä½ç½®

---

## âš ï¸ äº”ã€é£é™©ä¸æŒ‘æˆ˜

### 5.1 æŠ€æœ¯æŒ‘æˆ˜

| æŒ‘æˆ˜ | ä¸¥é‡ç¨‹åº¦ | ç¼“è§£æªæ–½ |
|------|---------|---------|
| **æ–‡æœ¬ç±»å‹åˆ†ç±»å‡†ç¡®ç‡** | ğŸŸ¡ ä¸­ | åŸºäºè§„åˆ™çš„åˆ†ç±»å™¨ï¼ˆç®€å•ä½†æœ‰æ•ˆï¼‰ï¼›åæœŸå¯å¼•å…¥MLæ¨¡å‹ |
| **ç•™ç™½åŒºåŸŸæ£€æµ‹å™ªå£°** | ğŸŸ¡ ä¸­ | è¿‡æ»¤å°åŒºåŸŸï¼›è°ƒæ•´grid_sizeå‚æ•° |
| **åŒæ æ£€æµ‹è¯¯åˆ¤** | ğŸŸ¢ ä½ | é‡‡æ ·å¤šé¡µç»Ÿè®¡ï¼›ä½¿ç”¨å³°å€¼æ£€æµ‹ç®—æ³• |
| **ç‰ˆå¼æ¨¡å‹æ„å»ºè€—æ—¶** | ğŸŸ¡ ä¸­ | å¯ç¼“å­˜æ¨¡å‹æ–‡ä»¶ï¼›é¦–æ¬¡è¿è¡Œæ…¢ï¼Œåç»­å¤ç”¨ |
| **å¤æ‚æ’ç‰ˆé€‚åº”æ€§** | ğŸŸ  ä¸­é«˜ | ä¼˜å…ˆæ”¯æŒæ ‡å‡†è®ºæ–‡ï¼›å¤æ‚æ’ç‰ˆå›é€€åˆ°V1 |

### 5.2 å®æ–½é£é™©

#### âš ï¸ é£é™©1: å¼€å‘å‘¨æœŸè¾ƒé•¿ï¼ˆ4-6å‘¨ï¼‰
- **å½±å“**: å»¶è¿Ÿå…¶ä»–åŠŸèƒ½å¼€å‘
- **ç¼“è§£**: åˆ†é˜¶æ®µå®æ–½ï¼ŒPhase 1å®Œæˆåå³å¯éƒ¨åˆ†å—ç›Š

#### âš ï¸ é£é™©2: ä¸ç°æœ‰æµç¨‹å…¼å®¹æ€§
- **å½±å“**: å¯èƒ½éœ€è¦é‡æ„éƒ¨åˆ†ä»£ç 
- **ç¼“è§£**: ä¿ç•™V1æ¶æ„ä½œä¸ºfallbackï¼›æ–°å¢`--anchor-mode v2-layout`é€‰é¡¹

#### âš ï¸ é£é™©3: ç”¨æˆ·å­¦ä¹ æˆæœ¬
- **å½±å“**: ç”¨æˆ·éœ€è¦ç†è§£ç‰ˆå¼æ¨¡å‹æ¦‚å¿µ
- **ç¼“è§£**: é»˜è®¤å¯ç”¨V2ï¼ˆè‡ªåŠ¨æ„å»ºç‰ˆå¼æ¨¡å‹ï¼‰ï¼›æä¾›å¯è§†åŒ–å·¥å…·

### 5.3 å·²çŸ¥ç¼ºé™·

#### âŒ ç¼ºé™·1: ä¸é€‚ç”¨äºæ‰«æPDF
- **åŸå› **: æ‰«æPDFæ— æ³•æå–æ–‡æœ¬æ ¼å¼ä¿¡æ¯
- **å½±å“**: æ­¤ç±»PDFæ— æ³•æ„å»ºç‰ˆå¼æ¨¡å‹
- **è§£å†³**: è‡ªåŠ¨æ£€æµ‹å¹¶å›é€€åˆ°V1æ¶æ„

#### âŒ ç¼ºé™·2: å…¬å¼/ç‰¹æ®Šç¬¦å·è¯†åˆ«ä¸å®Œå–„
- **åŸå› **: è§„åˆ™åˆ†ç±»å™¨éš¾ä»¥å‡†ç¡®è¯†åˆ«å¤æ‚å…¬å¼
- **å½±å“**: å…¬å¼å¯èƒ½è¢«è¯¯åˆ†ç±»ä¸ºparagraph
- **è§£å†³**: åæœŸå¼•å…¥LaTeXæ£€æµ‹æˆ–MLåˆ†ç±»å™¨

#### âŒ ç¼ºé™·3: å›¾æ–‡æ··æ’çš„å¤æ‚åœºæ™¯
- **åŸå› **: ç•™ç™½åŒºåŸŸæ£€æµ‹å¯èƒ½å¤±æ•ˆï¼ˆå¦‚æ–‡å­—ç¯ç»•å›¾ç‰‡ï¼‰
- **å½±å“**: é¢„æµ‹åŒºåŸŸä¸å‡†ç¡®
- **è§£å†³**: æ£€æµ‹åˆ°é«˜æ–‡æœ¬é‡å æ—¶ï¼Œå›é€€åˆ°V1ç­–ç•¥

---

## ğŸ¯ å…­ã€å®æ–½å»ºè®®

### 6.1 æ¨èå®æ–½æ–¹æ¡ˆï¼š**æ¸è¿›å¼å¼•å…¥**

#### æ–¹æ¡ˆA: æ¿€è¿›æ¨¡å¼ï¼ˆå®Œå…¨æ›¿æ¢ï¼Œä¸æ¨èï¼‰
- âŒ ç›´æ¥ç”¨V2æ›¿æ¢V1
- âŒ é£é™©é«˜ï¼Œå›é€€å›°éš¾

#### æ–¹æ¡ˆB: ä¿å®ˆæ¨¡å¼ï¼ˆå¹¶è¡Œå¼€å‘ï¼Œâœ… æ¨èï¼‰
- âœ… V1å’ŒV2å¹¶å­˜ï¼Œç”¨æˆ·å¯é€‰
- âœ… æ–°å¢å‚æ•°ï¼š`--layout-driven` å¯ç”¨V2
- âœ… é»˜è®¤ä»ä½¿ç”¨V1ï¼ˆç¨³å®šæ€§ä¼˜å…ˆï¼‰
- âœ… å……åˆ†æµ‹è¯•åï¼Œå†å°†V2è®¾ä¸ºé»˜è®¤

#### æ–¹æ¡ˆC: æ··åˆæ¨¡å¼ï¼ˆâœ… æœ€ä¼˜ï¼Œæ¨èï¼‰
- âœ… V2ä»…ç”¨äº"å›°éš¾åœºæ™¯"ï¼ˆå¦‚æ£€æµ‹åˆ°å¯†é›†æ–‡æœ¬é¡µï¼‰
- âœ… ç®€å•åœºæ™¯ç»§ç»­ç”¨V1ï¼ˆé€Ÿåº¦ä¼˜å…ˆï¼‰
- âœ… è‡ªåŠ¨å†³ç­–ï¼šåŸºäºé¡µé¢æ–‡æœ¬å¯†åº¦é€‰æ‹©ç­–ç•¥

### 6.2 å®æ–½ä¼˜å…ˆçº§

#### P0ï¼ˆå¿…é¡»ï¼‰- Phase 1æ ¸å¿ƒåŠŸèƒ½
- [x] ä»»åŠ¡1.1: æ‰©å±•æ–‡æœ¬æå–å‡½æ•°
- [x] ä»»åŠ¡1.2: æ–‡æœ¬ç±»å‹åˆ†ç±»å™¨
- [x] ä»»åŠ¡1.3: åŒæ æ£€æµ‹

#### P1ï¼ˆé‡è¦ï¼‰- Phase 1æ‰©å±•åŠŸèƒ½
- [ ] ä»»åŠ¡1.4: æ„å»ºæ–‡æœ¬åŒºå—
- [ ] ä»»åŠ¡1.5: è¯†åˆ«ç•™ç™½åŒºåŸŸ

#### P2ï¼ˆæ¬¡è¦ï¼‰- Phase 2é›†æˆ
- [ ] ä»»åŠ¡2.1: ä¿®æ”¹extract_figures()
- [ ] ä»»åŠ¡2.2: å›¾è¡¨åŒºåŸŸé¢„æµ‹

#### P3ï¼ˆå¯é€‰ï¼‰- Phase 3ä¼˜åŒ–
- [ ] ä»»åŠ¡3.1: å›å½’æµ‹è¯•
- [ ] ä»»åŠ¡3.2: å‚æ•°è°ƒä¼˜
- [ ] ä»»åŠ¡3.3: æ–‡æ¡£æ›´æ–°

### 6.3 æ—¶é—´è§„åˆ’

#### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰- å¯è¡Œæ€§éªŒè¯
- [ ] å®Œæˆä»»åŠ¡1.1-1.3ï¼ˆP0ä»»åŠ¡ï¼‰
- [ ] åœ¨1ä¸ªæµ‹è¯•PDFä¸ŠéªŒè¯æ–‡æœ¬åˆ†ç±»å‡†ç¡®ç‡
- [ ] å†³ç­–ï¼šæ˜¯å¦ç»§ç»­Phase 2

#### ä¸­æœŸï¼ˆ3-4å‘¨ï¼‰- æ ¸å¿ƒå¼€å‘
- [ ] å®Œæˆä»»åŠ¡1.4-1.5ï¼ˆP1ä»»åŠ¡ï¼‰
- [ ] å®Œæˆä»»åŠ¡2.1-2.2ï¼ˆP2ä»»åŠ¡ï¼‰
- [ ] åœ¨7ä¸ªæµ‹è¯•PDFä¸Šå¯¹æ¯”V1 vs V2

#### é•¿æœŸï¼ˆ5-6å‘¨ï¼‰- ä¼˜åŒ–ä¸Šçº¿
- [ ] å®ŒæˆPhase 3å…¨éƒ¨ä»»åŠ¡
- [ ] ç¼–å†™ç”¨æˆ·æ–‡æ¡£å’Œå¯è§†åŒ–å·¥å…·
- [ ] å‘å¸ƒV2.0ç‰ˆæœ¬

---

## ğŸ’­ ä¸ƒã€è®¨è®ºé—®é¢˜

### é—®é¢˜1: æ˜¯å¦ç«‹å³å¯åŠ¨å¼€å‘ï¼Ÿ
- **èµæˆ**: é•¿æœŸæ”¶ç›Šæ˜æ˜¾ï¼ŒæŠ€æœ¯å¯è¡Œ
- **åå¯¹**: å¼€å‘å‘¨æœŸé•¿ï¼ŒçŸ­æœŸæŠ•å…¥å¤§
- **å»ºè®®**: å…ˆåš1-2å‘¨çš„å¯è¡Œæ€§éªŒè¯ï¼ˆP0ä»»åŠ¡ï¼‰

### é—®é¢˜2: V1æ˜¯å¦ä¿ç•™ï¼Ÿ
- **å»ºè®®**: âœ… å¿…é¡»ä¿ç•™
- **ç†ç”±**: 
  - V2å¯èƒ½å¤±æ•ˆçš„åœºæ™¯ï¼ˆæ‰«æPDFã€å¤æ‚æ’ç‰ˆï¼‰
  - ç”¨æˆ·å¯èƒ½æ›´å–œæ¬¢V1çš„é€Ÿåº¦
  - ä½œä¸ºV2çš„éªŒæ”¶åŸºå‡†

### é—®é¢˜3: å¦‚ä½•å¹³è¡¡å‡†ç¡®ç‡å’Œé€Ÿåº¦ï¼Ÿ
- **V1**: 2.4s/å›¾ï¼Œå‡†ç¡®ç‡92%
- **V2**: 3.0s/å›¾ï¼ˆ+25%ï¼‰ï¼Œå‡†ç¡®ç‡97%ï¼ˆ+5%ï¼‰
- **å»ºè®®**: æä¾›`--fast`é€‰é¡¹å¼ºåˆ¶ä½¿ç”¨V1

### é—®é¢˜4: æ˜¯å¦éœ€è¦æœºå™¨å­¦ä¹ æ¨¡å‹ï¼Ÿ
- **å½“å‰**: åŸºäºè§„åˆ™çš„åˆ†ç±»å™¨
- **æœªæ¥**: å¯å¼•å…¥è½»é‡çº§MLæ¨¡å‹ï¼ˆå¦‚BERTæ–‡æœ¬åˆ†ç±»ï¼‰
- **å»ºè®®**: è§„åˆ™ä¼˜å…ˆï¼ŒåæœŸå¯é€‰MLå¢å¼º

---

## ğŸ“ å…«ã€æ€»ç»“

### æ ¸å¿ƒç»“è®º

1. âœ… **æŠ€æœ¯å¯è¡Œ**: åŸºäºç°æœ‰PyMuPDFèƒ½åŠ›ï¼Œå¯ä»¥å®ç°ç‰ˆå¼é©±åŠ¨æå–
2. âœ… **æ”¶ç›Šæ˜æ˜¾**: é¢„æœŸå‡†ç¡®ç‡æå‡4-6%ï¼Œè¯¯è£ç‡é™ä½70%
3. âš ï¸ **æˆæœ¬å¯æ§**: 4-6å‘¨å¼€å‘å‘¨æœŸï¼Œé€Ÿåº¦æŸå¤±20%
4. âœ… **é£é™©å¯ç®¡ç†**: ä¿ç•™V1ä½œä¸ºfallbackï¼Œæ¸è¿›å¼å¼•å…¥

### è¡ŒåŠ¨å»ºè®®

#### ç«‹å³è¡ŒåŠ¨ï¼ˆæœ¬å‘¨ï¼‰
1. âœ… è®¨è®ºæœ¬æ–¹æ¡ˆï¼Œè¾¾æˆå…±è¯†
2. âœ… å¯åŠ¨P0ä»»åŠ¡ï¼ˆä»»åŠ¡1.1-1.3ï¼‰
3. âœ… åœ¨1ä¸ªæµ‹è¯•PDFä¸ŠéªŒè¯å¯è¡Œæ€§

#### è¿‘æœŸè¡ŒåŠ¨ï¼ˆ2-4å‘¨ï¼‰
1. [ ] å®ŒæˆPhase 1ï¼ˆæ–‡æœ¬æå–å¢å¼ºï¼‰
2. [ ] åœ¨3ä¸ªæµ‹è¯•PDFä¸Šè¯„ä¼°æ•ˆæœ
3. [ ] å†³å®šæ˜¯å¦ç»§ç»­Phase 2

#### ä¸­æœŸç›®æ ‡ï¼ˆ6å‘¨å†…ï¼‰
1. [ ] å®ŒæˆV2æ¶æ„å…¨éƒ¨å¼€å‘
2. [ ] åœ¨7ä¸ªæµ‹è¯•PDFä¸Šå…¨é¢æµ‹è¯•
3. [ ] å‘å¸ƒV2.0-betaç‰ˆæœ¬

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-21  
**ç»´æŠ¤è€…**: PDF Summary Agent Team  
**çŠ¶æ€**: ğŸŸ¡ å¾…è®¨è®º

