# Robust é¢„è®¾å®Œæ•´å‚æ•°é…ç½®ä¸å·¥ä½œæµç¨‹

**æ–‡æ¡£æ—¥æœŸ**: 2025-10-27  
**è„šæœ¬ç‰ˆæœ¬**: extract_pdf_assets.py v2.5 (Layout-Driven Enhanced)  
**å‘½ä»¤**: `python3 scripts/extract_pdf_assets.py --pdf <path> --preset robust --debug-visual --layout-driven`

---

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°ç»„åˆ

```bash
python3 scripts/extract_pdf_assets.py \
  --pdf <PDF_PATH> \
  --preset robust \          # ç¨³å¥é¢„è®¾
  --debug-visual \           # å¯è§†åŒ–è°ƒè¯•
  --layout-driven            # ç‰ˆå¼é©±åŠ¨
```

---

## ğŸ¯ Robust é¢„è®¾è‡ªåŠ¨å¯ç”¨çš„å‚æ•°

### 1. åŸºç¡€æ¸²æŸ“å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--dpi` | **300** | PNG è¾“å‡ºåˆ†è¾¨ç‡ |
| `--clip-height` | **520.0 pt** | åŸºçº¿è£å‰ªçª—å£é«˜åº¦ |
| `--margin-x` | **26.0 pt** | å·¦å³è¾¹è· |
| `--caption-gap` | **6.0 pt** | å›¾æ³¨ä¸å›¾ç‰‡é—´è· |

### 2. é”šç‚¹æ‰«æï¼ˆAnchor V2ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--anchor-mode` | **v2** | å¤šå°ºåº¦æ»‘çª—é”šç‚¹ç­–ç•¥ |
| `--scan-step` | **14.0 pt** | å‚ç›´æ‰«ææ­¥é•¿ |
| `--scan-heights` | **240,320,420,520,640,720,820,920** | 7 ä¸ªçª—å£é«˜åº¦ |
| `--scan-dist-lambda` | **0.12** | è·ç¦»ç½šé¡¹æƒé‡ï¼ˆè¶Šå¤§è¶Šå€¾å‘ç´§é‚»ï¼‰ |
| `--caption-mid-guard` | **6.0 pt** | ç›¸é‚»å›¾æ³¨ä¸­çº¿æŠ¤æ  |

### 3. å…¨å±€é”šç‚¹ä¸€è‡´æ€§

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--global-anchor` | **auto** | å›¾ç‰‡ç»Ÿä¸€æ–¹å‘é¢„æ‰«æ |
| `--global-anchor-margin` | **0.02** (2%) | å›¾ç‰‡æ–¹å‘åˆ¤å®šé˜ˆå€¼ |
| `--global-anchor-table` | **auto** | è¡¨æ ¼ç»Ÿä¸€æ–¹å‘é¢„æ‰«æ |
| `--global-anchor-table-margin` | **0.03** (3%) | è¡¨æ ¼æ–¹å‘åˆ¤å®šé˜ˆå€¼ |

### 4. æ™ºèƒ½ Caption æ£€æµ‹

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--smart-caption-detection` | **True** | å››ç»´è¯„åˆ†åŒºåˆ†çœŸå®å›¾æ³¨ vs å¼•ç”¨ |
| `--debug-captions` | **False** | è¾“å‡ºå€™é€‰é¡¹è¯„åˆ†è¯¦æƒ…ï¼ˆéœ€æ‰‹åŠ¨å¯ç”¨ï¼‰ |

### 5. è‡ªé€‚åº”è¡Œé«˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--adaptive-line-height` | **True** | è‡ªåŠ¨æ£€æµ‹æ–‡æ¡£è¡Œé«˜å¹¶è°ƒæ•´é˜ˆå€¼ |
| åŠ¨æ€è°ƒæ•´çš„å‚æ•° | | åŸºäºæ£€æµ‹åˆ°çš„è¡Œé«˜ |
| - `adjacent_th` | **2.0 Ã— è¡Œé«˜** | ç´§é‚»æ–‡æœ¬é˜ˆå€¼ï¼ˆçº¦ 2 è¡Œï¼‰ |
| - `far_text_th` | **10.0 Ã— è¡Œé«˜** | è¿œè·æ–‡æœ¬æ£€æµ‹èŒƒå›´ï¼ˆçº¦ 10 è¡Œï¼‰ |
| - `far_side_min_dist` | **8.0 Ã— è¡Œé«˜** | è¿œä¾§æ–‡æœ¬æœ€å°è·ç¦»ï¼ˆçº¦ 8 è¡Œï¼‰ |
| - `text_trim_gap` | **0.5 Ã— è¡Œé«˜** | è£åˆ‡é—´è·ï¼ˆçº¦åŠè¡Œï¼‰ |
| - `object_merge_gap` | **0.5 Ã— è¡Œé«˜** | å¯¹è±¡åˆå¹¶é—´è·ï¼ˆçº¦åŠè¡Œï¼‰ |

---

## ğŸ”§ Phase A: æ–‡æœ¬é‚»æ¥è£åˆ‡ï¼ˆä¸‰é˜¶æ®µï¼‰

### Phase A1: ç´§é‚»æ–‡å­—è£åˆ‡

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--text-trim` | **True** | å¯ç”¨æ–‡æœ¬è£åˆ‡ |
| `--text-trim-width-ratio` | **0.5** (50%) | æœ€å°å®½åº¦å æ¯” |
| `--text-trim-font-min` | **7.0 pt** | æœ€å°å­—ä½“å¤§å° |
| `--text-trim-font-max` | **16.0 pt** | æœ€å¤§å­—ä½“å¤§å° |
| `--text-trim-gap` | **6.0 pt** (æˆ– 0.5Ã—è¡Œé«˜) | è£åˆ‡åé—´è· |
| `--adjacent-th` | **24.0 pt** (æˆ– 2.0Ã—è¡Œé«˜) | ç´§é‚»é˜ˆå€¼ |
| `--text-trim-min-para-ratio` | **0.18** (18%) | è§¦å‘è£åˆ‡çš„æ®µè½å æ¯” |

**æ£€æµ‹æ¡ä»¶**:
```python
è·ç¦»å›¾æ³¨ â‰¤ adjacent_th (24pt æˆ– 2è¡Œ)
AND å®½åº¦å æ¯” â‰¥ 50%
AND å­—ä½“ 7-16pt
```

### Phase A2: è¿‘ä¾§è¿œè·æ–‡å­—ï¼ˆåŒé˜ˆå€¼ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--far-text-th` | **300.0 pt** (æˆ– 10Ã—è¡Œé«˜) | è¿œè·æ–‡æœ¬æ£€æµ‹èŒƒå›´ |
| `--far-text-para-min-ratio` | **0.30** (30%) | è§¦å‘è£åˆ‡çš„æ®µè½å æ¯” |
| `--far-text-trim-mode` | **aggressive** | è£åˆ‡æ¨¡å¼ |

**æ£€æµ‹æ¡ä»¶**:
```python
adjacent_th < è·ç¦» â‰¤ far_text_th (24-300pt æˆ– 2-10è¡Œ)
AND ä½äºè¿‘ä¾§åŒºåŸŸï¼ˆé è¿‘å›¾æ³¨çš„ 50%ï¼‰
AND æ®µè½è¦†ç›–ç‡ â‰¥ 30%
```

### Phase A3: è¿œä¾§å¤§æ®µæ­£æ–‡

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--far-side-min-dist` | **100.0 pt** (æˆ– 8Ã—è¡Œé«˜) | è¿œä¾§æ–‡æœ¬æœ€å°è·ç¦» |
| `--far-side-para-min-ratio` | **0.20** (20%) | è§¦å‘è£åˆ‡çš„æ®µè½å æ¯” |

**æ£€æµ‹æ¡ä»¶**:
```python
è·ç¦»å›¾æ³¨ > far_side_min_dist (100pt æˆ– 8è¡Œ)
AND ä½äºè¿œä¾§åŒºåŸŸï¼ˆè¿œç¦»å›¾æ³¨çš„ 50%ï¼‰
AND æ®µè½è¦†ç›–ç‡ â‰¥ 20%
```

**å®‰å…¨é™åˆ¶**: æœ€å¤šè£é™¤ **50%** åŸå§‹çª—å£é«˜åº¦

---

## ğŸ”§ Phase B: å¯¹è±¡è¿é€šåŸŸå¯¹é½

### å›¾ç‰‡å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--object-pad` | **8.0 pt** | å¯¹è±¡å‘¨å›´ padding |
| `--object-min-area-ratio` | **0.012** (1.2%) | æœ€å°é¢ç§¯å æ¯” |
| `--object-merge-gap` | **6.0 pt** (æˆ– 0.5Ã—è¡Œé«˜) | åˆå¹¶é—´è· |
| `--refine-near-edge-only` | **True** | ä»…è°ƒæ•´é è¿‘å›¾æ³¨çš„è¾¹ |

### è¡¨æ ¼å‚æ•°ï¼ˆç‰¹åŒ–ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--table-object-min-area-ratio` | **0.005** (0.5%) | è¡¨æ ¼æœ€å°é¢ç§¯å æ¯”ï¼ˆæ›´å®½æ¾ï¼‰ |
| `--table-object-merge-gap` | **4.0 pt** | è¡¨æ ¼åˆå¹¶é—´è·ï¼ˆæ›´ç´§å‡‘ï¼‰ |

**æµç¨‹**:
1. æ”¶é›†çª—å£å†…é¢ç§¯ â‰¥ é˜ˆå€¼çš„å¯¹è±¡
2. åˆå¹¶è·ç¦» â‰¤ merge_gap çš„å¯¹è±¡
3. é€‰æ‹©è·å›¾æ³¨æœ€è¿‘çš„ç»„ä»¶ï¼ˆä¸»ç»„ä»¶ï¼‰
4. è®¡ç®—çºµå‘/æ¨ªå‘å¹¶é›†ï¼ˆä¿æŠ¤å¤šå­å›¾ï¼‰
5. ä»…è°ƒæ•´è¿‘ä¾§è¾¹ï¼ˆé»˜è®¤ï¼‰

---

## ğŸ”§ Phase D: æ–‡æœ¬æ©è†œè¾…åŠ©è‡ªåŠ¨è£å‰ª

### D1-D2: æ–‡æœ¬æ©è†œä¸åƒç´ çº§æ£€æµ‹

#### å›¾ç‰‡å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--autocrop` | **True** | å¯ç”¨è‡ªåŠ¨è£å‰ª |
| `--autocrop-pad` | **30 px** | å†…å®¹å‘¨å›´ padding |
| `--autocrop-white-th` | **250** | ç™½è¾¹æ£€æµ‹é˜ˆå€¼ï¼ˆRGBï¼‰ |
| `--autocrop-mask-text` | **True** | å¯ç”¨æ–‡æœ¬æ©è†œ |
| `--mask-font-max` | **14.0 pt** | æœ€å¤§æ©è†œå­—ä½“ |
| `--mask-width-ratio` | **0.5** (50%) | æœ€å°æ©è†œå®½åº¦å æ¯” |
| `--mask-top-frac` | **0.6** (60%) | è¿‘ä¾§æ©è†œåŒºåŸŸæ¯”ä¾‹ |

#### è¡¨æ ¼å‚æ•°ï¼ˆç‰¹åŒ–ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--table-autocrop` | **True** | å¯ç”¨è¡¨æ ¼è‡ªåŠ¨è£å‰ª |
| `--table-autocrop-pad` | **20 px** | è¡¨æ ¼ paddingï¼ˆæ›´ç´§å‡‘ï¼‰ |
| `--table-autocrop-white-th` | **250** | ç™½è¾¹æ£€æµ‹é˜ˆå€¼ |
| `--table-mask-text` | **False** | **ç¦ç”¨**è¡¨æ ¼æ–‡æœ¬æ©è†œ |

### D3-D5: è¾¹ç¼˜ä¿æŠ¤ä¸æ”¶ç¼©é™åˆ¶

#### å›¾ç‰‡å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--protect-far-edge-px` | **18 px** | è¿œç«¯è¾¹ä¿æŠ¤ï¼ˆé¿å…è¿‡è£ï¼‰ |
| `--near-edge-pad-px` | **32 px** | è¿‘ä¾§è¾¹å›æ‰©ï¼ˆä¿ç•™åæ ‡è½´ï¼‰ |
| `--autocrop-shrink-limit` | **0.30** (30%) | æœ€å¤§æ”¶ç¼©é¢ç§¯æ¯”ä¾‹ |
| `--autocrop-min-height-px` | **80 px** | æœ€å°é«˜åº¦é™åˆ¶ |

**è°ƒæ•´ç­–ç•¥**:
- å¦‚æœæ”¶ç¼© > 30% é¢ç§¯ â†’ å‘è¿‘ä¾§è¾¹æ‰©å±•å›å»
- å¦‚æœé«˜åº¦ < 80px â†’ å‘è¿‘ä¾§è¾¹æ‰©å±•
- è¿œç«¯è¾¹é¢å¤–ä¿ç•™ 18px â†’ é¿å…è½»å¾®è¿‡è£

---

## âœ… éªŒæ”¶ä¿æŠ¤æœºåˆ¶ï¼ˆ5 ç»´åº¦ + è¿œä¾§æ”¾å®½ï¼‰

### æ ‡å‡†éªŒæ”¶é—¨æ§›ï¼ˆæ— è¿œä¾§æ–‡å­—ï¼‰

| ç»´åº¦ | é˜ˆå€¼ | è¯´æ˜ |
|------|------|------|
| é«˜åº¦ä¿ç•™ç‡ | â‰¥ **60%** | ç²¾ç‚¼åé«˜åº¦ vs åŸºçº¿é«˜åº¦ |
| é¢ç§¯ä¿ç•™ç‡ | â‰¥ **55%** | ç²¾ç‚¼åé¢ç§¯ vs åŸºçº¿é¢ç§¯ |
| å¢¨è¿¹å¯†åº¦ä¿ç•™ç‡ | â‰¥ **90%** | ç²¾ç‚¼åå¢¨è¿¹ vs åŸºçº¿å¢¨è¿¹ |
| å¯¹è±¡è¦†ç›–ç‡ä¿ç•™ç‡ | â‰¥ **85%** | ç²¾ç‚¼åå¯¹è±¡è¦†ç›– vs åŸºçº¿è¦†ç›– |
| ç»„ä»¶æ•°é‡ä¿æŠ¤ | â‰¥ **min(2, åŸºçº¿ç»„ä»¶æ•°)** | å¤šå­å›¾ä¿æŠ¤ |

### è¿œä¾§æ–‡å­—åŠ¨æ€æ”¾å®½ï¼ˆåŸºäºè¿œä¾§è¦†ç›–ç‡ï¼‰

| è¿œä¾§è¦†ç›–ç‡ | é«˜åº¦é˜ˆå€¼ | é¢ç§¯é˜ˆå€¼ | å¢¨è¿¹é˜ˆå€¼ | è¦†ç›–ç‡é˜ˆå€¼ |
|-----------|---------|---------|---------|-----------|
| â‰¥60% | **35%** | **25%** | **70%** | **70%** |
| 30-60% | **45%** | **35%** | **75%** | **75%** |
| 18-30% | **50%** | **40%** | **80%** | **80%** |
| <18% | **60%** | **55%** | **90%** | **85%** |

**åŸç†**: å¦‚æœåŸºçº¿çª—å£åŒ…å«å¤§æ®µè¿œä¾§æ­£æ–‡ï¼ˆéœ€ Phase A3 ç§»é™¤ï¼‰ï¼Œæ”¾å®½éªŒæ”¶æ ‡å‡†ï¼Œå…è®¸æ›´å¤§å¹…åº¦æ”¶ç¼©ã€‚

### Fallback ç­–ç•¥

```mermaid
graph TD
    A[éªŒæ”¶å¤±è´¥] --> B{å°è¯• A-only}
    B -->|A-only é€šè¿‡| C[ä½¿ç”¨ A-only ç»“æœ]
    B -->|A-only å¤±è´¥| D[å›é€€åˆ° Baseline]
    C --> E[è¾“å‡ºæœ€ç»ˆå›¾ç‰‡]
    D --> E
```

**A-only Fallback æ¡ä»¶**:
- é«˜åº¦ä¿ç•™ç‡ â‰¥ 60% **AND** é¢ç§¯ä¿ç•™ç‡ â‰¥ 55%

---

## ğŸ¨ Debug Visual å‚æ•°ï¼ˆæ‰‹åŠ¨å¯ç”¨ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--debug-visual` | **True** | ç”Ÿæˆå¤šè‰²è¾¹ç•Œæ¡†å åŠ å›¾ |
| è¾“å‡ºç›®å½• | `images/debug/` | è‡ªåŠ¨åˆ›å»º |
| è¾“å‡ºæ–‡ä»¶ | `Figure_N_pX_debug_stages.png` | å½©è‰²è¾¹ç•Œæ¡† PNG |
| | `Figure_N_pX_legend.txt` | æ–‡å­—å›¾ä¾‹ |
| | `Table_N_pX_debug_stages.png` | è¡¨æ ¼è¾¹ç•Œæ¡† PNG |
| | `Table_N_pX_legend.txt` | è¡¨æ ¼å›¾ä¾‹ |

### è¾¹ç•Œæ¡†é¢œè‰²æ–¹æ¡ˆ

| é˜¶æ®µ | é¢œè‰² | RGB | çº¿å‹ |
|------|------|-----|------|
| **Baseline** (é”šç‚¹é€‰æ‹©) | ğŸ”µ è“è‰² | (0, 102, 255) | å®çº¿ |
| **Phase A** (æ–‡æœ¬è£åˆ‡) | ğŸŸ¢ ç»¿è‰² | (0, 200, 0) | å®çº¿ |
| **Phase B** (å¯¹è±¡å¯¹é½) | ğŸŸ  æ©™è‰² | (255, 140, 0) | å®çº¿ |
| **Phase D** (è‡ªåŠ¨è£å‰ª) | ğŸ”´ çº¢è‰² | (255, 0, 0) | å®çº¿ |
| **Fallback** (å›é€€) | ğŸŸ¡ é»„è‰² | (255, 255, 0) | è™šçº¿ |
| **Caption** (å›¾æ³¨) | ğŸŸ£ ç´«è‰² | (148, 0, 211) | å®çº¿ |
| **Text Blocks** (æ ‡é¢˜) | ğŸŸª ç²‰çº¢è‰² | (255, 105, 180) | å®çº¿ |
| **Text Blocks** (æ®µè½) | ğŸŸª ç²‰çº¢è‰² | (255, 105, 180) | è™šçº¿ |

---

## ğŸ“ Layout-Driven å‚æ•°ï¼ˆæ‰‹åŠ¨å¯ç”¨ï¼‰

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--layout-driven` | **True** | å¯ç”¨ç‰ˆå¼é©±åŠ¨æå–ï¼ˆV2ï¼‰ |
| `--layout-json` | `<out_dir>/layout_model.json` | ç‰ˆå¼æ¨¡å‹ä¿å­˜è·¯å¾„ |

### ç‰ˆå¼æ¨¡å‹æ„å»ºï¼ˆStep 1-2ï¼‰

#### 1.1 å¢å¼ºæ–‡æœ¬å•å…ƒæå–

**å­—æ®µ**:
- `bbox`: (x0, y0, x1, y1) è¾¹ç•Œæ¡†
- `text`: æ–‡æœ¬å†…å®¹
- `font_name`: å­—ä½“åç§°
- `font_size`: å­—å·
- `font_weight`: å­—é‡ï¼ˆç²—ä½“æ£€æµ‹ï¼‰
- `font_flags`: å­—ä½“æ ‡å¿—ä½
- `color`: RGB é¢œè‰²
- `text_type`: 9 ç§ç±»å‹
  - `title_h1`, `title_h2`, `title_h3`
  - `paragraph`, `list`
  - `caption_figure`, `caption_table`
  - `in_figure`, `formula`
- `column`: åˆ†æ ä¿¡æ¯ï¼ˆ-1=å•æ , 0=å·¦æ , 1=å³æ ï¼‰
- `confidence`: åˆ†ç±»ç½®ä¿¡åº¦

#### 1.2 æ–‡æ¡£å¸ƒå±€æ¨¡å‹

**å…¨å±€å±æ€§**:
- `page_size`: (width, height)
- `num_columns`: 1 æˆ– 2
- `margins`: (left, right, top, bottom)
- `column_gap`: åŒæ é—´è·
- `typical_font_size`: æ­£æ–‡å…¸å‹å­—å·ï¼ˆä¸­ä½æ•°ï¼‰
- `typical_line_height`: å…¸å‹è¡Œé«˜ï¼ˆä¸­ä½æ•°ï¼‰
- `typical_line_gap`: å…¸å‹è¡Œè·

**ç»“æ„æ•°æ®**:
- `text_units`: æŒ‰é¡µç»„ç»‡çš„å¢å¼ºæ–‡æœ¬å•å…ƒåˆ—è¡¨
- `text_blocks`: èšåˆçš„æ–‡æœ¬åŒºå—åˆ—è¡¨ï¼ˆæ®µè½ç»„/æ ‡é¢˜/åˆ—è¡¨ï¼‰
- `vacant_regions`: ç•™ç™½åŒºåŸŸåˆ—è¡¨ï¼ˆç½‘æ ¼åŒ–æ£€æµ‹ï¼‰

#### 1.3 æ–‡æœ¬åˆ†ç±»è§„åˆ™

```python
# Caption: ä»¥ "Figure/Table/å›¾/è¡¨ + ç¼–å·" å¼€å¤´
if re.match(r"^\s*(?:Figure|Table|å›¾|è¡¨)\s+\d+", text):
    text_type = 'caption_figure' or 'caption_table'

# Title: åŠ ç²— + ç›¸å¯¹å¤§å­—å·
if is_bold and (font_size > typical_font_size * 1.15):
    text_type = 'title_h1' / 'title_h2' / 'title_h3'

# In-Figure Text: å­—ä½“ä¸åŒ + å­—å·åå° + çŸ­æ–‡æœ¬ + çª„å®½åº¦
if (font_name != typical_font_name and 
    font_size < typical_font_size * 0.9 and 
    len(text) < 30 and 
    bbox.width < page_width * 0.4):
    text_type = 'in_figure'
```

### ç‰ˆå¼é©±åŠ¨åç½®è°ƒæ•´ï¼ˆStep 3ï¼‰

**è°ƒæ•´ç­–ç•¥**ï¼ˆä¸‰å±‚ä¿æŠ¤ï¼‰:

#### 1. ä¿æŠ¤å†…å®¹åŒºå—ï¼ˆé¿å…åˆ‡æ–­ï¼‰
```python
for block in text_blocks:
    overlap = clip & block.bbox
    if overlap_ratio > 0.5:  # è¢«æˆªè¶…è¿‡ä¸€åŠ
        if direction == 'above':
            clip.y1 = min(clip.y1, block.bbox.y0 - 5)  # å‘ä¸Šæ”¶ç¼©
        else:
            clip.y0 = max(clip.y0, block.bbox.y1 + 5)  # å‘ä¸‹æ”¶ç¼©
```

#### 2. é¿è®©å¤–éƒ¨åŒºå—ï¼ˆ<20% é‡å ï¼‰
```python
if direction == 'above' and block.bbox.y0 < clip.y0:
    overlap = clip & block.bbox
    if overlap_ratio > 0.20:
        clip.y0 = max(clip.y0, block.bbox.y1 + 5)
```

#### 3. æ ‡é¢˜æ•æ„Ÿæ€§ï¼ˆæ›´ä¿å®ˆï¼‰
- å¯¹ `title_h1/h2/h3` ç±»å‹çš„ blockï¼Œåªè¦æ¥è§¦ï¼ˆoverlap > 0ï¼‰å°±é¿è®©

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### Step 0: åˆå§‹åŒ–

```
1. æ‰“å¼€ PDF æ–‡æ¡£
2. æå–å…¨æ–‡æ–‡æœ¬ï¼ˆpdfminer.sixï¼‰
3. [layout-driven] æ„å»ºç‰ˆå¼æ¨¡å‹ï¼ˆStep 1-2ï¼‰
   - æå–å¢å¼ºæ–‡æœ¬å•å…ƒï¼ˆå­—ä½“/å­—å·/é¢œè‰²/ç±»å‹ï¼‰
   - æ£€æµ‹åˆ†æ æ•°é‡ï¼ˆå•æ /åŒæ ï¼‰
   - ç»Ÿè®¡å…¸å‹è¡Œé«˜/å­—å·/è¡Œè·
   - èšåˆæ–‡æœ¬åŒºå—ï¼ˆæ®µè½ç»„/æ ‡é¢˜/åˆ—è¡¨ï¼‰
   - è¯†åˆ«ç•™ç™½åŒºåŸŸï¼ˆç½‘æ ¼åŒ– + è¿é€šåˆ†é‡ï¼‰
4. [adaptive-line-height] è‡ªåŠ¨æ£€æµ‹è¡Œé«˜
   - é‡‡æ ·å‰ 5 é¡µ
   - ç»Ÿè®¡æ®µè½æ–‡æœ¬è¡Œ y é—´è· â†’ ä¸­ä½æ•° = typical_line_height
   - ç»Ÿè®¡å­—å·åˆ†å¸ƒï¼ˆ8-14ptï¼‰â†’ ä¸­ä½æ•° = typical_font_size
   - åŠ¨æ€è°ƒæ•´é˜ˆå€¼: adjacent_th=2Ã—è¡Œé«˜, far_text_th=10Ã—è¡Œé«˜
```

### Step 1: Caption ç´¢å¼•æ„å»º

```
1. [smart-caption-detection] æ‰«æå…¨æ–‡ï¼Œæ”¶é›†æ‰€æœ‰å€™é€‰é¡¹
   - å›¾ç‰‡: Figure 1-99, Figure S1-S9, Figure I-Vï¼ˆç½—é©¬æ•°å­—ï¼‰
   - è¡¨æ ¼: Table 1-99, Table S1-S9, Table I-V, Table A1-A9
2. å››ç»´è¯„åˆ†ï¼ˆæ€»åˆ† 100ï¼‰
   - ä½ç½®ç‰¹å¾ (40åˆ†): è·å›¾åƒ/ç»˜å›¾å¯¹è±¡çš„è·ç¦»
   - æ ¼å¼ç‰¹å¾ (30åˆ†): åŠ ç²—(15) + ç‹¬ç«‹æˆæ®µ(10) + æ ‡ç‚¹(5)
   - ç»“æ„ç‰¹å¾ (20åˆ†): ä¸‹ä¸€è¡Œæè¿°(12) + æ®µè½é•¿åº¦(8)
   - ä¸Šä¸‹æ–‡ç‰¹å¾ (10åˆ†): å›¾æ³¨å…³é”®è¯(+10) vs å¼•ç”¨å…³é”®è¯(-15)
3. é€‰æ‹©å¾—åˆ†æœ€é«˜çš„å€™é€‰ï¼ˆâ‰¥25åˆ†ï¼‰
```

### Step 2: å…¨å±€é”šç‚¹ä¸€è‡´æ€§é¢„æ‰«æ

```
1. [global-anchor] å›¾ç‰‡é¢„æ‰«æ
   - éå†æ‰€æœ‰å›¾æ³¨ï¼Œå¯¹æ¯ä¸ªå›¾æ³¨ç”Ÿæˆä¸Šæ–¹/ä¸‹æ–¹å€™é€‰çª—å£
   - è¯„åˆ†: 0.55Ã—å¢¨è¿¹ + 0.25Ã—å¯¹è±¡è¦†ç›– - 0.20Ã—æ®µè½
   - ç´¯è®¡: above_total vs below_total
   - åˆ¤å®š: å¦‚æœ below_total > above_total Ã— (1+0.02) â†’ ç»Ÿä¸€ BELOW
   
2. [global-anchor-table] è¡¨æ ¼é¢„æ‰«æï¼ˆç‹¬ç«‹ï¼‰
   - è¡¨æ ¼ä¸“ç”¨è¯„åˆ†: 0.4Ã—å¢¨è¿¹ + 0.25Ã—åˆ—å¯¹é½ + 0.2Ã—çº¿å¯†åº¦ + 0.15Ã—å¯¹è±¡
   - ç´¯è®¡: above_total vs below_total
   - åˆ¤å®š: å¦‚æœ below_total > above_total Ã— (1+0.03) â†’ ç»Ÿä¸€ BELOW
```

### Step 3: é€ä¸ªå›¾è¡¨æå–

#### 3.1 Anchor V2 å¤šå°ºåº¦çª—å£æ‰«æ

```
1. æ ¹æ®å…¨å±€é”šç‚¹æ–¹å‘ï¼Œç¡®å®šæ‰«ææ–¹å‘ï¼ˆABOVE/BELOWï¼‰
2. å¯¹ 7 ä¸ªé«˜åº¦ï¼ˆ240,320,420,520,640,720,820ï¼‰Ã— æ­¥é•¿14pt æ»‘çª—
3. æ¯ä¸ªå€™é€‰çª—å£è¯„åˆ†
   - å›¾ç‰‡: 0.55Ã—å¢¨è¿¹ + 0.25Ã—å¯¹è±¡ - 0.20Ã—æ®µè½ + 0.08Ã—ç»„ä»¶
   - è¡¨æ ¼: 0.5Ã—å¢¨è¿¹ + 0.2Ã—åˆ—å¯¹é½ + 0.15Ã—çº¿å¯†åº¦ + 0.15Ã—å¯¹è±¡ - 0.25Ã—æ®µè½
   - å‡å»è·ç¦»ç½šé¡¹: scan_dist_lambda Ã— (è·ç¦» / é¡µé«˜)
4. éµå®ˆä¸­çº¿æŠ¤æ ï¼ˆä¸è·¨è¶Šç›¸é‚»å›¾æ³¨ä¸­çº¿Â±6ptï¼‰
5. é€‰æ‹©æœ€é«˜åˆ†çª—å£ + è¾¹ç¼˜å¸é™„ï¼ˆæ¨ªå‘çº¿æ®µ Â±14ptï¼‰
```

#### 3.2 Phase A: ä¸‰é˜¶æ®µæ–‡æœ¬è£åˆ‡

```
1. Phase A1: ç§»é™¤ç´§é‚»æ–‡å­—ï¼ˆ<2è¡Œï¼Œ24ptï¼‰
   - æ£€æµ‹: è·ç¦»â‰¤24pt, å®½åº¦â‰¥50%, å­—å·7-16pt
   - è£åˆ‡: å‘è¿‘ä¾§æ”¶ç¼©ï¼Œæœ€å¤š25%é«˜åº¦
   
2. Phase A2: ç§»é™¤è¿‘ä¾§è¿œè·æ–‡å­—ï¼ˆ2-10è¡Œï¼Œ24-300ptï¼‰
   - æ£€æµ‹: è·ç¦»24-300pt, è¿‘ä¾§50%, è¦†ç›–ç‡â‰¥30%
   - è£åˆ‡: å‘è¿‘ä¾§æ”¶ç¼©ï¼Œæœ€å¤š60%é«˜åº¦
   
3. Phase A3: ç§»é™¤è¿œä¾§å¤§æ®µæ­£æ–‡ï¼ˆ>8è¡Œï¼Œ>100ptï¼‰
   - æ£€æµ‹: è·ç¦»>100pt, è¿œä¾§50%, è¦†ç›–ç‡â‰¥20%
   - è£åˆ‡: å‘è¿œä¾§æ”¶ç¼©ï¼Œæœ€å¤š50%é«˜åº¦
```

#### 3.3 Phase B: å¯¹è±¡è¿é€šåŸŸå¯¹é½

```
1. æ”¶é›†çª—å£å†…å¯¹è±¡ï¼ˆé¢ç§¯â‰¥1.2%ï¼‰
2. åˆå¹¶è¿‘è·å¯¹è±¡ï¼ˆé—´è·â‰¤6ptï¼‰
3. é€‰æ‹©è·å›¾æ³¨æœ€è¿‘çš„ç»„ä»¶ï¼ˆä¸»ç»„ä»¶ï¼‰
4. è®¡ç®—çºµå‘/æ¨ªå‘å¹¶é›†ï¼ˆä¿æŠ¤å¤šå­å›¾ï¼‰
5. ä»…è°ƒæ•´è¿‘ä¾§è¾¹ï¼ˆé»˜è®¤ï¼‰
6. [è¿œç«¯å¤–æ‰©] å¦‚æœè¿œç«¯è¾¹æœ‰å¯¹è±¡è´´è¾¹ï¼ˆâ‰¤2ptï¼‰â†’ å¤–æ‰©60ptï¼ˆæœ€å¤š200ptï¼‰
```

#### 3.4 Phase D: æ–‡æœ¬æ©è†œè¾…åŠ©è‡ªåŠ¨è£å‰ª

```
1. [autocrop-mask-text] æ„å»ºæ–‡æœ¬æ©è†œ
   - æ£€æµ‹èŒƒå›´: è¿‘ä¾§60%åŒºåŸŸ
   - æ©è†œæ¡ä»¶: å­—å·â‰¤14pt, å®½åº¦â‰¥50%
   - æ•ˆæœ: å°†æ®µè½æ–‡å­—æ ‡è®°ä¸ºç™½è‰²ï¼ˆå¿½ç•¥å¢¨è¿¹ï¼‰
   
2. åƒç´ çº§ç™½è¾¹æ£€æµ‹
   - æŒ‰è¡Œ/åˆ—å­é‡‡æ ·æ‰«æï¼ˆæ­¥é•¿ = max(1, w//1000)ï¼‰
   - æ£€æµ‹éç™½è‰²åƒç´ ï¼ˆRGB < 250ï¼‰
   - æ”¶ç¼©åˆ°åŒ…å›´ç›’ + 30px padding
   
3. è¿œç«¯è¾¹ä¿æŠ¤: +18px
4. è¿‘ä¾§è¾¹å›æ‰©: +32pxï¼ˆä¸è¶Šè¿‡å›¾æ³¨è¾¹ç•Œï¼‰
5. æ”¶ç¼©é™åˆ¶: æœ€å¤š30%é¢ç§¯, æœ€å°80pxé«˜åº¦
```

#### 3.5 éªŒæ”¶ä¿æŠ¤ + Fallback

```
1. è®¡ç®—è¿œä¾§è¦†ç›–ç‡ â†’ åŠ¨æ€æ”¾å®½é˜ˆå€¼
2. 5ç»´åº¦æ£€æŸ¥: é«˜åº¦/é¢ç§¯/å¢¨è¿¹/å¯¹è±¡è¦†ç›–/ç»„ä»¶æ•°
3. å¦‚æœä¸é€šè¿‡:
   a. å°è¯• A-only (ä»…æ–‡æœ¬è£åˆ‡)
   b. å¦‚æœ A-only ä¹Ÿå¤±è´¥ â†’ Baselineï¼ˆåŸå§‹çª—å£ï¼‰
```

#### 3.6 [layout-driven] ç‰ˆå¼é©±åŠ¨åç½®è°ƒæ•´

```
1. æ£€æµ‹æœ€ç»ˆclipä¸æ–‡æœ¬åŒºå—çš„é‡å 
2. å¦‚æœåŒºå—è¢«æˆªæ–­>50% â†’ æ”¶ç¼©clipé¿å¼€åŒºå—
3. å¦‚æœå¤–éƒ¨åŒºå—é‡å >20% â†’ æ”¶ç¼©clipå‡å°‘é‡å 
4. æ ‡é¢˜æ•æ„Ÿæ€§: åªè¦æ¥è§¦å°±é¿è®©
```

#### 3.7 æ¸²æŸ“ä¸è¾“å‡º

```
1. æŒ‰ DPI=300 æ¸²æŸ“ PDF é¡µé¢åˆ° PNG
2. è£åˆ‡åˆ°æœ€ç»ˆclipè¾¹ç•Œ
3. å‘½å: Figure_N_<æè¿°>.png / Table_N_<æè¿°>.png
4. [debug-visual] ç”Ÿæˆè°ƒè¯•å¯è§†åŒ–:
   - Figure_N_pX_debug_stages.png (å½©è‰²è¾¹ç•Œæ¡†å åŠ )
   - Figure_N_pX_legend.txt (æ–‡å­—å›¾ä¾‹)
5. å†™å…¥ index.jsonï¼ˆå›¾è¡¨æ¸…å•ï¼‰
```

### Step 4: è´¨é‡æ£€æŸ¥ï¼ˆQCï¼‰

```
1. ç»Ÿè®¡æå–æ•°é‡: figures=X, tables=Y, total=Z
2. å¼±å¯¹é½ç»Ÿè®¡: ä» text/*.txt ç»Ÿè®¡ Figure/Table/å›¾/è¡¨ å‡ºç°æ¬¡æ•°
3. è¾“å‡ºå¯¹æ¯”: æå–æ•°é‡ vs æ–‡æœ¬ç»Ÿè®¡ï¼ˆä¾›å‚è€ƒï¼‰
```

---

## ğŸ“Š å‚æ•°å½±å“çŸ©é˜µ

### æé«˜å‡†ç¡®ç‡ vs é™ä½ Fallback ç‡

| è°ƒæ•´ç›®æ ‡ | å‚æ•° | æ–¹å‘ | å½±å“ |
|---------|------|------|------|
| **å‡å°‘è¯¯è£** | `--autocrop-shrink-limit` | â†‘ 0.35 | æ”¾å®½æ”¶ç¼©é™åˆ¶ |
| | `--autocrop-min-height-px` | â†‘ 90 | æé«˜æœ€å°é«˜åº¦ |
| | `--protect-far-edge-px` | â†‘ 20-24 | è¿œç«¯ä¿ç•™æ›´å¤š |
| **å‡å°‘é—æ¼** | `--scan-heights` | + 920 | åŒ…å«æ›´é«˜çš„å›¾ |
| | `--object-min-area-ratio` | â†“ 0.008 | æ•è·æ›´å°å¯¹è±¡ |
| **å‡å°‘æ­£æ–‡æ··å…¥** | `--far-side-para-min-ratio` | â†“ 0.15 | æ›´æ¿€è¿›ç§»é™¤è¿œä¾§ |
| | `--mask-top-frac` | â†‘ 0.7 | æ‰©å¤§æ©è†œèŒƒå›´ |
| **å›¾æ³¨å¯†é›†é¡µ** | `--caption-mid-guard` | â†‘ 8-12 | é˜²è·¨å›¾ |
| | `--scan-dist-lambda` | â†‘ 0.15-0.18 | ä¼˜å…ˆç´§é‚» |

---

## ğŸ¯ é€‚ç”¨åœºæ™¯ä¸æ¨èé…ç½®

### åœºæ™¯A: æ ‡å‡†å­¦æœ¯è®ºæ–‡ï¼ˆé»˜è®¤ï¼‰
```bash
--preset robust --debug-visual --layout-driven
```

### åœºæ™¯B: å¯†é›†å›¾æ³¨é¡µï¼ˆå›¾è¡¨ç´§å‡‘æ’åˆ—ï¼‰
```bash
--preset robust \
  --caption-mid-guard 10 \
  --scan-dist-lambda 0.18 \
  --object-merge-gap 8 \
  --debug-visual --layout-driven
```

### åœºæ™¯C: ç†è®ºè®ºæ–‡ï¼ˆå›¾å°‘ã€æ–‡å­—å¤šï¼‰
```bash
--preset robust \
  --text-trim-min-para-ratio 0.25 \
  --adjacent-th 32 \
  --mask-top-frac 0.7 \
  --far-side-para-min-ratio 0.15 \
  --debug-visual --layout-driven
```

### åœºæ™¯D: å¤æ‚æ’ç‰ˆï¼ˆä¸è§„èŒƒå›¾æ³¨ï¼‰
```bash
--preset robust \
  --layout-driven \
  --debug-visual \
  --debug-captions \
  --no-smart-caption-detection  # ä½¿ç”¨ç®€å•åŒ¹é…
```

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†ï¼ˆRobust é¢„è®¾ï¼‰

| æŒ‡æ ‡ | å€¼ |
|------|-----|
| **å‡†ç¡®ç‡ï¼ˆå®Œæ•´æå–ï¼‰** | 92.1% |
| **è¯¯è£ç‡ï¼ˆåŠå¹…/è¿‡è£ï¼‰** | 1.8% |
| **å¤šå­å›¾å®Œæ•´ç‡** | 94.0% |
| **Fallback ç‡** | ~18-20% |
| **å¹³å‡è€—æ—¶/å›¾** | 2.4s |
| **èµ„æºéœ€æ±‚** | CPU-only, <100MB |

---

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### é—®é¢˜1: å›¾ç‰‡æˆªä¸å®Œæ•´

**ç—‡çŠ¶**: å›¾ç‰‡é¡¶éƒ¨æˆ–åº•éƒ¨è¢«è£æ‰  
**è¯Šæ–­**: æŸ¥çœ‹ `debug/Figure_N_pX_debug_stages.png`ï¼Œå¯¹æ¯”çº¢è‰²ï¼ˆæœ€ç»ˆï¼‰ä¸è“è‰²ï¼ˆåŸºçº¿ï¼‰  
**è§£å†³æ–¹æ¡ˆ**:
```bash
--scan-heights 240,320,420,520,640,720,820,920  # å¢åŠ 920
--protect-far-edge-px 24                         # è¿œç«¯ä¿ç•™æ›´å¤š
--autocrop-shrink-limit 0.35                     # æ”¾å®½æ”¶ç¼©
```

### é—®é¢˜2: åŒ…å«è¿‡å¤šæ­£æ–‡

**ç—‡çŠ¶**: å›¾ç‰‡ä¸Šæ–¹æœ‰ Abstract/Introduction ç­‰å¤§æ®µæ–‡å­—  
**è¯Šæ–­**: æŸ¥çœ‹ legend.txt ä¸­çš„ "Far-side trim" æ—¥å¿—  
**è§£å†³æ–¹æ¡ˆ**:
```bash
--far-side-para-min-ratio 0.15  # æ›´æ¿€è¿›ç§»é™¤ï¼ˆé»˜è®¤0.20ï¼‰
--far-text-th 400               # æ‰©å¤§æ£€æµ‹èŒƒå›´ï¼ˆé»˜è®¤300ï¼‰
```

### é—®é¢˜3: é«˜ Fallback ç‡ï¼ˆ>30%ï¼‰

**ç—‡çŠ¶**: å¤§é‡ "refinement rejected" è­¦å‘Š  
**è¯Šæ–­**: æŸ¥çœ‹éªŒæ”¶å¤±è´¥åŸå› ï¼ˆheight/area/ink/covï¼‰  
**è§£å†³æ–¹æ¡ˆ**:
```bash
--autocrop-shrink-limit 0.40    # å…è®¸æ›´å¤§æ”¶ç¼©
--mask-top-frac 0.5             # å‡å°‘æ©è†œèŒƒå›´
--object-merge-gap 4            # å‡å°åˆå¹¶é—´è·
```

### é—®é¢˜4: å¤šå­å›¾è¢«è£æˆå•å›¾

**ç—‡çŠ¶**: (a)(b)(c) å­å›¾åªä¿ç•™äº†ä¸€ä¸ª  
**è¯Šæ–­**: Phase B çš„ç»„ä»¶åˆå¹¶è¿‡åº¦  
**è§£å†³æ–¹æ¡ˆ**:
```bash
--object-merge-gap 4            # å‡å°åˆå¹¶é—´è·ï¼ˆé»˜è®¤6ï¼‰
--no-refine 2,3                 # å¯¹ç‰¹å®šå›¾ç¦ç”¨ç²¾ç‚¼
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **å·¥ä½œæµæŒ‡å—** | `AGENTS.md` | é¢å‘å¤§æ¨¡å‹çš„ä½¿ç”¨æŒ‡å— |
| **æŠ€æœ¯æ€»ç»“** | `docs/PDFå›¾è¡¨æå–æŠ€æœ¯æ€»ç»“-20251025-v2.md` | è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£ |
| **æ‰¹é‡æµ‹è¯•æŠ¥å‘Š** | `tests/basic-benchmark/æ‰¹é‡æå–æŠ¥å‘Š-20251027.md` | 7ä¸ªPDFçš„æµ‹è¯•ç»“æœ |
| **è„šæœ¬æºç ** | `scripts/extract_pdf_assets.py` | å®Œæ•´ä»£ç ï¼ˆ5103è¡Œï¼‰ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç”Ÿæˆæ—¶é—´**: 2025-10-27  
**ç»´æŠ¤è€…**: PDF Summary Agent Team

