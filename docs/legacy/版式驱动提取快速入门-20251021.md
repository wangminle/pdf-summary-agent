# ç‰ˆå¼é©±åŠ¨æå–ï¼ˆV2ï¼‰å¿«é€Ÿå…¥é—¨

**æ—¥æœŸ**: 2025-10-21  
**åŠŸèƒ½**: Layout-Driven Extraction (V2 Architecture)

---

## ğŸ¯ ä»€ä¹ˆæ˜¯ç‰ˆå¼é©±åŠ¨æå–ï¼Ÿ

ç‰ˆå¼é©±åŠ¨æå–ï¼ˆV2ï¼‰æ˜¯ä¸€ç§**æ›´æ™ºèƒ½çš„PDFå›¾è¡¨æå–æ–¹æ³•**ï¼Œå®ƒä¼šï¼š

1. **å…ˆåˆ†ææ•´ä¸ªæ–‡æ¡£çš„ç‰ˆå¼ç»“æ„**
   - è¯†åˆ«æ–‡æœ¬ç±»å‹ï¼ˆæ ‡é¢˜ã€æ®µè½ã€å›¾æ³¨ã€è¡¨æ³¨ã€åˆ—è¡¨ã€å…¬å¼ï¼‰
   - æ£€æµ‹å•æ /åŒæ å¸ƒå±€
   - å®šä½æ–‡æœ¬å¯†é›†åŒºåŸŸå’Œç•™ç™½åŒºåŸŸ

2. **å†ç”¨ç‰ˆå¼ä¿¡æ¯æŒ‡å¯¼å›¾è¡¨æå–**
   - æ›´ç²¾ç¡®çš„å›¾è¡¨è¾¹ç•Œå®šä½
   - æ›´å¥½çš„æ–‡æœ¬å»é™¤æ•ˆæœ
   - æ›´å‡†ç¡®çš„å›¾æ³¨è¯†åˆ«

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€ç”¨æ³•

```bash
# å¯ç”¨ç‰ˆå¼é©±åŠ¨æå–
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven
```

### æŸ¥çœ‹æ–‡æœ¬åŒºå—å¯è§†åŒ–

```bash
# åŒæ—¶å¯ç”¨debugå¯è§†åŒ–ï¼Œåœ¨PNGå›¾ä¸Šçœ‹åˆ°ç²‰çº¢è‰²æ–‡æœ¬åŒºå—
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

### å®Œæ•´ç¤ºä¾‹

```bash
# æœ€å®Œæ•´çš„å‘½ä»¤ï¼ˆåŒ…å«æ‰€æœ‰è°ƒè¯•ä¿¡æ¯ï¼‰
python3 scripts/extract_pdf_assets.py \
  --pdf tests/basic-benchmark/1706.03762v7-attention_is_all_you_need/1706.03762v7-attention_is_all_you_need.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual \
  --debug-captions
```

---

## ğŸ“‚ è¾“å‡ºæ–‡ä»¶

### æ–°å¢æ–‡ä»¶

å¯ç”¨`--layout-driven`åï¼Œä¼šé¢å¤–ç”Ÿæˆï¼š

```
<pdf_dir>/images/
â””â”€â”€ layout_model.json        # ç‰ˆå¼æ¨¡å‹JSONæ–‡ä»¶
```

**å†…å®¹ç¤ºä¾‹**:
```json
{
  "page_size": [612.0, 792.0],
  "num_columns": 2,              // åŒæ æ–‡æ¡£
  "typical_metrics": {
    "font_size": 10.0,           // æ­£æ–‡å­—å·
    "line_height": 10.0,         // è¡Œé«˜
    "line_gap": 0.9              // è¡Œè·
  },
  "text_units_count": {          // æ¯é¡µçš„æ–‡æœ¬å•å…ƒæ•°
    "0": 56, "1": 53, ...
  },
  "text_blocks_count": {         // æ¯é¡µçš„æ–‡æœ¬åŒºå—æ•°
    "0": 6, "1": 3, ...
  }
}
```

### Debugå¯è§†åŒ–å¢å¼º

å¦‚æœåŒæ—¶å¯ç”¨`--debug-visual`ï¼Œåœ¨`images/debug/`ç›®å½•ä¸‹çš„PNGå›¾ç‰‡ä¸­ï¼š

- **ç²‰çº¢è‰²è™šçº¿æ¡†**: æ ‡è¯†æ–‡æœ¬åŒºå—ï¼ˆV2æ–°å¢ï¼‰
- **è“è‰²æ¡†**: åŸºçº¿çª—å£
- **çº¢è‰²æ¡†**: æœ€ç»ˆè£å‰ªç»“æœ
- **ç´«è‰²æ¡†**: å›¾æ³¨ä½ç½®

**Legendæ–‡ä»¶ç¤ºä¾‹** (`Figure_1_p3_legend.txt`):
```
======================================================================
TEXT BLOCKS (Layout Model - V2 Architecture)
======================================================================
Total text blocks on this page: 5
Color: RGB(255, 105, 180) - Hot Pink (dashed line)

Text Block 1 (paragraph_group):
  Position: 107.7,436.8 -> 505.2,493.0
  Size: 397.6Ã—56.2pt (4.31 sq.in)
  Column: 0 (-1=single, 0=left, 1=right)
  Text units: 4
  Sample: The Transformer follows this overall...
```

---

## âš™ï¸ å‘½ä»¤è¡Œå‚æ•°

### V2 ä¸“ç”¨å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--layout-driven` | å¯ç”¨ç‰ˆå¼é©±åŠ¨æå–ï¼ˆV2ï¼‰ | ç¦ç”¨ |
| `--layout-json <path>` | æŒ‡å®šlayout_model.jsonä¿å­˜è·¯å¾„ | `<out_dir>/layout_model.json` |

### ä¸ç°æœ‰å‚æ•°ç»„åˆ

```bash
# V2 + ç¨³å¥é¢„è®¾
--preset robust --layout-driven

# V2 + debugå¯è§†åŒ–
--layout-driven --debug-visual

# V2 + captionè°ƒè¯•
--layout-driven --debug-captions

# V2 + è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„
--layout-driven --layout-json custom_layout.json
```

---

## ğŸ” å®é™…æ•ˆæœ

### ç¤ºä¾‹ï¼šAttentionè®ºæ–‡

**å‘½ä»¤**:
```bash
python3 scripts/extract_pdf_assets.py \
  --pdf tests/basic-benchmark/1706.03762v7-attention_is_all_you_need/1706.03762v7-attention_is_all_you_need.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

**è¾“å‡º**:
```
======================================================================
LAYOUT-DRIVEN EXTRACTION (V2 Architecture)
======================================================================

[SUMMARY] Layout Model Built Successfully
  - Pages analyzed: 15
  - Total text units: 1048
  - Total text blocks: 96
  - Columns: 2 (double)          ğŸ‘ˆ è‡ªåŠ¨æ£€æµ‹åˆ°åŒæ 
  - Column gap: -456.4pt
  - Typical font: 10.0pt
  - Line height: 10.0pt

[INFO] Layout model saved to:
  tests/.../images/layout_model.json

[Page 1] Classifying 56 text units...
  TITLE_H1: Attention Is All You Need...     ğŸ‘ˆ è¯†åˆ«æ ‡é¢˜
  TITLE_H2: Abstract...                      ğŸ‘ˆ è¯†åˆ«äºŒçº§æ ‡é¢˜
  Caption: Figure 1: The Transformer...      ğŸ‘ˆ è¯†åˆ«å›¾æ³¨

Detected TWO columns:                         ğŸ‘ˆ åŒæ æ£€æµ‹
  Left column x0 â‰ˆ 107.4pt
  Right column x0 â‰ˆ 131.5pt

[Page 1] Created 6 text blocks                ğŸ‘ˆ æ–‡æœ¬åŒºå—èšåˆ
```

**ç”Ÿæˆçš„æ–‡ä»¶**:
- âœ… 5ä¸ªFigure PNGï¼ˆFigure_1_xxx.png ~ Figure_5_xxx.pngï¼‰
- âœ… 4ä¸ªTable PNGï¼ˆTable_1_xxx.png ~ Table_4_xxx.pngï¼‰
- âœ… layout_model.jsonï¼ˆç‰ˆå¼æ¨¡å‹ï¼‰
- âœ… 5ä¸ªdebug PNG + legend.txtï¼ˆå¦‚æœå¯ç”¨--debug-visualï¼‰

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### ä½•æ—¶ä½¿ç”¨V2ï¼Ÿ

**æ¨èä½¿ç”¨V2çš„åœºæ™¯**:
- âœ… åŒæ è®ºæ–‡ï¼ˆæœŸåˆŠè®ºæ–‡ã€ä¼šè®®è®ºæ–‡ï¼‰
- âœ… å¤æ‚æ’ç‰ˆï¼ˆå¤šçº§æ ‡é¢˜ã€åˆ—è¡¨ã€å…¬å¼æ··æ’ï¼‰
- âœ… å›¾è¡¨å¯†é›†ï¼ˆéœ€è¦ç²¾ç¡®åŒºåˆ†æ–‡æœ¬åŒºåŸŸå’Œå›¾è¡¨åŒºåŸŸï¼‰
- âœ… éœ€è¦è°ƒè¯•å¯è§†åŒ–ï¼ˆæŸ¥çœ‹æ–‡æœ¬åŒºå—åˆ†å¸ƒï¼‰

**æš‚æ—¶ä½¿ç”¨V1çš„åœºæ™¯**:
- ğŸ“„ ç®€å•å•æ æ–‡æ¡£
- ğŸš€ è¿½æ±‚æœ€å¿«é€Ÿåº¦ï¼ˆV2ä¼šå¢åŠ çº¦10-20%å¤„ç†æ—¶é—´ï¼‰
- ğŸ”§ ä¸éœ€è¦ç‰ˆå¼åˆ†æ

### æ€§èƒ½è€ƒè™‘

| æ¨¡å¼ | å¤„ç†æ—¶é—´ | å†…å­˜å ç”¨ | ç²¾ç¡®åº¦ |
|------|---------|---------|--------|
| V1 (é»˜è®¤) | åŸºçº¿ | åŸºçº¿ | é«˜ |
| V2 (--layout-driven) | +10~20% | +15~30% | æ›´é«˜ |

**å»ºè®®**:
1. å…ˆç”¨V1å¿«é€Ÿæµ‹è¯•
2. å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œå¯ç”¨V2
3. å¦‚æœéœ€è¦è°ƒè¯•ï¼ŒåŠ ä¸Š`--debug-visual`

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: æç¤º"NumPy not available"

**ç°è±¡**:
```
[DEBUG] Column Detection
NumPy not available, assuming single column
```

**åŸå› **: æœªå®‰è£…numpyï¼Œè·³è¿‡åŒæ æ£€æµ‹

**è§£å†³**:
```bash
# å®‰è£…numpyï¼ˆå¯é€‰ï¼‰
python3 -m pip install --user numpy
```

**å½±å“**: ä»å¯æ­£å¸¸å·¥ä½œï¼Œä½†æ— æ³•æ£€æµ‹åŒæ ï¼Œä¼šå‡è®¾å•æ 

---

### é—®é¢˜2: æç¤º"NumPy/SciPy not available, skipping vacant region detection"

**ç°è±¡**:
```
[DEBUG] Detecting Vacant Regions
[Page 1] NumPy/SciPy not available, skipping vacant region detection
```

**åŸå› **: æœªå®‰è£…scipyï¼Œè·³è¿‡ç•™ç™½åŒºåŸŸæ£€æµ‹

**è§£å†³**:
```bash
# å®‰è£…scipyï¼ˆå¯é€‰ï¼‰
python3 -m pip install --user scipy
```

**å½±å“**: ä»å¯æ­£å¸¸å·¥ä½œï¼Œä½†`vacant_regions`ä¸ºç©º

---

### é—®é¢˜3: åŒæ æ£€æµ‹ä¸å‡†ç¡®

**ç°è±¡**: å•æ æ–‡æ¡£è¢«æ£€æµ‹ä¸ºåŒæ ï¼Œæˆ–åä¹‹

**åŸå› **: é¡µé¢æ’ç‰ˆç‰¹æ®Šï¼ˆå¦‚é¦–é¡µå•æ ã€åç»­åŒæ ï¼‰

**è°ƒè¯•**:
```bash
# å¯ç”¨debugæ¨¡å¼æŸ¥çœ‹è¯¦æƒ…
--debug-captions
```

**ä¸´æ—¶æ–¹æ¡ˆ**: æš‚æ—¶ä½¿ç”¨V1ï¼ˆä¸åŠ `--layout-driven`ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®Œæ•´æŠ€æœ¯æ–‡æ¡£**: `docs/technical-review/ç‰ˆå¼é©±åŠ¨æå–åŠŸèƒ½å®æ–½æ€»ç»“-20251021.md`
- **æ–¹æ¡ˆè®ºè¯**: `docs/technical-review/ç‰ˆå¼é©±åŠ¨æå–æ–¹æ¡ˆè®ºè¯-20251021.md`
- **AGENTSå·¥ä½œæµ**: `AGENTS.md`

---

## ğŸ“ è¿›é˜¶ç”¨æ³•

### å•ç‹¬ä½¿ç”¨ç‰ˆå¼æå–

å¦‚æœåªéœ€è¦åˆ†ææ–‡æ¡£ç‰ˆå¼ï¼Œä¸æå–å›¾è¡¨ï¼š

```python
# Pythonè„šæœ¬è°ƒç”¨
from scripts.extract_pdf_assets import extract_text_with_format

layout_model = extract_text_with_format(
    pdf_path='your_paper.pdf',
    out_json='layout_model.json',
    sample_pages=None,  # åˆ†æå…¨éƒ¨é¡µé¢
    debug=True          # æ‰“å°è¯¦ç»†ä¿¡æ¯
)

# è®¿é—®ç‰ˆå¼ä¿¡æ¯
print(f"Columns: {layout_model.num_columns}")
print(f"Typical font size: {layout_model.typical_font_size}pt")
print(f"Text blocks on page 0: {len(layout_model.text_blocks[0])}")
```

### è‡ªå®šä¹‰æ–‡æœ¬ç±»å‹åˆ†ç±»

å½“å‰æ–‡æœ¬ç±»å‹åˆ†ç±»åŸºäºè§„åˆ™ï¼Œå¦‚éœ€è‡ªå®šä¹‰ï¼š

```python
# ç¼–è¾‘ scripts/extract_pdf_assets.py

def _classify_text_types(...):
    # ä¿®æ”¹åˆ†ç±»è§„åˆ™
    if unit.font_weight == 'bold':
        ratio = unit.font_size / typical_font_size
        if ratio > 1.5:  # è‡ªå®šä¹‰é˜ˆå€¼
            unit.text_type = 'title_h1'
    ...
```

---

## âœ… æ€»ç»“

ç‰ˆå¼é©±åŠ¨æå–ï¼ˆV2ï¼‰æ˜¯ç°æœ‰å›¾è¡¨æå–ç³»ç»Ÿçš„å¼ºå¤§å¢å¼ºï¼š

1. **å…ˆå»ºæ¨¡ï¼Œå†æå–** - æ›´æ™ºèƒ½çš„å¤„ç†æµç¨‹
2. **å¯è§†åŒ–æ–‡æœ¬åŒºå—** - æ›´ç›´è§‚çš„è°ƒè¯•ä½“éªŒ
3. **å‘åå…¼å®¹** - ä¸å½±å“ç°æœ‰åŠŸèƒ½
4. **ç”¨æˆ·å¯é€‰** - é€šè¿‡`--layout-driven`å¯ç”¨

**ç«‹å³å°è¯•**:
```bash
python3 scripts/extract_pdf_assets.py \
  --pdf your_paper.pdf \
  --preset robust \
  --layout-driven \
  --debug-visual
```

---

**å¿«é€Ÿå…¥é—¨å®Œæˆ** âœ…  
å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå®Œæ•´æŠ€æœ¯æ–‡æ¡£æˆ–æissueã€‚

